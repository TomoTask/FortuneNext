<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ ã‚«ãƒ„</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å‡ºè³‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v3.0 â€” Production Design
   Reviewed by: Frontend / Fullstack / Backend Team
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Foundation â”€â”€ */

:root {
  /* Primary Palette */
  --blue-900: #0C1D3F;
  --blue-800: #132D5E;
  --blue-700: #1A3F80;
  --blue-600: #2258AB;
  --blue-500: #2B6CB0;
  --blue-400: #4A90D9;
  --blue-100: #DBEAFE;
  --blue-50:  #EFF6FF;

  /* Semantic */
  --green-700: #15803D;
  --green-500: #22C55E;
  --green-100: #DCFCE7;
  --green-50:  #F0FDF4;
  --red-700:   #B91C1C;
  --red-500:   #EF4444;
  --red-100:   #FEE2E2;
  --red-50:    #FEF2F2;
  --amber-700: #B45309;
  --amber-500: #F59E0B;
  --amber-100: #FEF3C7;
  --amber-50:  #FFFBEB;
  --purple-700:#6D28D9;
  --purple-100:#EDE9FE;
  --teal-500:  #14B8A6;
  --teal-50:   #F0FDFA;

  /* Neutral */
  --gray-900: #111827;
  --gray-800: #1F2937;
  --gray-700: #374151;
  --gray-600: #4B5563;
  --gray-500: #6B7280;
  --gray-400: #9CA3AF;
  --gray-300: #D1D5DB;
  --gray-200: #E5E7EB;
  --gray-100: #F3F4F6;
  --gray-50:  #F9FAFB;
  --white:    #FFFFFF;

  /* Design Tokens */
  --radius-xl: 16px;
  --radius-lg: 12px;
  --radius-md: 8px;
  --radius-sm: 6px;
  --shadow-xs: 0 1px 2px rgba(0,0,0,.05);
  --shadow-sm: 0 1px 3px rgba(0,0,0,.07), 0 1px 2px rgba(0,0,0,.04);
  --shadow-md: 0 4px 6px rgba(0,0,0,.06), 0 2px 4px rgba(0,0,0,.04);
  --shadow-lg: 0 10px 15px rgba(0,0,0,.08), 0 4px 6px rgba(0,0,0,.04);
  --shadow-focus: 0 0 0 3px rgba(43,108,176,.2);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
  --transition: 150ms ease;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { -webkit-text-size-adjust: 100%; }

body {
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.7;
  color: var(--gray-800);
  background: var(--gray-100);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  min-height: 100dvh;
  overflow-x: hidden;
}

/* â”€â”€ Utility Classes â”€â”€ */
.text-xs   { font-size: 11px; line-height: 1.5; }
.text-sm   { font-size: 12px; line-height: 1.5; }
.text-base { font-size: 14px; }
.text-lg   { font-size: 16px; }
.text-xl   { font-size: 20px; }
.text-2xl  { font-size: 24px; }
.text-3xl  { font-size: 30px; }
.font-medium { font-weight: 500; }
.font-bold { font-weight: 700; }
.text-center { text-align: center; }
.text-right { text-align: right; }
.text-gray { color: var(--gray-500); }
.text-green { color: var(--green-700); }
.text-red  { color: var(--red-700); }
.text-gold { color: var(--amber-700); }
.text-blue { color: var(--blue-600); }
.text-primary { color: var(--blue-600); }
.mt-05 { margin-top: 6px; }
.mt-1  { margin-top: 12px; }
.mt-2  { margin-top: 24px; }
.mt-3  { margin-top: 32px; }
.mb-05 { margin-bottom: 6px; }
.mb-1  { margin-bottom: 12px; }
.ml-05 { margin-left: 8px; }
.flex-between { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
.flex-center  { display: flex; justify-content: center; align-items: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#app {
  max-width: 520px;
  margin: 0 auto;
  min-height: 100dvh;
  background: var(--gray-100);
}

.app-layout {
  display: flex;
  flex-direction: column;
  min-height: 100dvh;
}

/* â”€â”€ Header â”€â”€ */
.app-header {
  background: linear-gradient(135deg, var(--blue-900) 0%, var(--blue-700) 100%);
  color: var(--white);
  padding: 14px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(12,29,63,.3);
}

.app-header__left {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}

.app-header__title {
  font-size: 15px;
  font-weight: 800;
  letter-spacing: .04em;
  white-space: nowrap;
}

.app-header__user {
  font-size: 11px;
  font-weight: 400;
  opacity: .75;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.app-header__logout {
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.15);
  color: white;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  font-size: 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background var(--transition);
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
}
.app-header__logout:hover { background: rgba(255,255,255,.22); }

/* â”€â”€ Navigation â”€â”€ */
.app-nav {
  display: flex;
  background: var(--white);
  border-bottom: 1px solid var(--gray-200);
  position: sticky;
  top: 52px;
  z-index: 99;
  overflow-x: auto;
  scrollbar-width: none;
  -webkit-overflow-scrolling: touch;
}
.app-nav::-webkit-scrollbar { display: none; }

.nav-tab {
  flex: 1 0 auto;
  min-width: 64px;
  padding: 8px 6px 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1px;
  background: none;
  border: none;
  border-bottom: 2.5px solid transparent;
  color: var(--gray-400);
  cursor: pointer;
  transition: all var(--transition);
  -webkit-tap-highlight-color: transparent;
  font-family: var(--font);
}
.nav-tab:hover { color: var(--gray-600); }
.nav-tab--active {
  color: var(--blue-600);
  border-bottom-color: var(--blue-600);
  background: var(--blue-50);
}
.nav-tab__icon { font-size: 17px; line-height: 1.2; }
.nav-tab__label { font-size: 10px; font-weight: 600; white-space: nowrap; }

/* â”€â”€ Main Content Area â”€â”€ */
.app-main {
  flex: 1;
  position: relative;
}

.page-content {
  padding: 20px 16px 40px;
}

/* â”€â”€ Global Loading â”€â”€ */
.global-loading {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,.55);
  backdrop-filter: blur(2px);
  z-index: 150;
  display: flex;
  align-items: center;
  justify-content: center;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--gray-200);
  border-top-color: var(--blue-600);
  border-radius: 50%;
  animation: spin .65s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.login-screen {
  min-height: 100dvh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px 16px;
  background: linear-gradient(155deg, #070E1B 0%, var(--blue-900) 40%, var(--blue-700) 100%);
  position: relative;
  overflow: hidden;
}
.login-screen::before {
  content: '';
  position: absolute;
  width: 500px;
  height: 500px;
  background: radial-gradient(circle, rgba(43,108,176,.15) 0%, transparent 70%);
  top: -100px;
  right: -150px;
  pointer-events: none;
}

.login-card {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: 40px 28px 36px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 25px 50px rgba(0,0,0,.25);
  position: relative;
}

.login-logo {
  text-align: center;
  font-size: 26px;
  font-weight: 800;
  color: var(--gray-900);
  letter-spacing: .02em;
  margin-bottom: 2px;
}
.login-subtitle {
  text-align: center;
  font-size: 11px;
  color: var(--gray-400);
  letter-spacing: .08em;
  text-transform: uppercase;
  margin-bottom: 32px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE ELEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.page-title {
  font-size: 18px;
  font-weight: 800;
  color: var(--gray-900);
  margin-bottom: 16px;
  letter-spacing: -.01em;
}

.section-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--gray-600);
  margin-bottom: 10px;
}

/* â”€â”€ Card â”€â”€ */
.card {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(0,0,0,.04);
}

/* â”€â”€ Confirm Row (key-value pair) â”€â”€ */
.confirm-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 7px 0;
  gap: 12px;
}
.confirm-row + .confirm-row { border-top: 1px solid var(--gray-50); }
.confirm-row__label {
  color: var(--gray-500);
  font-size: 12px;
  font-weight: 500;
  flex-shrink: 0;
  padding-top: 1px;
}
.confirm-row__value {
  font-size: 14px;
  font-weight: 600;
  text-align: right;
  word-break: break-all;
  color: var(--gray-800);
}

/* â”€â”€ Divider â”€â”€ */
.divider { height: 1px; background: var(--gray-200); margin: 10px 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 10px;
  border-radius: 100px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .02em;
  white-space: nowrap;
  line-height: 1.6;
}
.badge--green  { background: var(--green-100); color: var(--green-700); }
.badge--red    { background: var(--red-100); color: var(--red-700); }
.badge--gold   { background: var(--amber-100); color: var(--amber-700); }
.badge--blue   { background: var(--blue-100); color: var(--blue-600); }
.badge--purple { background: var(--purple-100); color: var(--purple-700); }
.badge--gray   { background: var(--gray-100); color: var(--gray-500); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 11px 20px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 700;
  font-family: var(--font);
  border: none;
  cursor: pointer;
  transition: all var(--transition);
  -webkit-tap-highlight-color: transparent;
  text-decoration: none;
  line-height: 1.4;
  white-space: nowrap;
}
.btn:active { transform: scale(.97); }
.btn:disabled { opacity: .35; pointer-events: none; }

.btn--primary {
  background: var(--blue-600);
  color: var(--white);
  box-shadow: 0 1px 3px rgba(34,88,171,.3);
}
.btn--primary:hover { background: var(--blue-700); }

.btn--outline {
  background: var(--white);
  color: var(--blue-600);
  border: 1.5px solid var(--blue-500);
}
.btn--outline:hover { background: var(--blue-50); }

.btn--ghost {
  background: transparent;
  color: var(--gray-500);
  padding: 8px 12px;
}
.btn--ghost:hover { background: var(--gray-50); color: var(--gray-700); }

.btn--danger { background: var(--red-500); color: var(--white); }

.btn--full { width: 100%; }
.btn--sm   { padding: 8px 14px; font-size: 12px; }
.btn--lg   { padding: 14px 24px; font-size: 15px; }

.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
.btn-group > .btn { flex: 1; min-width: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.form-group {
  margin-bottom: 18px;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: 6px;
  letter-spacing: .01em;
}

.form-hint {
  font-size: 11px;
  color: var(--gray-400);
  margin-top: 4px;
}

.input {
  display: block;
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: var(--font);
  font-weight: 500;
  background: var(--white);
  color: var(--gray-800);
  transition: border-color var(--transition), box-shadow var(--transition);
  -webkit-appearance: none;
  appearance: none;
  line-height: 1.5;
}
.input:focus {
  outline: none;
  border-color: var(--blue-500);
  box-shadow: var(--shadow-focus);
}
.input::placeholder { color: var(--gray-300); font-weight: 400; }

select.input {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

/* Amount Input */
.amount-input-wrap { position: relative; }
.amount-prefix {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 15px;
  font-weight: 700;
  color: var(--gray-400);
  pointer-events: none;
}
.input--amount {
  padding-left: 30px;
  font-size: 20px;
  font-weight: 800;
  letter-spacing: -.02em;
}

/* Range */
.range-slider {
  width: 100%;
  margin-top: 8px;
  accent-color: var(--blue-600);
  height: 6px;
}
.range-labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--gray-400);
  margin-top: 3px;
  font-weight: 500;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP INDICATOR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.step-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
  gap: 0;
}
.step-dot {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  background: var(--gray-200);
  color: var(--gray-400);
  transition: all .2s;
}
.step-dot--active {
  background: var(--blue-600);
  color: var(--white);
  box-shadow: 0 2px 8px rgba(43,108,176,.35);
}
.step-dot--done { background: var(--green-500); color: var(--white); }
.step-line { width: 28px; height: 2px; background: var(--gray-200); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAT CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 8px;
  margin-bottom: 16px;
}
.stat-card {
  background: var(--white);
  border-radius: var(--radius-md);
  padding: 12px 10px;
  box-shadow: var(--shadow-xs);
  text-align: center;
  border: 1px solid rgba(0,0,0,.03);
}
.stat-card__label { font-size: 10px; color: var(--gray-500); font-weight: 600; }
.stat-card__value { font-size: 20px; font-weight: 800; margin-top: 2px; letter-spacing: -.02em; }
.stat-card__sub   { font-size: 10px; color: var(--gray-400); margin-top: 2px; }
.stat-card--green  .stat-card__value { color: var(--green-700); }
.stat-card--red    .stat-card__value { color: var(--red-700); }
.stat-card--blue   .stat-card__value { color: var(--blue-600); }
.stat-card--purple .stat-card__value { color: var(--purple-700); }
.stat-card--gold   .stat-card__value { color: var(--amber-700); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRODUCT CARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.product-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 10px;
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(0,0,0,.04);
  cursor: pointer;
  transition: all var(--transition);
  -webkit-tap-highlight-color: transparent;
}
.product-card:hover { box-shadow: var(--shadow-md); }
.product-card:active { transform: scale(.99); }
.product-card--closed { opacity: .45; pointer-events: none; }
.product-card__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.product-card__name { font-size: 15px; font-weight: 700; }
.product-card__body { margin-bottom: 10px; }
.product-card__price { font-size: 22px; font-weight: 800; color: var(--blue-600); letter-spacing: -.02em; }
.product-card__unit { font-size: 12px; font-weight: 500; color: var(--gray-400); margin-left: 2px; }
.product-card__footer { display: flex; justify-content: space-between; font-size: 11px; color: var(--gray-400); font-weight: 500; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUANTITY SELECTOR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.qty-selector { display: flex; align-items: center; justify-content: center; gap: 6px; }
.qty-btn {
  width: 44px;
  height: 44px;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-md);
  background: var(--white);
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-600);
  -webkit-tap-highlight-color: transparent;
  transition: all var(--transition);
}
.qty-btn:active { background: var(--gray-50); transform: scale(.95); }
.qty-input {
  width: 72px;
  height: 44px;
  text-align: center;
  font-size: 20px;
  font-weight: 800;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-md);
  font-family: var(--font);
  color: var(--gray-800);
  -moz-appearance: textfield;
}
.qty-input::-webkit-inner-spin-button,
.qty-input::-webkit-outer-spin-button { -webkit-appearance: none; }
.qty-input:focus { outline: none; border-color: var(--blue-500); box-shadow: var(--shadow-focus); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BALANCE & PAYMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.balance-banner {
  background: linear-gradient(135deg, #064E3B 0%, #059669 100%);
  color: var(--white);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 14px;
  box-shadow: 0 2px 8px rgba(5,150,105,.2);
}
.balance-banner__amount { font-size: 26px; font-weight: 800; letter-spacing: -.02em; }
.balance-banner__label  { font-size: 11px; opacity: .75; margin-top: 2px; font-weight: 500; }

.balance-status { background: var(--gray-50); border-radius: var(--radius-md); padding: 14px; }
.balance-status__row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 13px; }
.balance-status__row--green { color: var(--green-700); }

.payment-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: var(--gray-100); }
.payment-bar__seg--green { background: var(--green-500); }
.payment-bar__seg--blue  { background: var(--blue-500); }

.payment-split { display: flex; gap: 8px; margin-top: 10px; }
.payment-split__item { flex: 1; text-align: center; padding: 10px 8px; border-radius: var(--radius-md); }
.payment-split__item--green { background: var(--green-50); color: var(--green-700); }
.payment-split__item--blue  { background: var(--blue-50); color: var(--blue-600); }
.payment-split__item--teal  { background: var(--teal-50); color: var(--teal-500); }

.balance-deduct {
  display: flex;
  justify-content: space-between;
  padding: 10px 14px;
  background: var(--green-50);
  border-radius: var(--radius-md);
  color: var(--green-700);
  font-size: 13px;
  font-weight: 600;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHOICE BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.choice-group { display: flex; flex-direction: column; gap: 10px; }
.choice-btn {
  display: block;
  width: 100%;
  text-align: left;
  padding: 16px 18px;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius-lg);
  background: var(--white);
  cursor: pointer;
  transition: all var(--transition);
  -webkit-tap-highlight-color: transparent;
  font-family: var(--font);
}
.choice-btn:hover { border-color: var(--blue-400); background: var(--blue-50); }
.choice-btn:active { transform: scale(.98); }
.choice-btn__title { font-size: 14px; font-weight: 700; color: var(--gray-800); }
.choice-btn__desc  { font-size: 11px; color: var(--gray-400); margin-top: 3px; font-weight: 400; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BANK INFO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.bank-info {
  background: var(--gray-50);
  border-radius: var(--radius-md);
  padding: 14px 16px;
}
.bank-info .confirm-row + .confirm-row { border-top-color: var(--gray-100); }

.profile-bank-empty {
  background: var(--amber-50);
  border: 1px dashed var(--amber-500);
  border-radius: var(--radius-lg);
  padding: 20px;
  text-align: center;
}
.profile-bank-empty__text {
  font-size: 13px;
  color: var(--amber-700);
  font-weight: 700;
  margin-bottom: 6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INFO / SUCCESS / WARNING BOXES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.info-box {
  background: var(--blue-50);
  border-left: 3px solid var(--blue-600);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  padding: 12px 14px;
  font-size: 12px;
  color: var(--blue-700);
}
.success-box {
  background: var(--green-50);
  border-left: 3px solid var(--green-500);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  padding: 12px 14px;
  font-size: 13px;
  color: var(--green-700);
  font-weight: 600;
}
.warning-box {
  background: var(--amber-50);
  border-left: 3px solid var(--amber-500);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  padding: 12px 14px;
  font-size: 12px;
  color: var(--amber-700);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REINVEST BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.reinvest-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: var(--gray-100); }
.reinvest-bar__return { background: var(--green-500); }
.reinvest-bar__keep   { background: var(--teal-500); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHEDULE GRID
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.schedule-hint { font-size: 12px; color: var(--gray-500); margin-bottom: 10px; font-weight: 500; }
.sch-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 14px; }
.sch-cell {
  border-radius: var(--radius-sm);
  padding: 8px 2px;
  text-align: center;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all var(--transition);
  -webkit-tap-highlight-color: transparent;
  background: var(--white);
}
.sch-cell__date { font-size: 13px; font-weight: 700; }
.sch-cell__sub  { font-size: 9px; color: var(--gray-400); font-weight: 500; }
.sch-cell__star { font-size: 11px; }
.sch-cell--off  { background: var(--gray-50); opacity: .35; cursor: default; }
.sch-cell--best { background: #FEF9C3; border-color: #FBBF24; }
.sch-cell--ok   { background: #FEF3C7; }
.sch-cell--few  { background: var(--white); border-color: var(--gray-200); }
.sch-cell--sel  { border-color: var(--blue-600) !important; background: var(--blue-50) !important; box-shadow: 0 0 0 2px rgba(43,108,176,.15); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORDER CARD (User)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.order-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 16px 18px;
  margin-bottom: 10px;
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(0,0,0,.04);
}
.order-card__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.order-card__name { font-size: 14px; font-weight: 700; }
.order-card__body { padding: 2px 0; }
.order-card__actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORDER ADMIN CARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.order-admin-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 14px 18px;
  margin-bottom: 8px;
  box-shadow: var(--shadow-xs);
  border: 1px solid rgba(0,0,0,.04);
  cursor: pointer;
  transition: all var(--transition);
}
.order-admin-card:hover { box-shadow: var(--shadow-md); }
.order-admin-card--action { border-left: 3px solid var(--amber-500); }
.order-admin-card__body { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 13px; }
.order-admin-card__footer { display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: var(--gray-400); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORDER PROGRESS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.order-progress { display: flex; align-items: center; justify-content: center; padding: 16px 0; margin-bottom: 12px; gap: 0; }
.order-progress__step { text-align: center; }
.order-progress__dot {
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--gray-200); color: var(--gray-400);
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700;
}
.order-progress__dot--done   { background: var(--green-500); color: var(--white); }
.order-progress__dot--active { background: var(--blue-600); color: var(--white); }
.order-progress__label { font-size: 9px; color: var(--gray-400); margin-top: 3px; font-weight: 500; }
.order-progress__line  { width: 36px; height: 2px; background: var(--gray-200); margin: 0 4px; }
.order-progress__line--done { background: var(--green-500); }
.order-progress__step--done .order-progress__label { color: var(--green-700); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.filter-tabs { display: flex; gap: 6px; margin-bottom: 14px; overflow-x: auto; scrollbar-width: none; padding-bottom: 2px; }
.filter-tabs::-webkit-scrollbar { display: none; }
.filter-tab {
  padding: 6px 14px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 600;
  font-family: var(--font);
  background: var(--white);
  color: var(--gray-500);
  border: 1.5px solid var(--gray-200);
  cursor: pointer;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  transition: all var(--transition);
}
.filter-tab:hover { border-color: var(--gray-300); }
.filter-tab--active { background: var(--blue-600); color: var(--white); border-color: var(--blue-600); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER / PRODUCT ADMIN CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.user-card, .product-admin-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 14px 18px;
  margin-bottom: 8px;
  box-shadow: var(--shadow-xs);
  border: 1px solid rgba(0,0,0,.04);
  cursor: pointer;
  transition: all var(--transition);
}
.user-card:hover, .product-admin-card:hover { box-shadow: var(--shadow-md); }
.user-card__meta { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; font-size: 11px; color: var(--gray-400); font-weight: 500; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECEIPT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.receipt-info { background: var(--gray-50); border-radius: var(--radius-md); padding: 4px; }
.receipt-link {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; background: var(--white); border-radius: var(--radius-md);
  text-decoration: none; color: var(--blue-600); font-weight: 700; font-size: 13px;
  transition: background var(--transition);
}
.receipt-link:hover { background: var(--blue-50); }
.receipt-link__icon { font-size: 18px; }
.receipt-link__text { flex: 1; }
.receipt-link__arrow { color: var(--gray-300); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS CARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.status-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(0,0,0,.04);
}
.status-card__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.status-section { padding: 10px 0; border-top: 1px solid var(--gray-100); }
.status-section__title { font-size: 12px; font-weight: 700; color: var(--gray-600); margin-bottom: 8px; }

.status-bar-wrap { display: flex; align-items: center; gap: 10px; }
.status-bar { flex: 1; height: 7px; background: var(--gray-100); border-radius: 4px; overflow: hidden; }
.status-bar__fill { height: 100%; background: var(--blue-500); border-radius: 4px; transition: width .3s; }
.status-bar__label { font-size: 11px; color: var(--gray-500); white-space: nowrap; font-weight: 600; }

.status-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.status-chip { font-size: 11px; padding: 3px 10px; border-radius: 100px; font-weight: 700; }
.status-chip--green { background: var(--green-100); color: var(--green-700); }
.status-chip--red   { background: var(--red-100); color: var(--red-700); }
.status-chip--gold  { background: var(--amber-100); color: var(--amber-700); }

.status-users { font-size: 12px; }
.status-user-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--gray-50); }
.status-user-row:last-child { border-bottom: none; }
.status-user-row span:first-child { flex: 1; font-weight: 500; }

.status-my-order { padding: 8px 0; border-bottom: 1px solid var(--gray-50); }
.status-my-order:last-child { border-bottom: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.table { width: 100%; border-collapse: collapse; font-size: 12px; }
.table th { background: var(--gray-50); font-weight: 600; font-size: 11px; color: var(--gray-500); padding: 8px 10px; text-align: left; white-space: nowrap; }
.table td { padding: 10px; border-bottom: 1px solid var(--gray-100); }
.table--compact td { padding: 6px 10px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.empty-state { text-align: center; padding: 48px 20px; }
.empty-state__icon { font-size: 36px; margin-bottom: 12px; }
.empty-state__text { color: var(--gray-400); font-size: 13px; font-weight: 500; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKELETON
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.skeleton { padding: 24px 20px; }
.skeleton__line {
  height: 12px;
  background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 6px;
  margin-bottom: 14px;
}
.skeleton__line:nth-child(2) { width: 70%; }
.skeleton__line:nth-child(3) { width: 55%; }
.skeleton__line:nth-child(4) { width: 80%; }
.skeleton__line:nth-child(5) { width: 45%; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.toast {
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%) translateY(-120%);
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
  font-family: var(--font);
  z-index: 999;
  transition: transform .3s cubic-bezier(.175,.885,.32,1.275);
  box-shadow: var(--shadow-lg);
  max-width: 90%;
  white-space: nowrap;
}
.toast--show { transform: translateX(-50%) translateY(0); }
.toast--success { background: #065F46; color: var(--white); }
.toast--error   { background: var(--red-500); color: var(--white); }
.toast--info    { background: var(--gray-700); color: var(--white); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(2px);
  z-index: 200;
  display: flex; align-items: center; justify-content: center;
  padding: 24px;
  opacity: 0;
  transition: opacity .2s;
}
.modal-overlay--show { opacity: 1; }
.modal {
  background: var(--white);
  border-radius: var(--radius-xl);
  padding: 28px 24px 24px;
  max-width: 340px;
  width: 100%;
  box-shadow: var(--shadow-lg);
}
.modal__body { font-size: 14px; line-height: 1.7; margin-bottom: 20px; color: var(--gray-700); }
.modal__actions { display: flex; gap: 10px; justify-content: flex-end; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN SETTINGS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.settings-bank-preview {
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid rgba(0,0,0,.04);
}
.settings-bank-preview__title {
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-500);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: .04em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICE INFO (Leader)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.price-info-grid { margin-top: 4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 380px) {
  .page-content { padding: 16px 12px 36px; }
  .card { padding: 16px 14px; }
  .stat-grid { grid-template-columns: repeat(2, 1fr); }
  .product-card__price { font-size: 20px; }
}

@media (min-width: 520px) {
  .page-content { padding: 24px 20px 48px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAFE AREA (iPhone notch)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@supports (padding: env(safe-area-inset-bottom)) {
  .app-main { padding-bottom: env(safe-area-inset-bottom); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN ERROR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.login-error {
  color: var(--red-500);
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 10px;
  display: none;
}

/* â”€â”€ ã‚µãƒ–ã‚¿ãƒ–ï¼ˆå–å¼•ç”»é¢ã®æ³¨æ–‡/ãŠæˆ»ã—åˆ‡æ›¿ï¼‰ â”€â”€ */
.sub-tabs { display: flex; gap: 0; margin-bottom: 16px; background: var(--gray-100); border-radius: 10px; padding: 3px; }
.sub-tab { flex: 1; padding: 10px 0; text-align: center; border: none; background: transparent; font-size: 14px; font-weight: 600; color: var(--gray-500); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
.sub-tab--active { background: #fff; color: var(--gray-900); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

</style>
</head>
<body>
<div id="app"></div>
<script>
// â”€â”€ config.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  è¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
  // â˜… GASãƒ‡ãƒ—ãƒ­ã‚¤URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ã“ã“ã‚’æ›¸ãæ›ãˆï¼‰
  API_URL: 'https://script.google.com/macros/s/AKfycbzD5_qptnAccJnW8XzEgGxbW_7Rz1BT9SpzovLpxMzXEIL9emSGgag-1fZXtxgMFxmx1A/exec',

  PAYMENT_DEADLINE_DAYS: 2,
  CACHE_TTL_MS: 5 * 60 * 1000,
};

// â”€â”€ api.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APIé€šä¿¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« v2.0ï¼ˆé«˜é€ŸåŒ–å¯¾å¿œï¼‰
//  - ãƒãƒƒãƒãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆ1å›ã®HTTPã§è¤‡æ•°APIï¼‰
//  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆé‡è¤‡æ’é™¤
//  - ã‚¹ãƒãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API = {
  _cache: new Map(),
  _inflight: new Map(),

  /** å˜ç™ºAPIå‘¼ã³å‡ºã—ï¼ˆé‡è¤‡æ’é™¤ä»˜ãï¼‰ */
  async call(action, params = {}) {
    const key = action + JSON.stringify(params);
    if (this._inflight.has(key)) return this._inflight.get(key);
    const promise = this._fetch(action, params).finally(() => this._inflight.delete(key));
    this._inflight.set(key, promise);
    return promise;
  },

  /** ãƒãƒƒãƒAPIï¼ˆè¤‡æ•°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’1å›ã®HTTPã§å®Ÿè¡Œï¼‰ */
  async batch(requests) {
    const token = Auth.getToken();
    const actions = requests.map(r => ({ key: r.key || r.action, action: r.action, params: r.params || {} }));
    try {
      App.setLoading(true);
      const res = await fetch(CONFIG.API_URL, {
        method: 'POST', redirect: 'follow',
        body: JSON.stringify({ action: 'batch', actions, token }),
        headers: { 'Content-Type': 'text/plain' },
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if (data.code === 'AUTH_REQUIRED') { Auth.clear(); App.showLogin(); return data; }
      return data;
    } catch (err) {
      console.error('Batch API Error:', err);
      return { _error: 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“' };
    } finally {
      App.setLoading(false);
    }
  },

  /** HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ */
  async _fetch(action, params) {
    const token = Auth.getToken();
    const body = { ...params, action, token };
    try {
      App.setLoading(true);
      const res = await fetch(CONFIG.API_URL, {
        method: 'POST', redirect: 'follow',
        body: JSON.stringify(body),
        headers: { 'Content-Type': 'text/plain' },
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if (data.code === 'AUTH_REQUIRED') { Auth.clear(); App.showLogin(); return data; }
      return data;
    } catch (err) {
      console.error('API Error:', err);
      return { success: false, error: 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' };
    } finally {
      App.setLoading(false);
    }
  },

  /** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãå‘¼ã³å‡ºã— */
  async cachedCall(action, params = {}) {
    const key = action + JSON.stringify(params);
    const cached = this._cache.get(key);
    if (cached && Date.now() - cached.time < CONFIG.CACHE_TTL_MS) return cached.data;
    const data = await this.call(action, params);
    this._cache.set(key, { data, time: Date.now() });
    return data;
  },

  clearCache() { this._cache.clear(); },

  // â”€â”€ ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ â”€â”€
  async login(loginId, password)     { return this.call('login', { loginId, password }); },
  async logout()                     { return this.call('logout'); },
  async getProducts()                { return this.cachedCall('getProducts'); },
  async getProduct(productId)        { return this.call('getProduct', { productId }); },
  async createProduct(data)          { this.clearCache(); return this.call('createProduct', data); },
  async updateProduct(data)          { this.clearCache(); return this.call('updateProduct', data); },
  async getGroupPrices(productId)    { return this.call('getGroupPrices', { productId }); },
  async updateGroupPrice(data)       { return this.call('updateGroupPrice', data); },
  async getOrders(filters = {})      { return this.call('getOrders', filters); },
  async createOrder(data)            { this.clearCache(); return this.call('createOrder', data); },
  async updateOrder(orderId, data)   { return this.call('updateOrder', { orderId, ...data }); },
  async getReturns(filters = {})     { return this.call('getReturns', filters); },
  async createReturn(data)           { this.clearCache(); return this.call('createReturn', data); },
  async updateReturn(returnId, data) { return this.call('updateReturn', { returnId, ...data }); },
  async getDashboard()               { return this.cachedCall('getDashboard'); },
  async getUsers()                   { return this.call('getUsers'); },
  async getGroups()                  { return this.cachedCall('getGroups'); },
  async getSchedule()                { return this.cachedCall('getSchedule'); },
  async updateProfile(data)          { this.clearCache(); return this.call('updateProfile', data); },
  async createUser(data)             { this.clearCache(); return this.call('createUser', data); },
  async updateUser(data)             { this.clearCache(); return this.call('updateUser', data); },
  async resetPassword(userId, pw)    { return this.call('resetPassword', { user_id: userId, new_password: pw }); },
  async deleteUser(userId)           { this.clearCache(); return this.call('deleteUser', { user_id: userId }); },
  async uploadReceipt(data)          { return this.call('uploadReceipt', data); },
  async getSettings()                { return this.cachedCall('getSettings'); },
  async saveSettings(settings)       { this.clearCache(); return this.call('saveSettings', { settings }); },
};

// â”€â”€ auth.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæœ¬ç•ªå¯¾å¿œï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const Auth = {
  currentUser: null,
  _token: null,

  init() {
    const saved = localStorage.getItem('auth_token');
    const user = localStorage.getItem('auth_user');
    if (saved && user) {
      this._token = saved;
      try { this.currentUser = JSON.parse(user); } catch (_) { this.clear(); }
    }
  },

  isLoggedIn() { return !!this._token && !!this.currentUser; },
  getToken()   { return this._token; },
  getRole()    { return this.currentUser?.role || ''; },
  getGroupId() { return this.currentUser?.group_id || ''; },
  getUserId()  { return this.currentUser?.user_id || ''; },
  getGroupName() { return this.currentUser?.group_name || ''; },

  setSession(token, user) {
    this._token = token;
    this.currentUser = user;
    localStorage.setItem('auth_token', token);
    localStorage.setItem('auth_user', JSON.stringify(user));
  },

  clear() {
    this._token = null;
    this.currentUser = null;
    localStorage.removeItem('auth_token');
    localStorage.removeItem('auth_user');
  },

  /** ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æœ€æ–°ã«æ›´æ–° */
  async refreshUser() {
    if (!this._token) return;
    const res = await API.call('me');
    if (res?.success && res.user) {
      this.currentUser = { ...this.currentUser, ...res.user };
      localStorage.setItem('auth_user', JSON.stringify(this.currentUser));
    }
  },
};

// â”€â”€ utils.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => [...document.querySelectorAll(sel)];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Fmt = {
  yen(n) {
    if (n === null || n === undefined || isNaN(n)) return 'Â¥0';
    return 'Â¥' + Math.floor(Number(n)).toLocaleString('ja-JP');
  },

  qty(n) { return Number(n).toLocaleString() + 'å€‹'; },

  pct(n) { return Number(n).toFixed(1) + '%'; },

  date(s, full = false) {
    if (!s) return '-';
    const d = new Date(s);
    if (isNaN(d)) return '-';
    return full
      ? `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`
      : `${d.getMonth() + 1}/${d.getDate()}`;
  },

  dateTime(s) {
    if (!s) return '-';
    const d = new Date(s);
    if (isNaN(d)) return '-';
    return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
  },

  orderStatus(s) {
    return { pending_payment: 'å…¥é‡‘å¾…ã¡', pending_receipt: 'æ˜ç´°ç¢ºèªä¸­', confirmed: 'ç¢ºå®š', cancelled: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' }[s] || s;
  },
  returnStatus(s) {
    return { unprocessed: 'æœªå‡¦ç†', applied: 'ç”³è«‹æ¸ˆ', remitted: 'é€é‡‘æ¸ˆ', handed: 'æ‰‹æ¸¡ã—æ¸ˆ' }[s] || s;
  },
  productStatus(s) {
    return { draft: 'ä¸‹æ›¸ã', active: 'è²©å£²ä¸­', closed: 'ç· åˆ‡', completed: 'å®Œäº†' }[s] || s;
  },
  statusColor(s) {
    return {
      pending_payment: 'red', pending_receipt: 'gold', confirmed: 'green', cancelled: 'gray',
      unprocessed: 'red', applied: 'gold', remitted: 'green', handed: 'green',
      active: 'green', closed: 'gray', draft: 'gold', completed: 'blue',
    }[s] || 'gray';
  },
};

// â”€â”€ components.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ v3.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const UI = {
  card(content, cls = '') {
    return `<div class="card ${cls}">${content}</div>`;
  },

  section(title, subtitle = '') {
    return `<h3 class="section-title">${title}</h3>${subtitle ? `<p class="text-sm text-gray">${subtitle}</p>` : ''}`;
  },

  badge(text, color = 'gray') {
    return `<span class="badge badge--${color}">${text}</span>`;
  },

  stat(label, value, sub = '', color = '') {
    return `<div class="stat-card ${color ? 'stat-card--' + color : ''}">
      <div class="stat-card__label">${label}</div>
      <div class="stat-card__value">${value}</div>
      ${sub ? `<div class="stat-card__sub">${sub}</div>` : ''}
    </div>`;
  },

  statGrid(items) {
    return `<div class="stat-grid">${items.join('')}</div>`;
  },

  empty(msg, icon = 'ğŸ“­') {
    return `<div class="empty-state"><div class="empty-state__icon">${icon}</div><div class="empty-state__text">${msg}</div></div>`;
  },

  skeleton(lines = 5) {
    return `<div class="skeleton">${Array(lines).fill('<div class="skeleton__line"></div>').join('')}</div>`;
  },

  table(headers, rows, opts = {}) {
    const ths = headers.map(h => typeof h === 'string' ? `<th>${h}</th>` : `<th class="${h.cls || ''}">${h.label}</th>`).join('');
    const trs = rows.map(r => `<tr>${r.map((c, i) => `<td class="${headers[i]?.cls || ''}">${c}</td>`).join('')}</tr>`).join('');
    return `<div class="table-wrap"><table class="table ${opts.compact ? 'table--compact' : ''}"><thead><tr>${ths}</tr></thead><tbody>${trs || `<tr><td colspan="${headers.length}" class="text-center text-gray">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`}</tbody></table></div>`;
  },

  steps(current, total) {
    return `<div class="step-indicator">${Array.from({ length: total }, (_, i) => {
      const n = i + 1;
      const cls = n < current ? 'step-dot--done' : n === current ? 'step-dot--active' : '';
      const label = n < current ? 'âœ“' : n;
      return (i > 0 ? '<span class="step-line"></span>' : '') + `<span class="step-dot ${cls}">${label}</span>`;
    }).join('')}</div>`;
  },

  confirmRow(label, value, cls = '') {
    return `<div class="confirm-row ${cls}"><span class="confirm-row__label">${label}</span><span class="confirm-row__value">${value}</span></div>`;
  },

  divider() { return '<div class="divider"></div>'; },

  toast(msg, type = 'success') {
    const icons = { success: 'âœ“', error: 'âœ•', info: 'â„¹', warning: 'âš ' };
    const el = document.createElement('div');
    el.className = `toast toast--${type}`;
    el.textContent = `${icons[type] || ''} ${msg}`;
    document.body.appendChild(el);
    requestAnimationFrame(() => el.classList.add('toast--show'));
    setTimeout(() => { el.classList.remove('toast--show'); setTimeout(() => el.remove(), 300); }, 2800);
  },

  confirm(msg, onOk, onCancel = null) {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal">
        <div class="modal__body">${msg}</div>
        <div class="modal__actions">
          <button class="btn btn--ghost modal__cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn--primary modal__ok">OK</button>
        </div>
      </div>`;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => overlay.classList.add('modal-overlay--show'));
    overlay.querySelector('.modal__ok').onclick = () => { overlay.remove(); onOk(); };
    overlay.querySelector('.modal__cancel').onclick = () => { overlay.remove(); onCancel?.(); };
    overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.remove(); onCancel?.(); } });
  },

  pageHeader(title, backFn = null) {
    return `${backFn ? `<button class="btn btn--ghost btn--sm mb-1" onclick="${backFn}">â† æˆ»ã‚‹</button>` : ''}<h2 class="page-title">${title}</h2>`;
  },
};

// â”€â”€ user.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ - å…¨ãƒ•ãƒ­ãƒ¼ v4.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const UserPages = {
  _state: {},
  _reset() {
    this._state = {
      selectedProduct: null,
      purchaseStep: 0, purchaseQty: 10, balanceUsed: 0,
      paymentMethod: 'transfer',
      iouRequested: false, iouAddress: '', iouName: '',
      returnStep: 0, returnOrder: null, returnAction: null,
      returnAmount: 0, returnMethod: null, returnDate: null,
      _editingBank: false,
    };
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TOPç”»é¢
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderTop() {
    const products = await API.getProducts();
    const user = Auth.currentUser;
    const balance = user?.reinvest_balance || 0;
    let html = '';
    if (balance > 0) {
      html += `<div class="balance-banner"><div class="balance-banner__amount">${Fmt.yen(balance)}</div><div class="balance-banner__label">é‹ç”¨ç¶™ç¶šä¸­ã®æ®‹é«˜</div></div>`;
    }
    const list = Array.isArray(products) ? products : [];
    const active = list.filter(p => p.status === 'active');
    const closed = list.filter(p => p.status !== 'active');
    if (active.length === 0 && closed.length === 0) html += UI.empty('è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“¦');
    active.forEach(p => { html += this._productCard(p, true); });
    if (closed.length > 0) {
      html += `<div class="text-xs text-gray mt-2 mb-05">éå»ã®å•†å“</div>`;
      closed.forEach(p => { html += this._productCard(p, false); });
    }
    return html;
  },

  _productCard(p, active) {
    const remaining = p.remaining_qty > 0 ? `æ®‹ã‚Š${p.remaining_qty}å€‹` : 'å®Œå£²';
    const isLinked = !!p.linked_product_id;
    return `<div class="product-card ${!active ? 'product-card--closed' : ''}" onclick="${active ? `UserPages.goDetail('${p.product_id}')` : ''}">
      <div class="product-card__header"><span class="product-card__name">${p.name}</span>${isLinked ? UI.badge('ğŸ”— ã‚»ãƒƒãƒˆ', 'blue') + ' ' : ''}${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}</div>
      <div class="product-card__body"><span class="product-card__price">${Fmt.yen(p.sell_price)}</span><span class="product-card__unit">/å€‹</span></div>
      <div class="product-card__footer"><span>${remaining}</span><span>ç· åˆ‡: ${Fmt.date(p.deadline, true)}</span></div>
    </div>`;
  },

  goDetail(pid) { this._reset(); this._state.selectedProduct = pid; App.currentPage = 'detail'; App.renderPage(); },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“è©³ç´°ï¼ˆæ•°é‡ãƒ«ãƒ¼ãƒ«ãƒ»ã‚»ãƒƒãƒˆå¯¾å¿œï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderDetail() {
    const pid = this._state.selectedProduct;
    if (!pid) return this.renderTop();
    const p = await API.getProduct(pid);
    if (!p || p.error) return UI.empty('å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    // ã‚»ãƒƒãƒˆå•†å“å–å¾—
    let lp = null;
    if (p.linked_product_id) {
      lp = await API.getProduct(p.linked_product_id);
      if (lp?.error) lp = null;
    }
    this._state._linkedProduct = lp;

    const maxQty = Math.min(p.remaining_qty, lp ? Math.min(lp.remaining_qty, 999) : 999);
    const qty = this._state.purchaseQty;
    const price = p.sell_price || 0;
    const lpPrice = lp ? (lp.sell_price || 0) : 0;
    const total = (price + lpPrice) * qty;
    this._state._cachedPrice = price;
    this._state._cachedLinkedPrice = lpPrice;
    const canPurchase = qty >= 10 && qty <= maxQty;
    const methodNote = qty >= 50 ? 'éŠ€è¡ŒæŒ¯è¾¼ ã¾ãŸã¯ ç¾é‡‘æ‰‹æ¸¡ã—' : qty >= 10 ? 'éŠ€è¡ŒæŒ¯è¾¼ã®ã¿' : '';

    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('top')">â† æˆ»ã‚‹</button>
      ${lp ? `<div class="info-box mb-1"><div class="text-sm font-bold">ğŸ”— ã‚»ãƒƒãƒˆå•†å“ï¼ˆ1:1è³¼å…¥æ¡ä»¶ï¼‰</div><div class="text-xs mt-05">ã“ã®å•†å“ã¯ ${lp.name} ã¨ã®åŒæ•°ã‚»ãƒƒãƒˆè³¼å…¥ãŒå¿…è¦ã§ã™</div></div>` : ''}
      ${UI.card(`
        <h2 class="text-lg font-bold">${p.name}</h2>
        <div class="mt-1">
          ${UI.confirmRow('è²©å£²ä¾¡æ ¼', Fmt.yen(price))}
          ${UI.confirmRow('æ®‹ã‚Šåœ¨åº«', Fmt.qty(p.remaining_qty))}
          ${UI.confirmRow('ç· åˆ‡', Fmt.date(p.deadline, true))}
        </div>
      `)}
      ${lp ? UI.card(`
        <h2 class="text-lg font-bold">${lp.name}</h2>
        <div class="mt-1">
          ${UI.confirmRow('è²©å£²ä¾¡æ ¼', Fmt.yen(lpPrice))}
          ${UI.confirmRow('æ®‹ã‚Šåœ¨åº«', Fmt.qty(lp.remaining_qty))}
        </div>
      `) : ''}
      ${maxQty >= 10 ? UI.card(`
        <h3 class="section-title">${lp ? 'ã‚»ãƒƒãƒˆè³¼å…¥æ•°é‡ï¼ˆå„å•†å“ã®æ•°é‡ï¼‰' : 'è³¼å…¥æ•°é‡'}</h3>
        <div class="qty-selector">
          <button class="qty-btn" onclick="UserPages._setQty(${qty} - 1)">âˆ’</button>
          <input type="number" class="qty-input" value="${qty}" min="10" max="${maxQty}" onchange="UserPages._setQty(Number(this.value))">
          <button class="qty-btn" onclick="UserPages._setQty(${qty} + 1)">+</button>
        </div>
        <div class="text-center mt-1">
          <div class="text-2xl font-bold qty-total-value">${Fmt.yen(total)}</div>
          ${lp ? `<div class="text-xs text-gray qty-total-sub">${p.name}: ${Fmt.yen(price)} Ã— ${qty} + ${lp.name}: ${Fmt.yen(lpPrice)} Ã— ${qty}</div>` : `<div class="text-xs text-gray qty-total-sub">${Fmt.yen(price)} Ã— ${qty}å€‹</div>`}
        </div>
        ${lp ? `
          <div class="info-box mt-1">
            <div class="text-xs font-bold mb-05">ğŸ“Š ã‚»ãƒƒãƒˆåˆ©ç›Šç‡</div>
            <div class="text-xs">${p.name}: ${Fmt.yen(price)} (åˆ©ç›Šç‡${p.profit_rate || '-'}%)</div>
            <div class="text-xs">${lp.name}: ${Fmt.yen(lpPrice)} (åˆ©ç›Šç‡${lp.profit_rate || '-'}%)</div>
            <div class="text-xs font-bold mt-05">å¹³å‡åˆ©ç›Šç‡: ç´„${p.profit_rate && lp.profit_rate ? ((p.profit_rate + lp.profit_rate) / 2).toFixed(1) : '-'}%</div>
          </div>
        ` : ''}
        <div class="info-box mt-1">
          <div class="text-xs font-bold mb-05">ğŸ“‹ è³¼å…¥ãƒ«ãƒ¼ãƒ«</div>
          <div class="text-xs">ãƒ»10å€‹ä»¥ä¸Šï¼šéŠ€è¡ŒæŒ¯è¾¼ã§è³¼å…¥å¯</div>
          <div class="text-xs">ãƒ»50å€‹ä»¥ä¸Šï¼šéŠ€è¡ŒæŒ¯è¾¼ or ç¾é‡‘æ‰‹æ¸¡ã—ã§è³¼å…¥å¯</div>
          <div class="text-xs">ãƒ»10å€‹æœªæº€ã¯è³¼å…¥ä¸å¯</div>
        </div>
        ${qty < 10 ? '<div class="warning-box mt-1">âš ï¸ æœ€ä½10å€‹ä»¥ä¸Šã‹ã‚‰è³¼å…¥ã§ãã¾ã™</div>' : ''}
        ${methodNote && qty >= 10 ? `<div class="text-xs text-gray text-center mt-05">ãŠæ”¯æ‰•ã„æ–¹æ³•: ${methodNote}</div>` : ''}
        <button class="btn btn--primary btn--full mt-1" ${!canPurchase ? 'disabled' : ''} onclick="UserPages._startPurchase()">è³¼å…¥æ‰‹ç¶šãã¸ â†’</button>
      `) : UI.card(`<div class="text-center text-gray">ã“ã®å•†å“ã¯åœ¨åº«ä¸è¶³ã§ã™ï¼ˆæœ€ä½10å€‹å¿…è¦ï¼‰</div>`)}`;
  },

  _setQty(n) {
    this._state.purchaseQty = Math.max(1, Math.min(n, 999));
    const el = document.querySelector('.qty-input');
    const tv = document.querySelector('.qty-total-value');
    const ts = document.querySelector('.qty-total-sub');
    if (el) el.value = this._state.purchaseQty;
    const p1 = this._state._cachedPrice || 0;
    const p2 = this._state._cachedLinkedPrice || 0;
    const t = (p1 + p2) * this._state.purchaseQty;
    if (tv) tv.textContent = Fmt.yen(t);
    // sub label is complex with linked, just update total
  },

  _startPurchase() {
    const qty = this._state.purchaseQty;
    if (qty < 10) { UI.toast('10å€‹ä»¥ä¸Šã‹ã‚‰è³¼å…¥ã§ãã¾ã™', 'error'); return; }
    if (qty < 50) this._state.paymentMethod = 'transfer';
    const balance = Auth.currentUser?.reinvest_balance || 0;
    if (balance > 0) this._state.purchaseStep = 1;
    else if (qty >= 50) this._state.purchaseStep = 1.5;
    else this._state.purchaseStep = 2;
    this._state.balanceUsed = 0;
    App.currentPage = 'purchase'; App.renderPage();
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  è³¼å…¥ãƒ•ãƒ­ãƒ¼
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderPurchase() {
    const step = this._state.purchaseStep;
    const p = await API.getProduct(this._state.selectedProduct);
    if (!p) return UI.empty('å•†å“æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼');
    const qty = this._state.purchaseQty;
    const lp = this._state._linkedProduct;
    const lpPrice = lp ? (lp.sell_price || 0) : 0;
    const total = (p.sell_price || 0) * qty;
    const grandTotal = total + lpPrice * qty;
    const balance = Auth.currentUser?.reinvest_balance || 0;
    if (step === 1) return this._purchaseBalance(p, grandTotal, balance);
    if (step === 1.5) return this._purchaseMethod(p, grandTotal);
    if (step === 2) return this._purchaseConfirm(p, total, balance);
    if (step === 3) return this._purchaseDone(p, grandTotal);
    return this.renderDetail();
  },

  // Step1: æ®‹é«˜å……å½“
  _purchaseBalance(p, total, balance) {
    const used = this._state.balanceUsed;
    const maxUse = Math.min(balance, total);
    const transfer = total - used;
    const bPct = total > 0 ? Math.round(used / total * 100) : 0;
    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.currentPage='detail';App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(1, 4)}
      ${UI.card(`
        <h3 class="section-title">æ®‹é«˜ã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿ</h3>
        <div class="balance-status">
          <div class="balance-status__row"><span>è³¼å…¥é‡‘é¡</span><span class="font-bold">${Fmt.yen(total)}</span></div>
          <div class="balance-status__row balance-status__row--green"><span>åˆ©ç”¨å¯èƒ½æ®‹é«˜</span><span class="font-bold">${Fmt.yen(balance)}</span></div>
        </div>
        <div class="form-group mt-1">
          <label class="form-label">å……å½“ã™ã‚‹é‡‘é¡</label>
          <div class="amount-input-wrap"><span class="amount-prefix">Â¥</span><input type="number" class="input input--amount" value="${used}" min="0" max="${maxUse}" step="1000" onchange="UserPages._setBalance(Number(this.value))"></div>
          <input type="range" class="range-slider" min="0" max="${maxUse}" step="1000" value="${used}" oninput="UserPages._setBalance(Number(this.value))">
          <div class="range-labels"><span>Â¥0</span><span>${Fmt.yen(maxUse)}</span></div>
          <button class="btn btn--outline btn--sm mt-05" onclick="UserPages._setBalance(${maxUse})">æ®‹é«˜ã‚’å…¨é¡ä½¿ã†</button>
        </div>
        ${used > 0 ? `<div class="payment-bar mt-1"><div class="payment-bar__seg payment-bar__seg--green" style="width:${bPct}%"></div><div class="payment-bar__seg payment-bar__seg--blue" style="width:${100 - bPct}%"></div></div>
        <div class="payment-split"><div class="payment-split__item payment-split__item--green"><div class="text-xs">æ®‹é«˜å……å½“</div><div class="font-bold">${Fmt.yen(used)}</div></div><div class="payment-split__item payment-split__item--blue"><div class="text-xs">è¿½åŠ æ”¯æ‰•ã„</div><div class="font-bold">${Fmt.yen(transfer)}</div></div></div>` : ''}
        <div class="btn-group mt-1">
          <button class="btn btn--primary btn--full" onclick="UserPages._afterBalance()">æ¬¡ã¸ â†’</button>
          <button class="btn btn--ghost btn--full" onclick="UserPages._state.balanceUsed=0;UserPages._afterBalance()">æ®‹é«˜ã‚’ä½¿ã‚ãšã«è³¼å…¥</button>
        </div>
      `)}`;
  },

  _setBalance(n) { this._state.balanceUsed = Math.max(0, Math.min(n, Auth.currentUser?.reinvest_balance || 0)); App.renderPage({ soft: true }); },

  _afterBalance() {
    const qty = this._state.purchaseQty;
    if (qty >= 50) this._state.purchaseStep = 1.5;
    else { this._state.paymentMethod = 'transfer'; this._state.purchaseStep = 2; }
    App.renderPage();
  },

  // Step1.5: æ”¯æ‰•æ–¹æ³•é¸æŠï¼ˆ50å€‹ä»¥ä¸Šï¼‰
  _purchaseMethod(p, total) {
    const balance = Auth.currentUser?.reinvest_balance || 0;
    const prevStep = balance > 0 ? 1 : 0;
    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="${prevStep ? 'UserPages._state.purchaseStep=1;App.renderPage()' : "App.currentPage='detail';App.renderPage()"}">â† æˆ»ã‚‹</button>
      ${UI.steps(2, 4)}
      ${UI.card(`
        <h3 class="section-title">ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
        <div class="text-sm text-gray mb-1">${this._state.purchaseQty}å€‹ã®ã”æ³¨æ–‡ï¼ˆ${Fmt.yen(total)}ï¼‰</div>
        <div class="choice-group">
          <button class="choice-btn" onclick="UserPages._state.paymentMethod='transfer';UserPages._state.purchaseStep=2;App.renderPage()">
            <div class="choice-btn__title">ğŸ¦ éŠ€è¡ŒæŒ¯è¾¼</div>
            <div class="choice-btn__desc">å£åº§ã«æŒ¯ã‚Šè¾¼ã‚“ã§ãŠæ”¯æ‰•ã„ï¼ˆå€Ÿç”¨æ›¸ã®ç™ºè¡ŒãŒå¯èƒ½ï¼‰</div>
          </button>
          <button class="choice-btn" onclick="UserPages._state.paymentMethod='cash';UserPages._state.iouRequested=false;UserPages._state.purchaseStep=2;App.renderPage()">
            <div class="choice-btn__title">ğŸ’µ ç¾é‡‘æ‰‹æ¸¡ã—</div>
            <div class="choice-btn__desc">å¯¾é¢ã§ç¾é‡‘ã‚’ãŠæ¸¡ã—ã—ã¾ã™</div>
          </button>
        </div>
      `)}`;
  },

  // Step2: æœ€çµ‚ç¢ºèªï¼ˆ+å€Ÿç”¨æ›¸ï¼‰
  async _purchaseConfirm(p, total, balance) {
    const lp = this._state._linkedProduct;
    const lpPrice = lp ? (lp.sell_price || 0) : 0;
    const grandTotal = lp ? total + lpPrice * this._state.purchaseQty : total;
    const used = this._state.balanceUsed;
    const transfer = grandTotal - used;
    const qty = this._state.purchaseQty;
    const method = this._state.paymentMethod;
    const isTransfer = method === 'transfer';
    const iou = this._state.iouRequested;
    let backStep = qty >= 50 ? 1.5 : (balance > 0 ? 1 : 0);
    let bank = {};
    if (isTransfer) { const s = await API.getSettings(); bank = (typeof s === 'object' && !s.error) ? s : {}; }
    const hasBankInfo = bank.bank_name && bank.bank_number;

    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="${backStep ? `UserPages._state.purchaseStep=${backStep};App.renderPage()` : "App.currentPage='detail';App.renderPage()"}">â† æˆ»ã‚‹</button>
      ${UI.steps(3, 4)}
      ${UI.card(`
        <h3 class="section-title">æ³¨æ–‡å†…å®¹ã®ç¢ºèª</h3>
        ${UI.confirmRow('å•†å“â‘ ', p.name)}
        ${UI.confirmRow('å˜ä¾¡', Fmt.yen(p.sell_price))}
        ${lp ? `
          ${UI.confirmRow('å•†å“â‘¡', lp.name)}
          ${UI.confirmRow('å˜ä¾¡', Fmt.yen(lpPrice))}
          <div class="text-xs text-blue mt-05 mb-05">ğŸ”— ã‚»ãƒƒãƒˆè³¼å…¥ï¼ˆ1:1ï¼‰</div>
        ` : ''}
        ${UI.confirmRow('æ•°é‡', Fmt.qty(qty) + (lp ? 'ï¼ˆå„å•†å“ï¼‰' : ''))}
        ${UI.divider()}
        ${lp ? `
          ${UI.confirmRow(p.name, Fmt.yen(p.sell_price * qty))}
          ${UI.confirmRow(lp.name, Fmt.yen(lpPrice * qty))}
        ` : ''}
        ${UI.confirmRow('åˆè¨ˆé‡‘é¡', Fmt.yen(grandTotal), 'font-bold')}
        ${used > 0 ? `${UI.confirmRow('ğŸ’° æ®‹é«˜å……å½“', 'âˆ’ ' + Fmt.yen(used), 'text-green')}${UI.confirmRow(isTransfer ? 'ğŸ¦ æŒ¯è¾¼é¡' : 'ğŸ’µ æ‰‹æ¸¡ã—é¡', Fmt.yen(transfer), 'font-bold text-lg')}<div class="text-xs text-gray mt-05">å……å½“å¾Œã®æ®‹é«˜: ${Fmt.yen(balance - used)}</div>` : ''}
        ${UI.confirmRow('æ”¯æ‰•æ–¹æ³•', isTransfer ? 'éŠ€è¡ŒæŒ¯è¾¼' : 'ç¾é‡‘æ‰‹æ¸¡ã—')}
        ${isTransfer && transfer > 0 ? `
          <div class="info-box mt-1"><div class="text-sm font-bold mb-05">ãŠæ”¯æ‰•ã„æ‰‹é †</div><div class="text-xs">â‘  äºˆç´„ç¢ºå®š â†’ â‘¡ éŠ€è¡ŒæŒ¯è¾¼ï¼ˆ${Fmt.yen(transfer)}ï¼‰â†’ â‘¢ æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ â‘£ ç¢ºèª</div></div>
          ${hasBankInfo ? `<div class="bank-info mt-1"><div class="text-xs font-bold text-gray mb-05">æŒ¯è¾¼å…ˆå£åº§</div>${UI.confirmRow('éŠ€è¡Œ', bank.bank_name)}${bank.bank_branch ? UI.confirmRow('æ”¯åº—', bank.bank_branch) : ''}${UI.confirmRow('å£åº§', (bank.bank_type || 'æ™®é€š') + ' ' + bank.bank_number)}${bank.bank_holder ? UI.confirmRow('åç¾©', bank.bank_holder) : ''}</div>` : ''}
        ` : ''}
        ${!isTransfer ? '<div class="info-box mt-1"><div class="text-xs">ç¾é‡‘æ‰‹æ¸¡ã—ã®å ´åˆã€ç®¡ç†è€…ã¨ç›´æ¥ã‚„ã‚Šå–ã‚Šã—ã¦ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚</div></div>' : ''}
        ${transfer === 0 ? '<div class="success-box mt-1">âœ… æ®‹é«˜ã®ã¿ã§è³¼å…¥å®Œäº† â€” è¿½åŠ æ”¯æ‰•ã„ã¯ä¸è¦ã§ã™</div>' : ''}
      `)}
      ${isTransfer ? UI.card(`
        <h3 class="section-title">ğŸ“„ å€Ÿç”¨æ›¸ã«ã¤ã„ã¦</h3>
        <div class="text-sm text-gray mb-1">éŠ€è¡ŒæŒ¯è¾¼ã§ã®ã”è³¼å…¥ã®å ´åˆã€å€Ÿç”¨æ›¸ã‚’ç™ºè¡Œã§ãã¾ã™</div>
        <label style="display:flex;align-items:center;gap:10px;padding:12px 0;cursor:pointer;-webkit-tap-highlight-color:transparent">
          <input type="checkbox" id="iou-check" ${iou ? 'checked' : ''} onchange="UserPages._state.iouRequested=this.checked;App.renderPage({soft:true})" style="width:20px;height:20px;accent-color:var(--blue-600)">
          <span class="text-sm font-bold">å€Ÿç”¨æ›¸ã®ç™ºè¡Œã‚’å¸Œæœ›ã™ã‚‹</span>
        </label>
        ${iou ? `
          <div class="form-group"><label class="form-label">å®›åï¼ˆå€Ÿä¸»åï¼‰<span class="text-red">*</span></label><input type="text" class="input" id="iou-name" value="${this._state.iouName}" placeholder="ä¾‹: å±±ç”° å¤ªéƒ" onchange="UserPages._state.iouName=this.value"></div>
          <div class="form-group"><label class="form-label">ä½æ‰€ <span class="text-red">*</span></label><input type="text" class="input" id="iou-addr" value="${this._state.iouAddress}" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒº..." onchange="UserPages._state.iouAddress=this.value"></div>
        ` : ''}
      `) : ''}
      ${UI.card(`<button class="btn btn--primary btn--full btn--lg" onclick="UserPages._confirmPurchase()">
        ${transfer > 0 ? (isTransfer ? `äºˆç´„ã‚’ç¢ºå®šã™ã‚‹ï¼ˆæŒ¯è¾¼é¡: ${Fmt.yen(transfer)}ï¼‰` : `äºˆç´„ã‚’ç¢ºå®šã™ã‚‹ï¼ˆæ‰‹æ¸¡ã—: ${Fmt.yen(transfer)}ï¼‰`) : 'è³¼å…¥ã‚’ç¢ºå®šã™ã‚‹ï¼ˆæ®‹é«˜æ‰•ã„ï¼‰'}
      </button>`)}`;
  },

  async _confirmPurchase() {
    const isTransfer = this._state.paymentMethod === 'transfer';
    const iou = this._state.iouRequested && isTransfer;
    if (iou) {
      const name = $('#iou-name')?.value?.trim() || this._state.iouName;
      const addr = $('#iou-addr')?.value?.trim() || this._state.iouAddress;
      if (!name) { UI.toast('å€Ÿç”¨æ›¸ã®å®›åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
      if (!addr) { UI.toast('å€Ÿç”¨æ›¸ã®ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
      this._state.iouName = name; this._state.iouAddress = addr;
    }
    const res = await API.createOrder({
      productId: this._state.selectedProduct, qty: this._state.purchaseQty, balanceUsed: this._state.balanceUsed,
      payment_method: this._state.paymentMethod,
      iou_requested: iou ? 'yes' : 'no', iou_name: iou ? this._state.iouName : '', iou_address: iou ? this._state.iouAddress : '',
    });
    if (res?.success) {
      this._state.purchaseStep = 3; this._state._lastOrder = res.order;
      if (this._state.balanceUsed > 0) { Auth.currentUser.reinvest_balance = Math.max(0, (Auth.currentUser.reinvest_balance || 0) - this._state.balanceUsed); localStorage.setItem('auth_user', JSON.stringify(Auth.currentUser)); }
      App.renderPage();
    } else { UI.toast(res?.error || 'æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
  },

  // Step3: å®Œäº†
  async _purchaseDone(p, total) {
    const order = this._state._lastOrder;
    if (!order) return UI.empty('æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    const transfer = order.transfer_amount || 0;
    const balUsed = order.balance_used || 0;
    const isTransfer = (order.payment_method || 'transfer') === 'transfer';
    let bank = {};
    if (isTransfer) { const s = await API.getSettings(); bank = (typeof s === 'object' && !s.error) ? s : {}; }
    let html = `${UI.steps(4, 4)}`;
    html += UI.card(`<div class="text-center"><div class="text-3xl mb-05">${transfer > 0 ? 'ğŸ“‹' : 'âœ…'}</div><h2 class="text-lg font-bold">${transfer > 0 ? 'äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ' : 'è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸ'}</h2></div>${balUsed > 0 ? `<div class="balance-deduct mt-1"><span>æ®‹é«˜ã‹ã‚‰å……å½“</span><span class="font-bold">âˆ’${Fmt.yen(balUsed)}</span></div>` : ''}`);
    if (transfer > 0 && isTransfer) {
      const hasBankInfo = bank.bank_name && bank.bank_number;
      html += UI.card(`<h3 class="section-title">ğŸ¦ æŒ¯è¾¼å…ˆï¼ˆç®¡ç†è€…å£åº§ï¼‰</h3>${hasBankInfo ? `<div class="bank-info">${UI.confirmRow('æŒ¯è¾¼é¡', Fmt.yen(transfer), 'font-bold text-lg')}${UI.confirmRow('éŠ€è¡Œ', bank.bank_name)}${bank.bank_branch ? UI.confirmRow('æ”¯åº—', bank.bank_branch) : ''}${UI.confirmRow('ç¨®é¡', bank.bank_type || 'æ™®é€š')}${UI.confirmRow('å£åº§ç•ªå·', bank.bank_number)}${bank.bank_holder ? UI.confirmRow('åç¾©', bank.bank_holder) : ''}</div>` : '<div class="warning-box">æŒ¯è¾¼å…ˆå£åº§æƒ…å ±ãŒæœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</div>'}<div class="info-box mt-1"><div class="text-xs">æŒ¯è¾¼å¾Œã€ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰æ˜ç´°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</div></div>`);
    } else if (transfer > 0) {
      html += UI.card(`<h3 class="section-title">ğŸ’µ ç¾é‡‘æ‰‹æ¸¡ã—</h3><div class="info-box"><div class="text-sm font-bold">${Fmt.yen(transfer)}ã‚’ç®¡ç†è€…ã«ãŠæ¸¡ã—ãã ã•ã„</div><div class="text-xs mt-05">ç®¡ç†è€…ã¨ç›´æ¥ã‚„ã‚Šå–ã‚Šã®ä¸Šã€ãŠæ”¯æ‰•ã„ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</div></div>`);
    }
    if (order.iou_requested === 'yes') html += UI.card('<div class="success-box">ğŸ“„ å€Ÿç”¨æ›¸ã‚’å¸Œæœ›ã•ã‚Œã¦ã„ã¾ã™ã€‚æ±ºæ¸ˆç¢ºå®šå¾Œã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</div>');
    html += `<button class="btn btn--primary btn--full mt-1" onclick="App.navigate('top')">TOPã«æˆ»ã‚‹</button>`;
    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãŠæˆ»ã—ãƒ•ãƒ­ãƒ¼
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  goReturn(orderId) { this._reset(); this._state.returnOrder = orderId; this._state.returnStep = 1; App.currentPage = 'return'; App.renderPage(); },

  async renderReturn() {
    const step = this._state.returnStep;
    if (step === 1) return this._retStep1();
    if (step === 2) return this._retStep2();
    if (step === 3) return this._retStep3();
    if (step === 3.5) return this._retStepBank();
    if (step === 4) return this._retStep4();
    if (step === 5) return this._retStep5();
    return UI.empty('ä¸æ˜ãªã‚¹ãƒ†ãƒƒãƒ—');
  },

  async _retStep1() {
    const orders = await API.getOrders();
    const order = (Array.isArray(orders) ? orders : []).find(o => o.order_id === this._state.returnOrder && o.status === 'confirmed');
    if (!order) return UI.card('ãŠæˆ»ã—å¯¾è±¡ã®æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') + `<button class="btn btn--ghost btn--full mt-1" onclick="App.navigate('active')">å–å¼•ä¸­ã¸</button>`;
    const product = await API.getProduct(order.product_id);
    const profitRate = product ? (order.unit_price - product.buy_price) / product.buy_price : 0.35;
    const profit = Math.round(order.total * profitRate);
    const totalAmount = order.total + profit;
    this._state._totalAmount = totalAmount; this._state._profit = profit; this._state._orderTotal = order.total; this._state._productName = product?.name || order.product_name || '';
    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('active')">â† æˆ»ã‚‹</button>
      ${UI.steps(1, 4)}
      ${UI.card(`
        <h3 class="section-title">ãŠæˆ»ã—æ–¹æ³•ã‚’é¸æŠ</h3>
        <div class="text-sm text-gray mb-1">${this._state._productName} (${Fmt.qty(order.qty)})</div>
        ${UI.confirmRow('å…ƒæœ¬', Fmt.yen(order.total))}${UI.confirmRow('åˆ©ç›Š', '+' + Fmt.yen(profit))}${UI.divider()}${UI.confirmRow('ãŠæˆ»ã—ç·é¡', Fmt.yen(totalAmount), 'font-bold')}
        <div class="choice-group mt-1">
          <button class="choice-btn" onclick="UserPages._state.returnAction='full';UserPages._state.returnAmount=${totalAmount};UserPages._state.returnStep=3;App.renderPage()"><div class="choice-btn__title">ğŸ’° å…¨é¡ã‚’å—ã‘å–ã‚‹</div><div class="choice-btn__desc">${Fmt.yen(totalAmount)} ã‚’å…¨é¡å—å–</div></button>
          <button class="choice-btn" onclick="UserPages._state.returnAction='partial';UserPages._state.returnStep=2;App.renderPage()"><div class="choice-btn__title">ğŸ“Š ä¸€éƒ¨ã‚’å—ã‘å–ã‚‹</div><div class="choice-btn__desc">å—å–é¡ã‚’æŒ‡å®šã—ã€æ®‹ã‚Šã¯é‹ç”¨ç¶™ç¶š</div></button>
        </div>
      `)}`;
  },

  _retStep2() {
    const total = this._state._totalAmount; const amt = this._state.returnAmount || Math.round(total / 2); const keep = total - amt; const pct = Math.round(amt / total * 100);
    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.returnStep=1;App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(2, 4)}
      ${UI.card(`
        <h3 class="section-title">å—å–é¡ã‚’å…¥åŠ›</h3><div class="text-sm text-gray mb-1">ãŠæˆ»ã—ç·é¡: ${Fmt.yen(total)}</div>
        <div class="form-group"><label class="form-label">å—ã‘å–ã‚‹é‡‘é¡</label><div class="amount-input-wrap"><span class="amount-prefix">Â¥</span><input type="number" class="input input--amount" value="${amt}" min="1" max="${total}" step="10000" onchange="UserPages._state.returnAmount=Math.max(1,Math.min(Number(this.value),${total}));App.renderPage({soft:true})"></div>
        <input type="range" class="range-slider" min="1" max="${total}" step="10000" value="${amt}" oninput="UserPages._state.returnAmount=Number(this.value);App.renderPage({soft:true})"><div class="range-labels"><span>Â¥1</span><span>${Fmt.yen(total)}</span></div></div>
        <div class="reinvest-bar"><div class="reinvest-bar__return" style="width:${pct}%"></div><div class="reinvest-bar__keep" style="width:${100 - pct}%"></div></div>
        <div class="payment-split"><div class="payment-split__item payment-split__item--green"><div class="text-xs">å—å–é¡</div><div class="font-bold">${Fmt.yen(amt)}</div></div><div class="payment-split__item payment-split__item--teal"><div class="text-xs">é‹ç”¨ç¶™ç¶š</div><div class="font-bold">${Fmt.yen(keep)}</div></div></div>
        <button class="btn btn--primary btn--full mt-1" onclick="UserPages._state.returnAmount=${amt};UserPages._state.returnStep=3;App.renderPage()">å—å–æ–¹æ³•ã®é¸æŠã¸ â†’</button>
      `)}`;
  },

  _retStep3() {
    const amt = this._state.returnAmount; const user = Auth.currentUser; const hasBank = user.bank_name && user.bank_number;
    const prevStep = this._state.returnAction === 'partial' ? 2 : 1;
    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.returnStep=${prevStep};App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(3, 4)}
      ${UI.card(`
        <h3 class="section-title">å—å–æ–¹æ³•ã‚’é¸æŠ</h3><div class="text-sm text-gray mb-1">å—å–é¡: ${Fmt.yen(amt)}</div>
        <div class="choice-group">
          <button class="choice-btn" onclick="UserPages._chooseTransfer()"><div class="choice-btn__title">ğŸ¦ éŠ€è¡ŒæŒ¯è¾¼</div><div class="choice-btn__desc">${hasBank ? user.bank_name + ' (' + user.bank_number + ')' : 'å£åº§æƒ…å ±ã‚’å…¥åŠ›ã—ã¦æŒ¯è¾¼ã§å—å–'}</div></button>
          <button class="choice-btn" onclick="UserPages._state.returnMethod='cash';UserPages._state.returnStep=4;App.renderPage()"><div class="choice-btn__title">ğŸ’µ ç¾é‡‘æ‰‹æ¸¡ã—</div><div class="choice-btn__desc">æ—¥ç¨‹ã‚’é¸ã‚“ã§å¯¾é¢ã§å—å–</div></button>
        </div>
      `)}`;
  },

  _chooseTransfer() {
    this._state.returnMethod = 'transfer'; const user = Auth.currentUser;
    this._state.returnStep = (user.bank_name && user.bank_number) ? 4 : 3.5; App.renderPage();
  },

  _retStepBank() {
    const user = Auth.currentUser;
    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.returnStep=3;App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(3, 4)}
      ${UI.card(`
        <h3 class="section-title">ğŸ¦ æŒ¯è¾¼å…ˆå£åº§ã‚’å…¥åŠ›</h3><div class="text-sm text-gray mb-1">ãŠæˆ»ã—é‡‘ã‚’å—ã‘å–ã‚‹å£åº§ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
        <div class="form-group"><label class="form-label">éŠ€è¡Œå <span class="text-red">*</span></label><input type="text" class="input" id="rb-bank" value="${user.bank_name || ''}" placeholder="â—‹â—‹éŠ€è¡Œ"></div>
        <div class="form-group"><label class="form-label">æ”¯åº—å</label><input type="text" class="input" id="rb-branch" value="${user.bank_branch || ''}" placeholder="â–³â–³æ”¯åº—"></div>
        <div class="form-group"><label class="form-label">å£åº§ç¨®é¡</label><select class="input" id="rb-type"><option value="æ™®é€š" ${(user.bank_type || 'æ™®é€š') === 'æ™®é€š' ? 'selected' : ''}>æ™®é€š</option><option value="å½“åº§" ${user.bank_type === 'å½“åº§' ? 'selected' : ''}>å½“åº§</option></select></div>
        <div class="form-group"><label class="form-label">å£åº§ç•ªå· <span class="text-red">*</span></label><input type="text" class="input" id="rb-number" value="${user.bank_number || ''}" placeholder="1234567" inputmode="numeric"></div>
        <div class="form-group"><label class="form-label">å£åº§åç¾©ï¼ˆã‚«ãƒŠï¼‰<span class="text-red">*</span></label><input type="text" class="input" id="rb-holder" value="${user.bank_holder || ''}" placeholder="ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦"></div>
        <button class="btn btn--primary btn--full" onclick="UserPages._saveBankAndContinue()">ä¿å­˜ã—ã¦æ¬¡ã¸ â†’</button>
      `)}`;
  },

  async _saveBankAndContinue() {
    const data = { bank_name: $('#rb-bank')?.value?.trim(), bank_branch: $('#rb-branch')?.value?.trim(), bank_type: $('#rb-type')?.value, bank_number: $('#rb-number')?.value?.trim(), bank_holder: $('#rb-holder')?.value?.trim() };
    if (!data.bank_name) { UI.toast('éŠ€è¡Œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!data.bank_number) { UI.toast('å£åº§ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!data.bank_holder) { UI.toast('å£åº§åç¾©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    const res = await API.updateProfile(data);
    if (res?.success && res.user) { Auth.currentUser = { ...Auth.currentUser, ...res.user }; localStorage.setItem('auth_user', JSON.stringify(Auth.currentUser)); UI.toast('å£åº§æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); this._state.returnStep = 4; App.renderPage(); }
    else UI.toast(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  },

  _retStep4() {
    const isCash = this._state.returnMethod === 'cash'; const isPartial = this._state.returnAction === 'partial';
    const amt = this._state.returnAmount; const keep = (this._state._totalAmount || 0) - amt; const user = Auth.currentUser;
    const dates = []; const base = new Date('2026-03-04'); const ranks = [2, 3, 1, 0, 0, 3, 2]; const dayNames = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    for (let i = 0; i < 7; i++) { const d = new Date(base); d.setDate(d.getDate() + i); dates.push({ date: d, rank: ranks[i], label: `${d.getMonth()+1}/${d.getDate()}`, day: dayNames[d.getDay()] }); }
    if (!this._state.returnDate && isCash) { const best = dates.find(d => d.rank === 3); if (best) this._state.returnDate = best.label; }
    let html = `<button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.returnStep=3;App.renderPage()">â† æˆ»ã‚‹</button>${UI.steps(4, 4)}`;
    html += UI.card(`
      <h3 class="section-title">${isCash ? 'æ—¥ç¨‹ã‚’é¸ã‚“ã§ç¢ºèª' : 'æœ€çµ‚ç¢ºèª'}</h3>
      ${isCash ? `<div class="schedule-hint">ğŸ’¡ â­ã®æ—¥ã«åˆã‚ã›ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã«ãŠæ¸¡ã—ã§ãã¾ã™</div><div class="sch-grid">${dates.map(d => {
        if (d.rank === 0) return `<div class="sch-cell sch-cell--off"><div class="sch-cell__date">${d.label}</div><div class="sch-cell__sub">${d.day}</div></div>`;
        const sel = this._state.returnDate === d.label; const cls = d.rank === 3 ? 'sch-cell--best' : d.rank === 2 ? 'sch-cell--ok' : 'sch-cell--few';
        return `<button class="sch-cell ${cls} ${sel ? 'sch-cell--sel' : ''}" onclick="UserPages._state.returnDate='${d.label}';App.renderPage({soft:true})">${d.rank === 3 ? '<div class="sch-cell__star">â­</div>' : ''}<div class="sch-cell__date">${d.label}</div><div class="sch-cell__sub">${d.day}</div></button>`;
      }).join('')}</div>${UI.divider()}` : ''}
      <div class="mt-05">
        ${UI.confirmRow('å•†å“', this._state._productName)}${UI.confirmRow('ãŠæˆ»ã—æ–¹æ³•', isPartial ? 'ä¸€éƒ¨å—å–' : 'å…¨é¡å—å–')}${UI.confirmRow('å—å–é¡', Fmt.yen(amt), 'font-bold')}${isPartial ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(keep)) : ''}${UI.confirmRow('å—å–æ–¹æ³•', isCash ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}${isCash ? UI.confirmRow('å¸Œæœ›æ—¥', this._state.returnDate || 'æœªé¸æŠ') : ''}
      </div>
      ${!isCash && user.bank_name ? `${UI.divider()}<div class="text-xs font-bold text-gray mb-05">æŒ¯è¾¼å…ˆå£åº§</div><div class="bank-info">${UI.confirmRow('éŠ€è¡Œ', user.bank_name)}${user.bank_branch ? UI.confirmRow('æ”¯åº—', user.bank_branch) : ''}${UI.confirmRow('å£åº§', (user.bank_type || 'æ™®é€š') + ' ' + user.bank_number)}${UI.confirmRow('åç¾©', user.bank_holder)}</div><button class="btn btn--ghost btn--sm mt-05" onclick="UserPages._state.returnStep=3.5;App.renderPage()">å£åº§æƒ…å ±ã‚’å¤‰æ›´</button>` : ''}
      <button class="btn btn--primary btn--full mt-1" onclick="UserPages._submitReturn()">ãŠæˆ»ã—ç”³è«‹ã‚’ç¢ºå®šã™ã‚‹</button>
    `);
    return html;
  },

  async _submitReturn() {
    const res = await API.createReturn({ orderId: this._state.returnOrder, return_action: this._state.returnAction, returnAmount: this._state.returnAmount, method: this._state.returnMethod, desiredDate: this._state.returnDate || '' });
    if (res?.success) {
      if (res.returnData?.keep_amount > 0) { Auth.currentUser.reinvest_balance = (Auth.currentUser.reinvest_balance || 0) + res.returnData.keep_amount; localStorage.setItem('auth_user', JSON.stringify(Auth.currentUser)); }
      this._state.returnStep = 5; this._state._returnResult = res.returnData; App.renderPage();
    } else UI.toast(res?.error || 'ç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  },

  _retStep5() {
    const ret = this._state._returnResult;
    return `${UI.card(`<div class="text-center"><div class="text-3xl mb-05">âœ…</div><h2 class="text-lg font-bold">ãŠæˆ»ã—ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸ</h2></div><div class="mt-1">${UI.confirmRow('å—å–é¡', Fmt.yen(ret?.return_amount))}${ret?.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(ret.keep_amount)) : ''}${UI.confirmRow('å—å–æ–¹æ³•', ret?.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}${ret?.desired_date ? UI.confirmRow('å¸Œæœ›æ—¥', ret.desired_date) : ''}</div><div class="info-box mt-1"><div class="text-xs">å‡¦ç†çŠ¶æ³ã¯ã€Œå–å¼•ä¸­ã€ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™</div></div>`)}<button class="btn btn--primary btn--full mt-1" onclick="App.navigate('active')">å–å¼•ä¸­ã¸</button>`;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“çŠ¶æ³
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å–å¼•ä¸­ï¼ˆé€²è¡Œä¸­ã®æ³¨æ–‡ãƒ»ãŠæˆ»ã—ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderActive() {
    const orders = await API.getOrders(); const returns = await API.getReturns();
    const myOrders = Array.isArray(orders) ? orders : []; const myReturns = Array.isArray(returns) ? returns : [];

    // é€²è¡Œä¸­ = pending_payment, pending_receipt, confirmed
    const activeOrders = myOrders.filter(o => ['pending_payment', 'pending_receipt', 'confirmed'].includes(o.status));
    // é€²è¡Œä¸­ã®ãŠæˆ»ã— = unprocessed, applied
    const activeReturns = myReturns.filter(r => ['unprocessed', 'applied'].includes(r.status));

    let html = `<h2 class="page-title">å–å¼•ä¸­</h2>`;
    const balance = Auth.currentUser?.reinvest_balance || 0;
    if (balance > 0) html += `<div class="balance-banner"><div class="balance-banner__amount">${Fmt.yen(balance)}</div><div class="balance-banner__label">é‹ç”¨ç¶™ç¶šä¸­ã®æ®‹é«˜</div></div>`;

    if (activeOrders.length === 0 && activeReturns.length === 0) return html + UI.empty('é€²è¡Œä¸­ã®å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“‹');

    // æ³¨æ–‡
    if (activeOrders.length > 0) {
      html += `<h3 class="section-title">ğŸ›’ æ³¨æ–‡ (${activeOrders.length}ä»¶)</h3>`;
      activeOrders.forEach(o => {
        const canReturn = o.status === 'confirmed' && !myReturns.find(r => r.order_id === o.order_id);
        const needUpload = ['pending_payment', 'pending_receipt'].includes(o.status);
        const canDownloadIOU = o.status === 'confirmed' && o.iou_requested === 'yes';
        const methodLabel = o.payment_method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼';
        html += `<div class="order-card"><div class="order-card__header"><span class="order-card__name">${o.product_name}</span>${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}</div>
        <div class="order-card__body">${UI.confirmRow('æ•°é‡', Fmt.qty(o.qty))}${UI.confirmRow('åˆè¨ˆ', Fmt.yen(o.total))}${o.balance_used > 0 ? UI.confirmRow('æ®‹é«˜å……å½“', Fmt.yen(o.balance_used)) : ''}${o.transfer_amount > 0 ? UI.confirmRow(o.payment_method === 'cash' ? 'æ‰‹æ¸¡ã—é¡' : 'æŒ¯è¾¼é¡', Fmt.yen(o.transfer_amount)) : ''}${UI.confirmRow('æ”¯æ‰•æ–¹æ³•', methodLabel)}${UI.confirmRow('æ³¨æ–‡æ—¥', Fmt.date(o.created_at))}</div>
        <div class="order-card__actions">
          ${canReturn ? `<button class="btn btn--outline btn--sm" onclick="UserPages.goReturn('${o.order_id}')">ãŠæˆ»ã—ç”³è«‹</button>` : ''}
          ${needUpload && !o.receipt_url && o.payment_method !== 'cash' ? `<button class="btn btn--primary btn--sm" onclick="UserPages._uploadReceipt('${o.order_id}')">æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>` : ''}
          ${o.receipt_url ? `<a href="${o.receipt_url}" target="_blank" rel="noopener" class="btn btn--outline btn--sm">ğŸ“ æ˜ç´°ã‚’è¦‹ã‚‹</a>` : ''}
          ${canDownloadIOU ? `<button class="btn btn--primary btn--sm" onclick="UserPages._downloadIOU('${o.order_id}')">ğŸ“„ å€Ÿç”¨æ›¸DL</button>` : ''}
        </div></div>`;
      });
    }

    // ãŠæˆ»ã—
    if (activeReturns.length > 0) {
      html += `<h3 class="section-title mt-2">â†©ï¸ ãŠæˆ»ã—ç”³è«‹ä¸­ (${activeReturns.length}ä»¶)</h3>`;
      activeReturns.forEach(r => {
        html += UI.card(`<div class="flex-between"><span class="font-bold">${r.product_name || 'å•†å“'}</span>${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}</div>${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}${r.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(r.keep_amount)) : ''}${UI.confirmRow('å—å–æ–¹æ³•', r.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}${UI.confirmRow('ç”³è«‹æ—¥', Fmt.date(r.created_at))}`);
      });
    }

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å±¥æ­´ï¼ˆå®Œçµæ¸ˆã¿ã®å–å¼•ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderHistory() {
    const orders = await API.getOrders(); const returns = await API.getReturns();
    const myOrders = Array.isArray(orders) ? orders : []; const myReturns = Array.isArray(returns) ? returns : [];

    // å®Œçµ = cancelled, ãã®ä»–ï¼ˆé€²è¡Œä¸­ã§ãªã„æ³¨æ–‡ï¼‰
    const doneOrders = myOrders.filter(o => !['pending_payment', 'pending_receipt', 'confirmed'].includes(o.status));
    // å®Œçµã—ãŸãŠæˆ»ã— = remitted, handed, rejected
    const doneReturns = myReturns.filter(r => ['remitted', 'handed', 'rejected'].includes(r.status));

    let html = `<h2 class="page-title">å±¥æ­´</h2>`;

    if (doneOrders.length === 0 && doneReturns.length === 0) return html + UI.empty('å®Œäº†ã—ãŸå–å¼•ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“œ');

    // ãŠæˆ»ã—å®Œäº†
    if (doneReturns.length > 0) {
      html += `<h3 class="section-title">â†©ï¸ ãŠæˆ»ã—å®Œäº† (${doneReturns.length}ä»¶)</h3>`;
      doneReturns.forEach(r => {
        html += UI.card(`<div class="flex-between"><span class="font-bold">${r.product_name || 'å•†å“'}</span>${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}</div>${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}${r.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(r.keep_amount)) : ''}${UI.confirmRow('å—å–æ–¹æ³•', r.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}${UI.confirmRow('å®Œäº†æ—¥', Fmt.date(r.updated_at || r.created_at))}`);
      });
    }

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿æ³¨æ–‡
    if (doneOrders.length > 0) {
      html += `<h3 class="section-title ${doneReturns.length > 0 ? 'mt-2' : ''}">ğŸ“¦ éå»ã®æ³¨æ–‡ (${doneOrders.length}ä»¶)</h3>`;
      doneOrders.forEach(o => {
        const methodLabel = o.payment_method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼';
        html += `<div class="order-card"><div class="order-card__header"><span class="order-card__name">${o.product_name}</span>${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}</div>
        <div class="order-card__body">${UI.confirmRow('æ•°é‡', Fmt.qty(o.qty))}${UI.confirmRow('åˆè¨ˆ', Fmt.yen(o.total))}${UI.confirmRow('æ”¯æ‰•æ–¹æ³•', methodLabel)}${UI.confirmRow('æ³¨æ–‡æ—¥', Fmt.date(o.created_at))}</div></div>`;
      });
    }

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»å£åº§ç®¡ç†ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderMyPage() {
    const user = Auth.currentUser; const hasBank = user.bank_name && user.bank_number;
    let html = `<h2 class="page-title">ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>`;
    html += UI.card(`${UI.confirmRow('åå‰', user.name)}${UI.confirmRow('ã‚°ãƒ«ãƒ¼ãƒ—', user.group_name || '-')}${user.email ? UI.confirmRow('ãƒ¡ãƒ¼ãƒ«', user.email) : ''}`);

    // å£åº§æƒ…å ±
    html += '<h3 class="section-title mt-2">ğŸ¦ å—å–å£åº§</h3>';
    if (this._state._editingBank) {
      html += UI.card(`
        <div class="form-group"><label class="form-label">éŠ€è¡Œå <span class="text-red">*</span></label><input type="text" class="input" id="mb-bank" value="${user.bank_name || ''}" placeholder="â—‹â—‹éŠ€è¡Œ"></div>
        <div class="form-group"><label class="form-label">æ”¯åº—å</label><input type="text" class="input" id="mb-branch" value="${user.bank_branch || ''}" placeholder="â–³â–³æ”¯åº—"></div>
        <div class="form-group"><label class="form-label">å£åº§ç¨®é¡</label><select class="input" id="mb-type"><option value="æ™®é€š" ${(user.bank_type || 'æ™®é€š') === 'æ™®é€š' ? 'selected' : ''}>æ™®é€š</option><option value="å½“åº§" ${user.bank_type === 'å½“åº§' ? 'selected' : ''}>å½“åº§</option></select></div>
        <div class="form-group"><label class="form-label">å£åº§ç•ªå· <span class="text-red">*</span></label><input type="text" class="input" id="mb-number" value="${user.bank_number || ''}" placeholder="1234567" inputmode="numeric"></div>
        <div class="form-group"><label class="form-label">å£åº§åç¾©ï¼ˆã‚«ãƒŠï¼‰<span class="text-red">*</span></label><input type="text" class="input" id="mb-holder" value="${user.bank_holder || ''}" placeholder="ãƒ¤ãƒãƒ€ ã‚¿ãƒ­ã‚¦"></div>
        <div class="btn-group"><button class="btn btn--ghost" onclick="UserPages._state._editingBank=false;App.renderPage({soft:true})">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn--primary" onclick="UserPages._saveBankInfo()">ä¿å­˜</button></div>
      `);
    } else if (hasBank) {
      html += UI.card(`<div class="bank-info">${UI.confirmRow('éŠ€è¡Œ', user.bank_name)}${user.bank_branch ? UI.confirmRow('æ”¯åº—', user.bank_branch) : ''}${UI.confirmRow('å£åº§', (user.bank_type || 'æ™®é€š') + ' ' + user.bank_number)}${UI.confirmRow('åç¾©', user.bank_holder)}</div><button class="btn btn--outline btn--sm mt-1" onclick="UserPages._state._editingBank=true;App.renderPage({soft:true})">å£åº§æƒ…å ±ã‚’å¤‰æ›´</button>`);
    } else {
      html += `<div class="profile-bank-empty"><div class="profile-bank-empty__text">âš ï¸ å£åº§æƒ…å ±ãŒæœªç™»éŒ²ã§ã™</div><div class="text-xs text-gray mb-1">ãŠæˆ»ã—ã§éŠ€è¡ŒæŒ¯è¾¼ã‚’é¸ã¶éš›ã«å¿…è¦ã§ã™</div><button class="btn btn--primary btn--sm" onclick="UserPages._state._editingBank=true;App.renderPage({soft:true})">å£åº§æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹</button></div>`;
    }
    html += '<button class="btn btn--ghost btn--full mt-2" onclick="App.doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>';
    return html;
  },

  async _saveBankInfo() {
    const data = { bank_name: $('#mb-bank')?.value?.trim(), bank_branch: $('#mb-branch')?.value?.trim(), bank_type: $('#mb-type')?.value, bank_number: $('#mb-number')?.value?.trim(), bank_holder: $('#mb-holder')?.value?.trim() };
    if (!data.bank_name) { UI.toast('éŠ€è¡Œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!data.bank_number) { UI.toast('å£åº§ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!data.bank_holder) { UI.toast('å£åº§åç¾©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    const res = await API.updateProfile(data);
    if (res?.success && res.user) { Auth.currentUser = { ...Auth.currentUser, ...res.user }; localStorage.setItem('auth_user', JSON.stringify(Auth.currentUser)); this._state._editingBank = false; UI.toast('å£åº§æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); App.renderPage(); }
    else UI.toast(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å€Ÿç”¨æ›¸PDFç”Ÿæˆï¼ˆjsPDFï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async _downloadIOU(orderId) {
    const orders = await API.getOrders();
    const order = (Array.isArray(orders) ? orders : []).find(o => o.order_id === orderId);
    if (!order || order.iou_requested !== 'yes') { UI.toast('å€Ÿç”¨æ›¸ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error'); return; }
    UI.toast('å€Ÿç”¨æ›¸ã‚’ç”Ÿæˆä¸­...', 'info');
    if (!window.jspdf) {
      await new Promise((resolve, reject) => { const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'; s.onload = resolve; s.onerror = reject; document.head.appendChild(s); });
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const now = new Date();
    const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
    const amount = Number(order.total || 0).toLocaleString();

    doc.setFont('helvetica', 'bold'); doc.setFontSize(24);
    doc.text('BORROWING CERTIFICATE', 105, 35, { align: 'center' });
    doc.setFontSize(12); doc.text('( Shakuyousho )', 105, 43, { align: 'center' });
    doc.setLineWidth(0.5); doc.line(30, 50, 180, 50);
    doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
    let y = 65;
    doc.text(`Date: ${dateStr}`, 30, y); y += 10;
    doc.text(`Order ID: ${order.order_id}`, 30, y); y += 10;
    doc.text(`Borrower: ${order.iou_name || ''}`, 30, y); y += 10;
    doc.text(`Address: ${order.iou_address || ''}`, 30, y); y += 15;
    doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
    doc.text(`Amount: JPY ${amount}`, 30, y); y += 15;
    doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
    doc.text(`Product: ${order.product_name || ''}`, 30, y); y += 8;
    doc.text(`Quantity: ${order.qty || 0}`, 30, y); y += 8;
    doc.text(`Unit Price: JPY ${Number(order.unit_price || 0).toLocaleString()}`, 30, y); y += 8;
    doc.text(`Payment: Bank Transfer`, 30, y); y += 15;
    doc.line(30, y, 180, y); y += 15;
    doc.setFontSize(10);
    doc.text('This document certifies the borrowing of the above amount', 30, y); y += 6;
    doc.text('for the purpose of investment as described.', 30, y); y += 15;
    doc.text('Signature: ____________________________', 30, y); y += 10;
    doc.text('Date: ____________________________', 30, y); y += 20;
    doc.setFontSize(8); doc.setTextColor(150);
    doc.text('* This is a template. Final content will be provided separately.', 30, y);
    doc.save(`IOU_${order.order_id}.pdf`);
    UI.toast('å€Ÿç”¨æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  _uploadReceipt(orderId) {
    const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*,.pdf';
    input.onchange = async (e) => {
      const file = e.target.files[0]; if (!file) return;
      if (file.size > 5 * 1024 * 1024) { UI.toast('ãƒ•ã‚¡ã‚¤ãƒ«ã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error'); return; }
      UI.toast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
      const base64 = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = () => reject(new Error('èª­ã¿è¾¼ã¿å¤±æ•—')); reader.readAsDataURL(file); });
      const res = await API.uploadReceipt({ orderId, fileName: file.name, base64Data: base64, mimeType: file.type || 'image/jpeg' });
      if (res?.success) { UI.toast('æ˜ç´°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
      else UI.toast(res?.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    };
    input.click();
  },
};

// â”€â”€ leader.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒªãƒ¼ãƒ€ãƒ¼ç”»é¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LeaderPages = {
  _state: {},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ä¾¡æ ¼è¨­å®š
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderPricing() {
    const products = await API.getProducts();
    const groupId = Auth.getGroupId();
    const groupName = Auth.getGroupName();
    const list = Array.isArray(products) ? products : [];
    const active = list.filter(p => p.status === 'active');

    let html = `<h2 class="page-title">ä¾¡æ ¼è¨­å®š</h2>
      <div class="text-sm text-gray mb-1">${groupName} ã®è²©å£²å˜ä¾¡ã‚’èª¿æ•´</div>`;

    if (active.length === 0) return html + UI.empty('è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ’°');

    for (const p of active) {
      const prices = await API.getGroupPrices(p.product_id);
      const gp = (Array.isArray(prices) ? prices : []).find(g => g.group_id === groupId);
      const baseSellPrice = p.base_sell_price || 0;
      const groupSellPrice = gp?.sell_price || baseSellPrice;
      const profitRate = gp?.profit_rate || 0;
      const diff = groupSellPrice - baseSellPrice;

      html += UI.card(`
        <div class="flex-between">
          <span class="font-bold">${p.name}</span>
          ${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}
        </div>
        <div class="price-info-grid mt-05">
          ${UI.confirmRow('ä»•å…¥å˜ä¾¡', Fmt.yen(p.buy_price))}
          ${UI.confirmRow('åŸºæº–å£²å˜ä¾¡ï¼ˆç®¡ç†è€…è¨­å®šï¼‰', Fmt.yen(baseSellPrice))}
          <div class="divider"></div>
          ${UI.confirmRow('ã‚°ãƒ«ãƒ¼ãƒ—è²©å£²å˜ä¾¡', `<span class="font-bold text-lg">${Fmt.yen(groupSellPrice)}</span>`, '')}
          ${diff !== 0 ? UI.confirmRow('åŸºæº–ã¨ã®å·®é¡', `<span class="${diff > 0 ? 'text-green' : 'text-red'}">${diff > 0 ? '+' : ''}${Fmt.yen(diff)}</span>`) : ''}
          ${UI.confirmRow('åˆ©ç›Šç‡ï¼ˆå¯¾ä»•å…¥ï¼‰', Fmt.pct(profitRate))}
        </div>
        <div class="form-group mt-1">
          <label class="form-label">è²©å£²å˜ä¾¡ã‚’å¤‰æ›´</label>
          <div class="amount-input-wrap">
            <span class="amount-prefix">Â¥</span>
            <input type="number" class="input input--amount" id="price-${p.product_id}" value="${groupSellPrice}" min="${p.buy_price}" step="100">
          </div>
          <div class="text-xs text-gray mt-05">â€» ä»•å…¥å˜ä¾¡ï¼ˆ${Fmt.yen(p.buy_price)}ï¼‰ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„</div>
          <button class="btn btn--primary btn--sm mt-05" onclick="LeaderPages._savePrice('${p.product_id}', '${groupId}')">ä¿å­˜</button>
        </div>
      `);
    }

    return html;
  },

  async _savePrice(productId, groupId) {
    const input = $(`#price-${productId}`);
    const sellPrice = Number(input?.value);
    if (!sellPrice || sellPrice <= 0) { UI.toast('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

    const res = await API.updateGroupPrice({ productId, groupId, sell_price: sellPrice });
    if (res?.success) {
      UI.toast('å£²å˜ä¾¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      API.clearCache();
      App.renderPage();
    } else {
      UI.toast(res?.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  æ³¨æ–‡ç¢ºèª
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderOrders() {
    const orders = await API.getOrders();
    const list = Array.isArray(orders) ? orders : [];

    let html = `<h2 class="page-title">æ³¨æ–‡ç¢ºèª</h2>
      <div class="text-sm text-gray mb-1">${Auth.getGroupName()} ã®æ³¨æ–‡ä¸€è¦§</div>`;

    if (list.length === 0) return html + UI.empty('æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“‹');

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ
    const pending = list.filter(o => ['pending_payment', 'pending_receipt'].includes(o.status));
    const confirmed = list.filter(o => o.status === 'confirmed');

    html += UI.statGrid([
      UI.stat('æœªå‡¦ç†', pending.length, '', pending.length > 0 ? 'red' : ''),
      UI.stat('ç¢ºå®šæ¸ˆ', confirmed.length, Fmt.yen(confirmed.reduce((s, o) => s + o.total, 0)), 'green'),
    ]);

    list.sort((a, b) => String(b.created_at).localeCompare(String(a.created_at)));
    list.forEach(o => {
      html += UI.card(`
        <div class="flex-between">
          <span class="font-bold">${o.user_name}</span>
          ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
        </div>
        ${UI.confirmRow('å•†å“', o.product_name)}
        ${UI.confirmRow('æ•°é‡', Fmt.qty(o.qty))}
        ${UI.confirmRow('é‡‘é¡', Fmt.yen(o.total))}
        ${o.balance_used > 0 ? UI.confirmRow('æ®‹é«˜å……å½“', Fmt.yen(o.balance_used)) : ''}
        ${o.transfer_amount > 0 ? UI.confirmRow('æŒ¯è¾¼é¡', Fmt.yen(o.transfer_amount)) : ''}
        ${UI.confirmRow('æ³¨æ–‡æ—¥', Fmt.dateTime(o.created_at))}
        ${o.status === 'pending_receipt' ? `<button class="btn btn--primary btn--sm mt-05" onclick="LeaderPages._confirmOrder('${o.order_id}')">å…¥é‡‘ç¢ºèª</button>` : ''}
      `);
    });

    return html;
  },

  async _confirmOrder(orderId) {
    UI.confirm('å…¥é‡‘ã‚’ç¢ºèªã—ã¦æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ', async () => {
      const res = await API.updateOrder(orderId, { status: 'confirmed' });
      if (res?.success) { UI.toast('æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ'); App.renderPage(); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãŠæˆ»ã—å‡¦ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderReturns() {
    const returns = await API.getReturns();
    const list = Array.isArray(returns) ? returns : [];

    let html = `<h2 class="page-title">ãŠæˆ»ã—å‡¦ç†</h2>
      <div class="text-sm text-gray mb-1">${Auth.getGroupName()}</div>`;

    if (list.length === 0) return html + UI.empty('ãŠæˆ»ã—ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“', 'â†©ï¸');

    const unprocessed = list.filter(r => ['unprocessed', 'applied'].includes(r.status));
    const processed = list.filter(r => !['unprocessed', 'applied'].includes(r.status));

    if (unprocessed.length > 0) {
      html += `<h3 class="section-title">æœªå‡¦ç† (${unprocessed.length}ä»¶)</h3>`;
      unprocessed.forEach(r => {
        html += UI.card(`
          <div class="flex-between">
            <span class="font-bold">${r.user_name}</span>
            ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
          </div>
          ${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}
          ${r.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(r.keep_amount)) : ''}
          ${UI.confirmRow('æ–¹æ³•', r.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}
          ${r.desired_date ? UI.confirmRow('å¸Œæœ›æ—¥', r.desired_date) : ''}
          <div class="btn-group mt-1">
            <button class="btn btn--primary btn--sm" onclick="LeaderPages._processReturn('${r.return_id}', '${r.method === 'cash' ? 'handed' : 'remitted'}')">
              ${r.method === 'cash' ? 'æ‰‹æ¸¡ã—å®Œäº†' : 'é€é‡‘å®Œäº†'}
            </button>
          </div>
        `);
      });
    }

    if (processed.length > 0) {
      html += `<h3 class="section-title mt-2">å‡¦ç†æ¸ˆã¿</h3>`;
      processed.forEach(r => {
        html += UI.card(`
          <div class="flex-between">
            <span>${r.user_name}</span>
            ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
          </div>
          <div class="text-sm">${Fmt.yen(r.return_amount)} / ${Fmt.dateTime(r.created_at)}</div>
        `);
      });
    }

    return html;
  },

  async _processReturn(returnId, status) {
    const label = status === 'handed' ? 'æ‰‹æ¸¡ã—å®Œäº†' : 'é€é‡‘å®Œäº†';
    UI.confirm(`ã€Œ${label}ã€ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
      const res = await API.updateReturn(returnId, { status });
      if (res?.success) { UI.toast('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); App.renderPage(); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“çŠ¶æ³
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderStatus() {
    const products = await API.getProducts();
    const orders = await API.getOrders();
    const returns = await API.getReturns();
    const groupId = Auth.getGroupId();
    const groupName = Auth.getGroupName();
    const list = Array.isArray(products) ? products : [];
    const orderList = Array.isArray(orders) ? orders : [];
    const returnList = Array.isArray(returns) ? returns : [];

    let html = `<h2 class="page-title">å•†å“çŠ¶æ³</h2>
      <div class="text-sm text-gray mb-1">${groupName}</div>`;

    if (list.length === 0) return html + UI.empty('å•†å“ãŒã‚ã‚Šã¾ã›ã‚“', 'ğŸ“Š');

    const active = list.filter(p => p.status === 'active');
    const closed = list.filter(p => p.status === 'closed');

    const renderProduct = (p) => {
      const pOrders = orderList.filter(o => o.product_id === p.product_id);
      const pReturns = returnList.filter(r => pOrders.some(o => o.order_id === r.order_id));

      const totalOrdered = pOrders.reduce((s, o) => s + (o.qty || 0), 0);
      const confirmed = pOrders.filter(o => o.status === 'confirmed');
      const pendingPayment = pOrders.filter(o => o.status === 'pending_payment');
      const pendingReceipt = pOrders.filter(o => o.status === 'pending_receipt');
      const paidAmount = confirmed.reduce((s, o) => s + (o.total || 0), 0);

      const pendingReturns = pReturns.filter(r => ['unprocessed', 'applied'].includes(r.status));
      const doneReturns = pReturns.filter(r => ['remitted', 'handed'].includes(r.status));

      html += `<div class="status-card">
        <div class="status-card__header">
          <span class="font-bold">${p.name}</span>
          ${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}
        </div>

        <div class="status-section">
          <div class="status-section__title">ğŸ“¦ åœ¨åº«</div>
          <div class="status-bar-wrap">
            <div class="status-bar">
              <div class="status-bar__fill" style="width:${p.total_qty > 0 ? (1 - p.remaining_qty / p.total_qty) * 100 : 0}%"></div>
            </div>
            <div class="status-bar__label">${p.remaining_qty} / ${p.total_qty} æ®‹ã‚Š</div>
          </div>
        </div>

        <div class="status-section">
          <div class="status-section__title">ğŸ’° å…¥é‡‘çŠ¶æ³</div>
          <div class="status-chips">
            <span class="status-chip status-chip--green">ç¢ºå®š ${confirmed.length}ä»¶ (${Fmt.yen(paidAmount)})</span>
            ${pendingReceipt.length > 0 ? `<span class="status-chip status-chip--gold">æ˜ç´°ç¢ºèª ${pendingReceipt.length}ä»¶</span>` : ''}
            ${pendingPayment.length > 0 ? `<span class="status-chip status-chip--red">å…¥é‡‘å¾…ã¡ ${pendingPayment.length}ä»¶</span>` : ''}
          </div>
        </div>

        ${pOrders.length > 0 ? `
        <div class="status-section">
          <div class="status-section__title">ğŸ‘¤ æ³¨æ–‡è€…</div>
          <div class="status-users">
            ${pOrders.map(o => `<div class="status-user-row">
              <span>${o.user_name}</span>
              <span>${Fmt.qty(o.qty)}</span>
              <span>${Fmt.yen(o.total)}</span>
              ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
            </div>`).join('')}
          </div>
        </div>` : ''}

        ${pReturns.length > 0 ? `
        <div class="status-section">
          <div class="status-section__title">â†©ï¸ ãŠæˆ»ã—</div>
          <div class="status-chips">
            ${pendingReturns.length > 0 ? `<span class="status-chip status-chip--red">æœªå‡¦ç† ${pendingReturns.length}ä»¶</span>` : ''}
            ${doneReturns.length > 0 ? `<span class="status-chip status-chip--green">å‡¦ç†æ¸ˆ ${doneReturns.length}ä»¶</span>` : ''}
          </div>
        </div>` : ''}
      </div>`;
    };

    if (active.length > 0) {
      html += `<h3 class="section-title">è²©å£²ä¸­</h3>`;
      active.forEach(renderProduct);
    }
    if (closed.length > 0) {
      html += `<h3 class="section-title mt-2">ç· åˆ‡æ¸ˆã¿</h3>`;
      closed.forEach(renderProduct);
    }

    return html;
  },
};

// â”€â”€ admin.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ç®¡ç†è€…ç”»é¢ v2.0 â€” 4ã‚¿ãƒ–æ§‹æˆ + é«˜é€ŸåŒ–
//  ãƒ›ãƒ¼ãƒ  / å–å¼• / å•†å“ / ãƒ¦ãƒ¼ã‚¶ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AdminPages = {
  _state: {
    editProduct: null, orderFilter: 'all', selectedOrder: null,
    editUser: null, pwUser: null, tradeTab: 'orders',
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãƒ›ãƒ¼ãƒ ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ + æœªå‡¦ç†ä¸€è¦§ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderHome() {
    // ãƒãƒƒãƒã§1å›ã®HTTPã«çµ±åˆ
    const data = await API.batch([
      { key: 'dash', action: 'getDashboard' },
      { key: 'orders', action: 'getOrders' },
      { key: 'returns', action: 'getReturns' },
    ]);
    const d = data.dash?.dashboard || {};
    const allOrders = Array.isArray(data.orders) ? data.orders : [];
    const allReturns = Array.isArray(data.returns) ? data.returns : [];
    const pendingOrders = allOrders.filter(o => ['pending_payment', 'pending_receipt'].includes(o.status));
    const pendingReturns = allReturns.filter(r => ['unprocessed', 'applied'].includes(r.status));

    let html = `<h2 class="page-title">ãƒ›ãƒ¼ãƒ </h2>`;

    // ã‚µãƒãƒªãƒ¼
    html += UI.statGrid([
      UI.stat('ãƒ¦ãƒ¼ã‚¶ãƒ¼', d.total_users || 0, '', 'blue'),
      UI.stat('å•†å“', `${d.active_products || 0}/${d.total_products || 0}`, 'è²©å£²ä¸­/å…¨ä½“', 'green'),
      UI.stat('å£²ä¸Š', Fmt.yen(d.total_sales || 0), 'ç¢ºå®šæ¸ˆã¿', 'gold'),
      UI.stat('æœªå‡¦ç†', (pendingOrders.length + pendingReturns.length) || 0, `æ³¨æ–‡${pendingOrders.length} ãŠæˆ»ã—${pendingReturns.length}`, (pendingOrders.length + pendingReturns.length) > 0 ? 'red' : ''),
    ]);

    // æœªå‡¦ç†æ³¨æ–‡ï¼ˆç›´æ¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½ï¼‰
    if (pendingOrders.length > 0) {
      html += `<h3 class="section-title mt-2">ğŸ”” æœªå‡¦ç†ã®æ³¨æ–‡ (${pendingOrders.length}ä»¶)</h3>`;
      pendingOrders.sort((a, b) => String(a.created_at).localeCompare(String(b.created_at)));
      pendingOrders.slice(0, 5).forEach(o => {
        html += `<div class="order-admin-card order-admin-card--action" onclick="AdminPages._state.selectedOrder='${o.order_id}';App.currentPage='order-detail';App.renderPage()">
          <div class="flex-between">
            <div><span class="font-bold">${o.user_name}</span> <span class="text-xs text-gray">${o.group_id || ''}</span></div>
            ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
          </div>
          <div class="order-admin-card__body"><span class="text-sm">${o.product_name} Ã— ${o.qty}å€‹</span><span class="font-bold">${Fmt.yen(o.transfer_amount || o.total)}</span></div>
          <div class="order-admin-card__footer"><span>${Fmt.dateTime(o.created_at)}</span>${o.receipt_url ? '<span class="text-xs text-blue">ğŸ“ æ˜ç´°ã‚ã‚Š</span>' : ''}</div>
        </div>`;
      });
      if (pendingOrders.length > 5) html += `<button class="btn btn--ghost btn--full mt-05" onclick="AdminPages._state.tradeTab='orders';AdminPages._state.orderFilter='pending_payment';App.navigate('trade')">ã™ã¹ã¦è¦‹ã‚‹ â†’</button>`;
    }

    // æœªå‡¦ç†ãŠæˆ»ã—
    if (pendingReturns.length > 0) {
      html += `<h3 class="section-title mt-2">ğŸ”” æœªå‡¦ç†ã®ãŠæˆ»ã— (${pendingReturns.length}ä»¶)</h3>`;
      pendingReturns.forEach(r => {
        const isTransfer = r.method !== 'cash';
        const hasBank = isTransfer && r.user_bank_name && r.user_bank_number;
        html += UI.card(`
          <div class="flex-between"><span class="font-bold">${r.user_name}</span>${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}</div>
          ${UI.confirmRow('å•†å“', r.product_name || '-')}
          ${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}
          ${UI.confirmRow('æ–¹æ³•', isTransfer ? 'éŠ€è¡ŒæŒ¯è¾¼' : 'ç¾é‡‘æ‰‹æ¸¡ã—')}
          ${isTransfer ? `${UI.divider()}<div class="text-xs font-bold text-gray mb-05">ğŸ¦ æŒ¯è¾¼å…ˆ</div>${hasBank ? `${UI.confirmRow('éŠ€è¡Œ', r.user_bank_name)}${r.user_bank_branch ? UI.confirmRow('æ”¯åº—', r.user_bank_branch) : ''}${UI.confirmRow('å£åº§', (r.user_bank_type || 'æ™®é€š') + ' ' + r.user_bank_number)}${r.user_bank_holder ? UI.confirmRow('åç¾©', r.user_bank_holder) : ''}` : '<div class="warning-box">âš ï¸ å£åº§æƒ…å ±ãŒæœªç™»éŒ²</div>'}` : ''}
          <div class="btn-group mt-1"><button class="btn btn--primary btn--full" onclick="AdminPages._processReturn('${r.return_id}', '${r.method === 'cash' ? 'handed' : 'remitted'}')">âœ… ${r.method === 'cash' ? 'æ‰‹æ¸¡ã—å®Œäº†' : 'é€é‡‘å®Œäº†'}</button></div>
        `);
      });
    }

    // ä½•ã‚‚ãªã„å ´åˆ
    if (pendingOrders.length === 0 && pendingReturns.length === 0) {
      html += UI.card('<div class="text-center text-gray" style="padding:20px 0">âœ… æœªå‡¦ç†ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>');
    }

    // è¨­å®šãƒªãƒ³ã‚¯
    html += `<button class="btn btn--ghost btn--full mt-2" onclick="App.currentPage='settings';App.renderPage()">âš™ï¸ æŒ¯è¾¼å…ˆå£åº§ã®è¨­å®š</button>`;

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å–å¼•ç®¡ç†ï¼ˆæ³¨æ–‡ + ãŠæˆ»ã— ã‚µãƒ–ã‚¿ãƒ–åˆ‡æ›¿ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderTrade() {
    this._state.selectedOrder = null;
    const tab = this._state.tradeTab;

    let html = `<h2 class="page-title">å–å¼•ç®¡ç†</h2>`;
    html += `<div class="sub-tabs">
      <button class="sub-tab ${tab === 'orders' ? 'sub-tab--active' : ''}" onclick="AdminPages._state.tradeTab='orders';App.renderPage()">ğŸ“‹ æ³¨æ–‡</button>
      <button class="sub-tab ${tab === 'returns' ? 'sub-tab--active' : ''}" onclick="AdminPages._state.tradeTab='returns';App.renderPage()">â†©ï¸ ãŠæˆ»ã—</button>
    </div>`;

    if (tab === 'orders') html += await this._renderOrderList();
    else html += await this._renderReturnList();
    return html;
  },

  async _renderOrderList() {
    const orders = await API.getOrders();
    const list = (Array.isArray(orders) ? orders : []).sort((a, b) => String(b.created_at).localeCompare(String(a.created_at)));
    const filter = this._state.orderFilter;
    const counts = { all: list.length, pending_payment: 0, pending_receipt: 0, confirmed: 0 };
    list.forEach(o => { if (counts[o.status] !== undefined) counts[o.status]++; });
    const filtered = filter === 'all' ? list : list.filter(o => o.status === filter);

    let html = UI.statGrid([
      UI.stat('å…¨æ³¨æ–‡', counts.all),
      UI.stat('å…¥é‡‘å¾…', counts.pending_payment, '', counts.pending_payment > 0 ? 'red' : ''),
      UI.stat('æ˜ç´°å¾…', counts.pending_receipt, '', counts.pending_receipt > 0 ? 'gold' : ''),
      UI.stat('ç¢ºå®š', counts.confirmed, '', 'green'),
    ]);
    const filters = [
      { key: 'all', label: `ã™ã¹ã¦ (${counts.all})` },
      { key: 'pending_payment', label: `å…¥é‡‘å¾… (${counts.pending_payment})` },
      { key: 'pending_receipt', label: `æ˜ç´°ç¢ºèª (${counts.pending_receipt})` },
      { key: 'confirmed', label: `ç¢ºå®š (${counts.confirmed})` },
    ];
    html += `<div class="filter-tabs">${filters.map(f => `<button class="filter-tab ${filter === f.key ? 'filter-tab--active' : ''}" onclick="AdminPages._state.orderFilter='${f.key}';App.renderPage()">${f.label}</button>`).join('')}</div>`;
    if (filtered.length === 0) return html + UI.empty('è©²å½“ã™ã‚‹æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“‹');
    filtered.forEach(o => {
      const isAction = ['pending_payment', 'pending_receipt'].includes(o.status);
      html += `<div class="order-admin-card ${isAction ? 'order-admin-card--action' : ''}" onclick="AdminPages._state.selectedOrder='${o.order_id}';App.currentPage='order-detail';App.renderPage()">
        <div class="flex-between"><div><span class="font-bold">${o.user_name}</span> <span class="text-xs text-gray">${o.group_id || ''}</span></div>${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}</div>
        <div class="order-admin-card__body"><span class="text-sm">${o.product_name} Ã— ${o.qty}å€‹</span><span class="font-bold">${Fmt.yen(o.transfer_amount || o.total)}</span></div>
        <div class="order-admin-card__footer"><span>${Fmt.dateTime(o.created_at)}</span>${o.receipt_url ? '<span class="text-xs text-blue">ğŸ“ æ˜ç´°ã‚ã‚Š</span>' : ''}</div>
      </div>`;
    });
    return html;
  },

  async _renderReturnList() {
    const returns = await API.getReturns();
    const list = Array.isArray(returns) ? returns : [];
    const unprocessed = list.filter(r => ['unprocessed', 'applied'].includes(r.status));
    const processed = list.filter(r => !['unprocessed', 'applied'].includes(r.status));
    let html = '';
    if (unprocessed.length === 0 && processed.length === 0) return UI.empty('ãŠæˆ»ã—ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“', 'â†©ï¸');
    if (unprocessed.length > 0) {
      html += `<h3 class="section-title">æœªå‡¦ç† (${unprocessed.length}ä»¶)</h3>`;
      unprocessed.forEach(r => {
        const isTransfer = r.method !== 'cash';
        const hasBank = isTransfer && r.user_bank_name && r.user_bank_number;
        html += UI.card(`
          <div class="flex-between"><span class="font-bold">${r.user_name}</span>${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}</div>
          ${UI.confirmRow('å•†å“', r.product_name || '-')}
          ${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}
          ${r.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(r.keep_amount)) : ''}
          ${UI.confirmRow('æ–¹æ³•', isTransfer ? 'éŠ€è¡ŒæŒ¯è¾¼' : 'ç¾é‡‘æ‰‹æ¸¡ã—')}
          ${r.desired_date ? UI.confirmRow('å¸Œæœ›æ—¥', r.desired_date) : ''}
          ${UI.confirmRow('ç”³è«‹æ—¥', Fmt.dateTime(r.created_at))}
          ${isTransfer ? `${UI.divider()}<div class="text-xs font-bold text-gray mb-05">ğŸ¦ æŒ¯è¾¼å…ˆ</div>${hasBank ? `<div class="bank-info">${UI.confirmRow('éŠ€è¡Œ', r.user_bank_name)}${r.user_bank_branch ? UI.confirmRow('æ”¯åº—', r.user_bank_branch) : ''}${UI.confirmRow('å£åº§', (r.user_bank_type || 'æ™®é€š') + ' ' + r.user_bank_number)}${r.user_bank_holder ? UI.confirmRow('åç¾©', r.user_bank_holder) : ''}</div>` : '<div class="warning-box">âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å£åº§æƒ…å ±ãŒæœªç™»éŒ²ã§ã™</div>'}` : ''}
          <div class="btn-group mt-1"><button class="btn btn--primary btn--full" onclick="AdminPages._processReturn('${r.return_id}', '${r.method === 'cash' ? 'handed' : 'remitted'}')">âœ… ${r.method === 'cash' ? 'æ‰‹æ¸¡ã—å®Œäº†' : 'é€é‡‘å®Œäº†'}</button></div>
        `);
      });
    }
    if (processed.length > 0) {
      html += `<h3 class="section-title ${unprocessed.length > 0 ? 'mt-2' : ''}">å®Œäº†æ¸ˆã¿ (${processed.length}ä»¶)</h3>`;
      processed.forEach(r => {
        html += UI.card(`<div class="flex-between"><span class="font-bold">${r.user_name}</span>${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}</div>${UI.confirmRow('å•†å“', r.product_name || '-')}${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}${UI.confirmRow('æ–¹æ³•', r.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}`);
      });
    }
    return html;
  },

  async _processReturn(returnId, status) {
    const labels = { remitted: 'é€é‡‘å®Œäº†', handed: 'æ‰‹æ¸¡ã—å®Œäº†' };
    UI.confirm(`${labels[status]}ã«ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
      const res = await API.updateReturn(returnId, { status });
      if (res?.success) { UI.toast(labels[status] + 'ã«ã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
      else UI.toast(res?.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  æ³¨æ–‡è©³ç´°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderOrderDetail() {
    const orderId = this._state.selectedOrder;
    if (!orderId) return this.renderTrade();
    const orders = await API.getOrders();
    const o = (Array.isArray(orders) ? orders : []).find(x => x.order_id === orderId);
    if (!o) return UI.card('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') + `<button class="btn btn--ghost btn--full mt-1" onclick="App.navigate('trade')">â† å–å¼•ä¸€è¦§</button>`;

    let html = `<button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('trade')">â† å–å¼•ä¸€è¦§</button><h2 class="page-title">æ³¨æ–‡è©³ç´°</h2>`;
    const statusSteps = ['pending_payment', 'pending_receipt', 'confirmed'];
    const currentIdx = statusSteps.indexOf(o.status);
    html += `<div class="order-progress">
      <div class="order-progress__step ${currentIdx >= 0 ? 'order-progress__step--done' : ''}"><div class="order-progress__dot">1</div><div class="order-progress__label">äºˆç´„æ¸ˆ</div></div>
      <div class="order-progress__line ${currentIdx >= 1 ? 'order-progress__line--done' : ''}"></div>
      <div class="order-progress__step ${currentIdx >= 1 ? 'order-progress__step--done' : ''}"><div class="order-progress__dot">2</div><div class="order-progress__label">æ˜ç´°å—é ˜</div></div>
      <div class="order-progress__line ${currentIdx >= 2 ? 'order-progress__line--done' : ''}"></div>
      <div class="order-progress__step ${currentIdx >= 2 ? 'order-progress__step--done' : ''}"><div class="order-progress__dot">3</div><div class="order-progress__label">ç¢ºå®š</div></div>
    </div>`;
    html += UI.card(`<h3 class="section-title">æ³¨æ–‡æƒ…å ±</h3>${UI.confirmRow('æ³¨æ–‡ID', o.order_id)}${UI.confirmRow('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status)))}${UI.confirmRow('æ³¨æ–‡æ—¥æ™‚', Fmt.dateTime(o.created_at))}${o.payment_deadline ? UI.confirmRow('å…¥é‡‘æœŸé™', Fmt.dateTime(o.payment_deadline)) : ''}`);
    html += UI.card(`<h3 class="section-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>${UI.confirmRow('æ°å', o.user_name)}${UI.confirmRow('ã‚°ãƒ«ãƒ¼ãƒ—', o.group_id)}`);
    html += UI.card(`<h3 class="section-title">å•†å“ãƒ»é‡‘é¡</h3>${UI.confirmRow('å•†å“', o.product_name)}${UI.confirmRow('æ•°é‡', Fmt.qty(o.qty))}${UI.confirmRow('å˜ä¾¡', Fmt.yen(o.unit_price))}${UI.divider()}${UI.confirmRow('åˆè¨ˆé‡‘é¡', Fmt.yen(o.total), 'font-bold')}${o.balance_used > 0 ? `${UI.confirmRow('æ®‹é«˜å……å½“', 'âˆ’ ' + Fmt.yen(o.balance_used), 'text-green')}${UI.confirmRow('æŒ¯è¾¼é¡', Fmt.yen(o.transfer_amount), 'font-bold text-lg')}` : ''}${UI.confirmRow('æ”¯æ‰•æ–¹æ³•', o.payment_method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}${o.transfer_amount === 0 ? '<div class="success-box mt-05">æ®‹é«˜ã®ã¿ã§è³¼å…¥å®Œäº†</div>' : ''}`);
    if (o.iou_requested === 'yes') {
      html += UI.card(`<h3 class="section-title">ğŸ“„ å€Ÿç”¨æ›¸</h3>${UI.confirmRow('å¸Œæœ›', 'æœ‰ã‚Š')}${o.iou_name ? UI.confirmRow('å®›å', o.iou_name) : ''}${o.iou_address ? UI.confirmRow('ä½æ‰€', o.iou_address) : ''}${o.status === 'confirmed' ? `<button class="btn btn--primary btn--sm mt-1" onclick="AdminPages._downloadIOU('${o.order_id}')">ğŸ“„ å€Ÿç”¨æ›¸PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>` : '<div class="text-xs text-gray mt-05">â€» æ±ºæ¸ˆç¢ºå®šå¾Œã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½</div>'}`);
    }
    if (o.receipt_url) {
      html += UI.card(`<h3 class="section-title">ğŸ“ æŒ¯è¾¼æ˜ç´°</h3><div class="receipt-info"><a href="${o.receipt_url}" target="_blank" rel="noopener" class="receipt-link"><span class="receipt-link__icon">ğŸ–¼ï¸</span><span class="receipt-link__text">æ˜ç´°ã‚’è¡¨ç¤ºã™ã‚‹</span><span class="receipt-link__arrow">â†’</span></a></div>`);
    }
    if (o.status === 'pending_payment') {
      html += UI.card(`<h3 class="section-title">æ“ä½œ</h3><div class="info-box mb-1"><div class="text-xs">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥é‡‘ãƒ»æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™</div></div><button class="btn btn--outline btn--full" onclick="AdminPages._cancelOrder('${o.order_id}')">æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`);
    } else if (o.status === 'pending_receipt') {
      html += UI.card(`<h3 class="section-title">æ“ä½œ</h3><div class="info-box mb-1"><div class="text-xs">æ˜ç´°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã€‚æŒ¯è¾¼å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div></div><div class="btn-group"><button class="btn btn--primary btn--full" onclick="AdminPages._confirmOrder('${o.order_id}')">âœ… å…¥é‡‘ç¢ºèª â†’ æ³¨æ–‡ç¢ºå®š</button><button class="btn btn--outline btn--full" onclick="AdminPages._rejectReceipt('${o.order_id}')">âŒ æ˜ç´°ã‚’å·®ã—æˆ»ã—</button><button class="btn btn--ghost btn--full text-red" onclick="AdminPages._cancelOrder('${o.order_id}')">æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>`);
    } else if (o.status === 'confirmed') {
      html += UI.card('<div class="success-box">âœ… ã“ã®æ³¨æ–‡ã¯ç¢ºå®šæ¸ˆã¿ã§ã™</div>');
    } else if (o.status === 'cancelled') {
      html += UI.card('<div class="text-sm text-gray text-center">ã“ã®æ³¨æ–‡ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ</div>');
    }
    return html;
  },

  async _confirmOrder(orderId) {
    UI.confirm('å…¥é‡‘ã‚’ç¢ºèªã—ã¦æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ', async () => {
      const res = await API.updateOrder(orderId, { status: 'confirmed' });
      if (res?.success) { UI.toast('æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
      else UI.toast(res?.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },
  async _rejectReceipt(orderId) {
    UI.confirm('æ˜ç´°ã‚’å·®ã—æˆ»ã—ã¾ã™ã‹ï¼Ÿ', async () => {
      const res = await API.updateOrder(orderId, { status: 'pending_payment' });
      if (res?.success) { UI.toast('å·®ã—æˆ»ã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
      else UI.toast(res?.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },
  async _cancelOrder(orderId) {
    UI.confirm('æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ã¯å…ƒã«æˆ»ã‚Šã¾ã™ã€‚', async () => {
      const res = await API.updateOrder(orderId, { status: 'cancelled' });
      if (res?.success) { UI.toast('æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
      else UI.toast(res?.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderProducts() {
    this._state.editProduct = null;
    const products = await API.getProducts();
    const list = Array.isArray(products) ? products : [];
    let html = `<div class="flex-between mb-1"><h2 class="page-title">å•†å“ç®¡ç†</h2><button class="btn btn--primary btn--sm" onclick="AdminPages._state.editProduct='new';App.currentPage='product-edit';App.renderPage()">ï¼‹ æ–°è¦ç™»éŒ²</button></div>`;
    if (list.length === 0) return html + UI.empty('å•†å“ãŒã‚ã‚Šã¾ã›ã‚“', 'ğŸ“¦');
    list.forEach(p => {
      const linkedName = p.linked_product_id ? (list.find(x => x.product_id === p.linked_product_id)?.name || '') : '';
      html += `<div class="product-admin-card" onclick="AdminPages._state.editProduct='${p.product_id}';App.currentPage='product-edit';App.renderPage()">
        <div class="flex-between"><span class="font-bold">${p.name}</span><span>${linkedName ? UI.badge('ğŸ”— ã‚»ãƒƒãƒˆ', 'blue') + ' ' : ''}${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}</span></div>
        <div class="text-sm mt-05">${UI.confirmRow('ä»•å…¥', Fmt.yen(p.buy_price))}${UI.confirmRow('å£²å˜ä¾¡', Fmt.yen(p.base_sell_price || p.sell_price))}${UI.confirmRow('åœ¨åº«', p.remaining_qty + ' / ' + p.total_qty)}${UI.confirmRow('ç· åˆ‡', Fmt.date(p.deadline, true))}${linkedName ? UI.confirmRow('ã‚»ãƒƒãƒˆç›¸æ‰‹', linkedName) : ''}</div>
      </div>`;
    });
    return html;
  },

  async renderProductEdit() {
    const pid = this._state.editProduct;
    const isNew = pid === 'new';
    let p = { name: '', buy_price: '', total_qty: '', deadline: '', status: 'draft', linked_product_id: '' };
    const allProducts = await API.getProducts();
    const productList = Array.isArray(allProducts) ? allProducts : [];
    if (!isNew) { const data = await API.getProduct(pid); if (data && !data.error) p = data; }
    const linkableProducts = productList.filter(x => x.product_id !== pid);

    let html = `<button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('product')">â† å•†å“ä¸€è¦§</button><h2 class="page-title">${isNew ? 'å•†å“ç™»éŒ²' : 'å•†å“ç·¨é›†'}</h2>`;
    html += UI.card(`
      <div class="form-group"><label class="form-label">å•†å“å</label><input type="text" class="input" id="pe-name" value="${p.name}" placeholder="ä¾‹: CRG533"></div>
      <div class="form-group"><label class="form-label">ä»•å…¥å˜ä¾¡ (Â¥)</label><input type="number" class="input" id="pe-buyprice" value="${p.buy_price}" placeholder="14000"></div>
      <div class="form-group"><label class="form-label">å£²å˜ä¾¡ï¼ˆåŸºæº–ä¾¡æ ¼ï¼‰(Â¥)</label><input type="number" class="input" id="pe-sellprice" value="${p.base_sell_price || p.sell_price || ''}" placeholder="15000"><div class="text-xs text-gray mt-05">å„ã‚°ãƒ«ãƒ¼ãƒ—ãƒªãƒ¼ãƒ€ãƒ¼ãŒã“ã®ä¾¡æ ¼ã‚’ãƒ™ãƒ¼ã‚¹ã«èª¿æ•´ã—ã¾ã™</div></div>
      <div class="form-group"><label class="form-label">ç·æ•°é‡</label><input type="number" class="input" id="pe-qty" value="${p.total_qty}" placeholder="1000"></div>
      <div class="form-group"><label class="form-label">ç· åˆ‡æ—¥</label><input type="date" class="input" id="pe-deadline" value="${p.deadline ? p.deadline.substring(0, 10) : ''}"></div>
      <div class="form-group"><label class="form-label">ğŸ”— ã‚»ãƒƒãƒˆå•†å“ï¼ˆ1:1ç´ä»˜ã‘ï¼‰</label><select class="input" id="pe-linked"><option value="">ãªã—ï¼ˆå˜ä½“è²©å£²ï¼‰</option>${linkableProducts.map(lp => `<option value="${lp.product_id}" ${p.linked_product_id === lp.product_id ? 'selected' : ''}>${lp.name} (${Fmt.yen(lp.sell_price)})</option>`).join('')}</select><div class="text-xs text-gray mt-05">é¸æŠã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¿…ãšåŒæ•°ã‚’ã‚»ãƒƒãƒˆè³¼å…¥ã—ã¾ã™</div></div>
      ${!isNew ? `<div class="form-group"><label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select class="input" id="pe-status"><option value="draft" ${p.status === 'draft' ? 'selected' : ''}>ä¸‹æ›¸ã</option><option value="active" ${p.status === 'active' ? 'selected' : ''}>è²©å£²ä¸­</option><option value="closed" ${p.status === 'closed' ? 'selected' : ''}>ç· åˆ‡</option></select></div>` : ''}
      <button class="btn btn--primary btn--full mt-1" onclick="AdminPages._saveProduct('${pid}')">${isNew ? 'ç™»éŒ²ã™ã‚‹' : 'ä¿å­˜ã™ã‚‹'}</button>
    `);
    if (!isNew) {
      // ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ä¾¡æ ¼ã‚’ä¸¦åˆ—å–å¾—
      const [prices, groups] = await Promise.all([API.getGroupPrices(pid), API.getGroups()]);
      const priceList = Array.isArray(prices) ? prices : [];
      if (priceList.length > 0) {
        html += `<h3 class="section-title mt-2">ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ä¾¡æ ¼</h3>`;
        priceList.forEach(gp => {
          const gName = (Array.isArray(groups) ? groups : []).find(g => g.group_id === gp.group_id)?.name || gp.group_id;
          html += UI.card(`<div class="flex-between"><span class="font-bold">${gName}</span><span class="text-sm">åˆ©ç›Šç‡: ${Fmt.pct(gp.profit_rate)}</span></div><div class="flex-between mt-05"><span class="text-sm">å£²å˜ä¾¡</span><span class="font-bold">${Fmt.yen(gp.sell_price)}</span></div>`);
        });
      }
    }
    return html;
  },

  async _saveProduct(pid) {
    const name = $('#pe-name')?.value?.trim();
    const buy_price = Number($('#pe-buyprice')?.value);
    const sell_price = Number($('#pe-sellprice')?.value);
    const total_qty = Number($('#pe-qty')?.value);
    const deadline = $('#pe-deadline')?.value;
    const status = $('#pe-status')?.value;
    const linked_product_id = $('#pe-linked')?.value || '';
    if (!name) { UI.toast('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!buy_price || buy_price <= 0) { UI.toast('ä»•å…¥å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!sell_price || sell_price <= 0) { UI.toast('å£²å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (sell_price < buy_price) { UI.toast('å£²å˜ä¾¡ã¯ä»•å…¥å˜ä¾¡ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }
    let res;
    if (pid === 'new') res = await API.createProduct({ name, buy_price, sell_price, total_qty, deadline, linked_product_id });
    else res = await API.updateProduct({ productId: pid, name, buy_price, sell_price, status, deadline, total_qty, linked_product_id });
    if (res?.success) { UI.toast(pid === 'new' ? 'å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ' : 'å•†å“ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); App.navigate('product'); }
    else UI.toast(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderUsers() {
    this._state.editUser = null;
    const [users, groups] = await Promise.all([API.getUsers(), API.getGroups()]);
    const list = Array.isArray(users) ? users : [];
    const groupList = Array.isArray(groups) ? groups : [];
    let html = `<div class="flex-between mb-1"><h2 class="page-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2><button class="btn btn--primary btn--sm" onclick="AdminPages._state.editUser='new';App.currentPage='user-edit';App.renderPage()">ï¼‹ æ–°è¦ç™»éŒ²</button></div>`;
    if (list.length === 0) return html + UI.empty('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“', 'ğŸ‘¥');
    const byGroup = {};
    list.forEach(u => { const gid = u.group_id || '_none'; if (!byGroup[gid]) byGroup[gid] = []; byGroup[gid].push(u); });
    Object.keys(byGroup).forEach(gid => {
      const gName = gid === '_none' ? 'æœªæ‰€å±' : (groupList.find(g => g.group_id === gid)?.name || gid);
      html += `<h3 class="section-title">${gName}</h3>`;
      byGroup[gid].forEach(u => {
        html += `<div class="user-card" onclick="AdminPages._state.editUser='${u.user_id}';App.currentPage='user-edit';App.renderPage()">
          <div class="flex-between"><span class="font-bold">${u.name}</span>${UI.badge(u.role, u.role === 'admin' ? 'red' : u.role === 'leader' ? 'blue' : 'gray')}</div>
          <div class="text-xs text-gray">${u.login_id}${u.email ? ' / ' + u.email : ''}${u.reinvest_balance > 0 ? ' / æ®‹é«˜: ' + Fmt.yen(u.reinvest_balance) : ''}</div>
        </div>`;
      });
    });
    return html;
  },

  async renderUserEdit() {
    const uid = this._state.editUser;
    const isNew = uid === 'new';
    let u = { name: '', login_id: '', email: '', role: 'user', group_id: '' };
    const groups = await API.getGroups();
    const groupList = Array.isArray(groups) ? groups : [];
    if (!isNew) { const users = await API.getUsers(); const found = (Array.isArray(users) ? users : []).find(x => x.user_id === uid); if (found) u = found; }

    let html = `<button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('users')">â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</button><h2 class="page-title">${isNew ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†'}</h2>`;
    html += UI.card(`
      <div class="form-group"><label class="form-label">åå‰ *</label><input type="text" class="input" id="ue-name" value="${u.name}" placeholder="å±±ç”° å¤ªéƒ"></div>
      <div class="form-group"><label class="form-label">ãƒ­ã‚°ã‚¤ãƒ³ID *</label><input type="text" class="input" id="ue-loginid" value="${u.login_id}" placeholder="tanaka123"></div>
      ${isNew ? '<div class="form-group"><label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label><input type="text" class="input" id="ue-password" value="" placeholder="4æ–‡å­—ä»¥ä¸Š"></div>' : ''}
      <div class="form-group"><label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" class="input" id="ue-email" value="${u.email || ''}" placeholder="tanaka@example.com"></div>
      <div class="form-group"><label class="form-label">ãƒ­ãƒ¼ãƒ« *</label><select class="input" id="ue-role"><option value="user" ${u.role === 'user' ? 'selected' : ''}>ãƒ¦ãƒ¼ã‚¶ãƒ¼</option><option value="leader" ${u.role === 'leader' ? 'selected' : ''}>ãƒªãƒ¼ãƒ€ãƒ¼</option><option value="admin" ${u.role === 'admin' ? 'selected' : ''}>ç®¡ç†è€…</option></select></div>
      <div class="form-group"><label class="form-label">ã‚°ãƒ«ãƒ¼ãƒ—</label><select class="input" id="ue-group"><option value="">ãªã—</option>${groupList.map(g => `<option value="${g.group_id}" ${u.group_id === g.group_id ? 'selected' : ''}>${g.name}</option>`).join('')}</select></div>
      <div class="form-group"><label class="form-label"><input type="checkbox" id="ue-repeater" ${(u.is_repeater === true || u.is_repeater === 'TRUE') ? 'checked' : ''}> ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼</label></div>
      <button class="btn btn--primary btn--full mt-1" onclick="AdminPages._saveUser('${uid}')">${isNew ? 'ç™»éŒ²ã™ã‚‹' : 'ä¿å­˜ã™ã‚‹'}</button>
    `);
    if (!isNew) {
      html += UI.card(`<h3 class="section-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</h3><div class="form-group"><input type="text" class="input" id="ue-newpw" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ4æ–‡å­—ä»¥ä¸Šï¼‰"></div><button class="btn btn--outline btn--full" onclick="AdminPages._resetPw('${uid}')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>`);
      html += UI.card(`<h3 class="section-title text-red">å±é™ºãªæ“ä½œ</h3><button class="btn btn--ghost btn--full text-red" onclick="AdminPages._deleteUser('${uid}', '${u.name}')">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤</button>`);
      if (u.reinvest_balance > 0) html += UI.card(`<h3 class="section-title">é‹ç”¨æ®‹é«˜</h3>${UI.confirmRow('ç¾åœ¨ã®æ®‹é«˜', Fmt.yen(u.reinvest_balance))}`);
    }
    return html;
  },

  async _saveUser(uid) {
    const name = $('#ue-name')?.value?.trim(); const login_id = $('#ue-loginid')?.value?.trim();
    const email = $('#ue-email')?.value?.trim(); const role = $('#ue-role')?.value;
    const group_id = $('#ue-group')?.value; const is_repeater = $('#ue-repeater')?.checked;
    if (!name) { UI.toast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!login_id) { UI.toast('ãƒ­ã‚°ã‚¤ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    let res;
    if (uid === 'new') {
      const password = $('#ue-password')?.value?.trim();
      if (!password || password.length < 4) { UI.toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }
      res = await API.createUser({ name, login_id, password, email, role, group_id, is_repeater });
    } else { res = await API.updateUser({ user_id: uid, name, login_id, email, role, group_id, is_repeater }); }
    if (res?.success) { UI.toast(uid === 'new' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); App.navigate('users'); }
    else UI.toast(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  },
  async _resetPw(uid) {
    const pw = $('#ue-newpw')?.value?.trim();
    if (!pw || pw.length < 4) { UI.toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }
    UI.confirm('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ', async () => {
      const res = await API.resetPassword(uid, pw);
      if (res?.success) { UI.toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'); $('#ue-newpw').value = ''; }
      else UI.toast(res?.error || 'å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },
  async _deleteUser(uid, name) {
    UI.confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`, async () => {
      const res = await API.deleteUser(uid);
      if (res?.success) { UI.toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); App.navigate('users'); }
      else UI.toast(res?.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å€Ÿç”¨æ›¸PDFï¼ˆç®¡ç†è€…ç”¨ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async _downloadIOU(orderId) {
    if (typeof UserPages._downloadIOU === 'function') await UserPages._downloadIOU(orderId);
    else UI.toast('PDFç”Ÿæˆæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  è¨­å®šï¼ˆæŒ¯è¾¼å…ˆå£åº§ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderSettings() {
    const settings = await API.getSettings();
    const s = (typeof settings === 'object' && !settings.error) ? settings : {};
    const hasBank = s.bank_name && s.bank_number;
    let html = `<button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('home')">â† ãƒ›ãƒ¼ãƒ </button><h2 class="page-title">âš™ï¸ æŒ¯è¾¼å…ˆå£åº§ã®è¨­å®š</h2>`;
    if (hasBank) {
      html += `<div class="settings-bank-preview"><div class="settings-bank-preview__title">ç¾åœ¨ã®æŒ¯è¾¼å…ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æƒ…å ±ï¼‰</div>${UI.confirmRow('éŠ€è¡Œ', s.bank_name)}${s.bank_branch ? UI.confirmRow('æ”¯åº—', s.bank_branch) : ''}${UI.confirmRow('å£åº§', (s.bank_type || 'æ™®é€š') + ' ' + s.bank_number)}${s.bank_holder ? UI.confirmRow('åç¾©', s.bank_holder) : ''}</div>`;
    } else {
      html += '<div class="warning-box mb-1">âš ï¸ æŒ¯è¾¼å…ˆå£åº§ãŒæœªè¨­å®šã§ã™ã€‚è¨­å®šã—ã¦ãã ã•ã„ã€‚</div>';
    }
    html += UI.card(`
      <h3 class="section-title">ğŸ¦ æŒ¯è¾¼å…ˆå£åº§æƒ…å ±</h3>
      <div class="text-sm text-gray mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³¼å…¥æ™‚ã«æŒ¯è¾¼å…ˆã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹æƒ…å ±ã§ã™</div>
      <div class="form-group"><label class="form-label">éŠ€è¡Œå <span class="text-red">*</span></label><input type="text" class="input" id="st-bank" value="${s.bank_name || ''}" placeholder="ä¾‹: ä¸‰è±UFJéŠ€è¡Œ"></div>
      <div class="form-group"><label class="form-label">æ”¯åº—å</label><input type="text" class="input" id="st-branch" value="${s.bank_branch || ''}" placeholder="ä¾‹: æ¸‹è°·æ”¯åº—ï¼ˆ000ï¼‰"></div>
      <div class="form-group"><label class="form-label">å£åº§ç¨®é¡</label><select class="input" id="st-type"><option value="æ™®é€š" ${(s.bank_type || 'æ™®é€š') === 'æ™®é€š' ? 'selected' : ''}>æ™®é€š</option><option value="å½“åº§" ${s.bank_type === 'å½“åº§' ? 'selected' : ''}>å½“åº§</option></select></div>
      <div class="form-group"><label class="form-label">å£åº§ç•ªå· <span class="text-red">*</span></label><input type="text" class="input" id="st-number" value="${s.bank_number || ''}" placeholder="1234567" inputmode="numeric"></div>
      <div class="form-group"><label class="form-label">å£åº§åç¾©ï¼ˆã‚«ãƒŠï¼‰</label><input type="text" class="input" id="st-holder" value="${s.bank_holder || ''}" placeholder="ä¾‹: ã‚«ï¼‰ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒ§ã‚¦ã‚¸"></div>
      <button class="btn btn--primary btn--full" onclick="AdminPages._saveSettings()">æŒ¯è¾¼å…ˆå£åº§ã‚’ä¿å­˜</button>
    `);
    return html;
  },
  async _saveSettings() {
    const bank_name = $('#st-bank')?.value?.trim(); const bank_branch = $('#st-branch')?.value?.trim();
    const bank_type = $('#st-type')?.value; const bank_number = $('#st-number')?.value?.trim(); const bank_holder = $('#st-holder')?.value?.trim();
    if (!bank_name) { UI.toast('éŠ€è¡Œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!bank_number) { UI.toast('å£åº§ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    const res = await API.saveSettings({ bank_name, bank_branch, bank_type, bank_number, bank_holder });
    if (res?.success) { UI.toast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
    else UI.toast(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  },
};

// â”€â”€ app.js â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ v3.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const App = {
  currentPage: null,
  _loadingCount: 0,

  init() {
    Auth.init();
    if (Auth.isLoggedIn()) {
      this.renderApp();
    } else {
      this.showLogin();
    }
  },

  // â”€â”€ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â”€â”€
  setLoading(on) {
    this._loadingCount += on ? 1 : -1;
    if (this._loadingCount < 0) this._loadingCount = 0;
    const el = $('#global-loading');
    if (el) el.style.display = this._loadingCount > 0 ? 'flex' : 'none';
  },

  // â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ â”€â”€
  showLogin() {
    $('#app').innerHTML = `
      <div class="login-screen">
        <div class="login-card">
          <div class="login-logo">å‡ºè³‡ç®¡ç†</div>
          <div class="login-subtitle">Investment Management System</div>
          <div id="login-error" class="login-error"></div>
          <div class="form-group">
            <label class="form-label">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
            <input type="text" id="login-id" class="input" placeholder="IDã‚’å…¥åŠ›" autocomplete="username">
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="login-pw" class="input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password">
          </div>
          <button id="login-btn" class="btn btn--primary btn--full btn--lg" onclick="App.doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
      </div>`;
    const pw = $('#login-pw');
    const id = $('#login-id');
    if (pw) pw.addEventListener('keydown', e => { if (e.key === 'Enter') App.doLogin(); });
    if (id) { id.addEventListener('keydown', e => { if (e.key === 'Enter') pw?.focus(); }); id.focus(); }
  },

  async doLogin() {
    const loginId = $('#login-id')?.value?.trim();
    const password = $('#login-pw')?.value?.trim();
    const errEl = $('#login-error');
    const btn = $('#login-btn');

    if (!loginId || !password) {
      if (errEl) { errEl.textContent = 'IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; errEl.style.display = 'block'; }
      return;
    }

    btn.disabled = true;
    btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
    const res = await API.login(loginId, password);
    btn.disabled = false;
    btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';

    if (res?.success) {
      Auth.setSession(res.token, res.user);
      API.clearCache();
      this.renderApp();
    } else {
      if (errEl) { errEl.textContent = res?.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ'; errEl.style.display = 'block'; }
    }
  },

  doLogout() {
    UI.confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ', async () => {
      await API.logout();
      Auth.clear();
      API.clearCache();
      this.showLogin();
    });
  },

  // â”€â”€ ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€
  renderApp() {
    const role = Auth.getRole();
    const user = Auth.currentUser;

    $('#app').innerHTML = `
      <div class="app-layout">
        <header class="app-header">
          <div class="app-header__left">
            <div class="app-header__title">å‡ºè³‡ç®¡ç†</div>
            <span class="app-header__user">${user.name}${user.group_name ? ' / ' + user.group_name : ''}</span>
          </div>
          <button class="app-header__logout" onclick="App.doLogout()" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">â»</button>
        </header>
        <nav class="app-nav" id="app-nav"></nav>
        <main class="app-main">
          <div id="global-loading" class="global-loading" style="display:none">
            <div class="spinner"></div>
          </div>
          <div id="page-content"></div>
        </main>
      </div>`;

    this._renderNav(role);
    this._navigateDefault(role);
  },

  _renderNav(role) {
    const tabs = {
      user:   [
        { id: 'top',     icon: 'ğŸ›’', label: 'å•†å“' },
        { id: 'active',  icon: 'ğŸ“‹', label: 'å–å¼•ä¸­' },
        { id: 'history', icon: 'ğŸ“¦', label: 'å±¥æ­´' },
        { id: 'mypage',  icon: 'ğŸ‘¤', label: 'ãƒã‚¤ãƒšãƒ¼ã‚¸' },
      ],
      admin: [
        { id: 'home',    icon: 'ğŸ ', label: 'ãƒ›ãƒ¼ãƒ ' },
        { id: 'trade',   icon: 'ğŸ“‹', label: 'å–å¼•' },
        { id: 'product', icon: 'ğŸ“¦', label: 'å•†å“' },
        { id: 'users',   icon: 'ğŸ‘¥', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' },
      ],
      leader: [
        { id: 'price',  icon: 'ğŸ’°', label: 'ä¾¡æ ¼' },
        { id: 'status', icon: 'ğŸ“Š', label: 'çŠ¶æ³' },
        { id: 'order',  icon: 'ğŸ“‹', label: 'æ³¨æ–‡' },
        { id: 'return', icon: 'â†©ï¸', label: 'ãŠæˆ»ã—' },
      ],
    };
    const items = tabs[role] || tabs.user;
    $('#app-nav').innerHTML = items.map(t =>
      `<button class="nav-tab" data-page="${t.id}" onclick="App.navigate('${t.id}')">
        <span class="nav-tab__icon">${t.icon}</span>
        <span class="nav-tab__label">${t.label}</span>
      </button>`
    ).join('');
  },

  _navigateDefault(role) {
    const defaults = { user: 'top', admin: 'home', leader: 'price' };
    this.navigate(defaults[role] || 'top');
  },

  navigate(pageId) {
    this.currentPage = pageId;
    $$('.nav-tab').forEach(t => t.classList.toggle('nav-tab--active', t.dataset.page === pageId));
    this.renderPage();
  },

  async renderPage(opts = {}) {
    const role = Auth.getRole();
    const pageId = this.currentPage;
    const container = $('#page-content');
    if (!container) return;

    if (!opts.soft) container.innerHTML = UI.skeleton(5);

    try {
      let html = '';
      if (role === 'user') {
        switch (pageId) {
          case 'top':      html = await UserPages.renderTop(); break;
          case 'detail':   html = await UserPages.renderDetail(); break;
          case 'purchase': html = await UserPages.renderPurchase(); break;
          case 'return':   html = await UserPages.renderReturn(); break;
          case 'active':   html = await UserPages.renderActive(); break;
          case 'history':  html = await UserPages.renderHistory(); break;
          case 'mypage':   html = await UserPages.renderMyPage(); break;
          default: html = UI.empty('ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      } else if (role === 'admin') {
        switch (pageId) {
          case 'home':           html = await AdminPages.renderHome(); break;
          case 'trade':          html = await AdminPages.renderTrade(); break;
          case 'order-detail':   html = await AdminPages.renderOrderDetail(); break;
          case 'product':        html = await AdminPages.renderProducts(); break;
          case 'product-edit':   html = await AdminPages.renderProductEdit(); break;
          case 'users':          html = await AdminPages.renderUsers(); break;
          case 'user-edit':      html = await AdminPages.renderUserEdit(); break;
          case 'settings':       html = await AdminPages.renderSettings(); break;
          default: html = UI.empty('ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      } else if (role === 'leader') {
        switch (pageId) {
          case 'price':  html = await LeaderPages.renderPricing(); break;
          case 'status': html = await LeaderPages.renderStatus(); break;
          case 'order':  html = await LeaderPages.renderOrders(); break;
          case 'return': html = await LeaderPages.renderReturns(); break;
          default: html = UI.empty('ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }
      container.innerHTML = `<div class="page-content">${html}</div>`;
    } catch (err) {
      console.error('Render error:', err);
      container.innerHTML = `<div class="page-content">${UI.card(`
        <div class="text-center">
          <div class="text-red font-bold mb-05">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
          <p class="text-sm text-gray">${err.message}</p>
          <button class="btn btn--primary btn--sm mt-1" onclick="App.renderPage()">å†è©¦è¡Œ</button>
        </div>
      `)}</div>`;
    }
  },
};
// DOMContentLoaded is added by build script

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
