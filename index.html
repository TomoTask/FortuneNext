<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta name="theme-color" content="#1E40AF"><meta name="apple-mobile-web-app-capable" content="yes"><title>å‡ºè³‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title><style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å‡ºè³‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0 - Production Stylesheet
   â”€â”€â”€ PE/WEç›£ä¿®: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ»ä¿å®ˆæ€§ â”€â”€â”€
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ CSS Variables â”€â”€ */
:root {
  --c-primary: #1E40AF;
  --c-primary-light: #3B82F6;
  --c-primary-pale: #EFF6FF;
  --c-success: #059669;
  --c-success-pale: #ECFDF5;
  --c-warning: #D97706;
  --c-warning-pale: #FFFBEB;
  --c-danger: #DC2626;
  --c-danger-pale: #FEF2F2;
  --c-gray-50: #F9FAFB;
  --c-gray-100: #F3F4F6;
  --c-gray-200: #E5E7EB;
  --c-gray-300: #D1D5DB;
  --c-gray-400: #9CA3AF;
  --c-gray-500: #6B7280;
  --c-gray-600: #4B5563;
  --c-gray-700: #374151;
  --c-gray-800: #1F2937;
  --c-gray-900: #111827;
  --c-bg: #F8FAFC;
  --c-card: #FFFFFF;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
  --shadow-md: 0 4px 12px rgba(0,0,0,.08);
  --font: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
  --ease: cubic-bezier(.25,.8,.25,1);
}

/* â”€â”€ Reset â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-text-size-adjust: 100%; }
body { font-family: var(--font); background: var(--c-bg); color: var(--c-gray-900); line-height: 1.6; -webkit-font-smoothing: antialiased; }
img { max-width: 100%; display: block; }
button { font-family: inherit; cursor: pointer; border: none; background: none; }
input, select, textarea { font-family: inherit; font-size: 16px; }
a { color: var(--c-primary-light); text-decoration: none; }

/* â”€â”€ Typography â”€â”€ */
.text-xs { font-size: 11px; } .text-sm { font-size: 13px; } .text-lg { font-size: 18px; } .text-xl { font-size: 22px; } .text-2xl { font-size: 26px; } .text-3xl { font-size: 32px; }
.font-bold { font-weight: 700; } .font-medium { font-weight: 500; }
.text-gray { color: var(--c-gray-500); } .text-green { color: var(--c-success); } .text-red { color: var(--c-danger); } .text-blue { color: var(--c-primary); }
.text-center { text-align: center; } .text-right { text-align: right; }

/* â”€â”€ Spacing â”€â”€ */
.mt-05 { margin-top: 4px; } .mt-1 { margin-top: 8px; } .mt-2 { margin-top: 16px; } .mt-3 { margin-top: 24px; }
.mb-05 { margin-bottom: 4px; } .mb-1 { margin-bottom: 8px; } .mb-2 { margin-bottom: 16px; }

/* â”€â”€ Flexbox â”€â”€ */
.flex-between { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
.flex-center { display: flex; justify-content: center; align-items: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   App Layout
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.app-layout { display: flex; flex-direction: column; min-height: 100dvh; max-width: 480px; margin: 0 auto; background: var(--c-bg); }

.app-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 16px; background: var(--c-primary);
  color: white; position: sticky; top: 0; z-index: 100;
}
.app-header__title { font-size: 16px; font-weight: 800; letter-spacing: .5px; }
.app-header__user { font-size: 11px; opacity: .8; margin-left: 8px; }
.app-header__left { display: flex; align-items: center; flex-wrap: wrap; }
.app-header__logout { color: white; font-size: 18px; padding: 4px 8px; border-radius: 6px; transition: background .15s; }
.app-header__logout:hover { background: rgba(255,255,255,.15); }

.app-nav {
  display: flex; background: white; border-bottom: 1px solid var(--c-gray-200);
  position: sticky; top: 48px; z-index: 99;
}
.nav-tab {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  padding: 8px 4px 6px; font-size: 10px; color: var(--c-gray-400);
  transition: color .15s; position: relative;
}
.nav-tab__icon { font-size: 18px; margin-bottom: 2px; }
.nav-tab__label { font-weight: 600; }
.nav-tab--active { color: var(--c-primary); }
.nav-tab--active::after {
  content: ''; position: absolute; bottom: 0; left: 20%; right: 20%;
  height: 2px; background: var(--c-primary); border-radius: 1px;
}

.app-main { flex: 1; position: relative; }
.page-content { padding: 12px 16px 80px; }
.page-title { font-size: 18px; font-weight: 800; margin-bottom: 12px; color: var(--c-gray-900); }

/* â”€â”€ Global Loading â”€â”€ */
.global-loading {
  position: absolute; inset: 0; display: flex; justify-content: center;
  padding-top: 40%; background: rgba(248,250,252,.7); z-index: 50;
}
.spinner {
  width: 32px; height: 32px; border: 3px solid var(--c-gray-200);
  border-top-color: var(--c-primary); border-radius: 50%;
  animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Login
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.login-screen { min-height: 100dvh; display: flex; align-items: center; justify-content: center; padding: 16px; background: linear-gradient(135deg, #0F172A 0%, #1E3A5F 50%, #1E40AF 100%); }
.login-card { width: 100%; max-width: 360px; background: white; border-radius: 16px; padding: 32px 24px; box-shadow: var(--shadow-md); }
.login-logo { font-size: 24px; font-weight: 900; text-align: center; color: var(--c-gray-900); letter-spacing: 2px; }
.login-subtitle { font-size: 10px; text-align: center; color: var(--c-gray-400); letter-spacing: 1px; margin-bottom: 24px; }
.login-demo { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--c-gray-200); }
.demo-accounts { display: flex; flex-wrap: wrap; gap: 4px; }
.demo-btn { font-size: 11px; padding: 4px 10px; background: var(--c-gray-100); border-radius: 6px; color: var(--c-gray-600); transition: all .15s; }
.demo-btn:hover { background: var(--c-primary-pale); color: var(--c-primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Components
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Card â”€â”€ */
.card { background: var(--c-card); border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,.03); }

/* â”€â”€ Buttons â”€â”€ */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 700; transition: all .15s var(--ease); }
.btn--primary { background: var(--c-primary); color: white; }
.btn--primary:hover { background: #1E3A8A; }
.btn--primary:active { transform: scale(.97); }
.btn--primary:disabled { opacity: .5; cursor: not-allowed; }
.btn--outline { border: 1.5px solid var(--c-primary); color: var(--c-primary); background: white; }
.btn--outline:hover { background: var(--c-primary-pale); }
.btn--ghost { color: var(--c-gray-500); font-weight: 600; padding: 6px 12px; }
.btn--ghost:hover { color: var(--c-gray-900); background: var(--c-gray-100); border-radius: var(--radius-sm); }
.btn--full { width: 100%; }
.btn--sm { font-size: 12px; padding: 6px 14px; }
.btn--xs { font-size: 11px; padding: 4px 10px; }
.btn-group { display: flex; flex-direction: column; gap: 6px; }

/* â”€â”€ Form â”€â”€ */
.form-group { margin-bottom: 12px; }
.form-label { display: block; font-size: 12px; font-weight: 700; color: var(--c-gray-600); margin-bottom: 4px; }
.input { width: 100%; padding: 10px 12px; border: 1.5px solid var(--c-gray-200); border-radius: var(--radius-sm); font-size: 15px; background: white; transition: border-color .15s; }
.input:focus { outline: none; border-color: var(--c-primary-light); box-shadow: 0 0 0 3px rgba(59,130,246,.1); }
select.input { appearance: none; background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M6 8L1 3h10z' fill='%236B7280'/%3E%3C/svg%3E") no-repeat right 12px center; padding-right: 32px; }

/* â”€â”€ Badge â”€â”€ */
.badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; }
.badge--success { background: var(--c-success-pale); color: var(--c-success); }
.badge--warning { background: var(--c-warning-pale); color: var(--c-warning); }
.badge--info { background: var(--c-primary-pale); color: var(--c-primary); }
.badge--gray { background: var(--c-gray-100); color: var(--c-gray-500); }
.badge--red { background: var(--c-danger-pale); color: var(--c-danger); }
.badge--green { background: var(--c-success-pale); color: var(--c-success); }
.badge--purple { background: #F3E8FF; color: #7C3AED; }
.badge--gold { background: #FFFBEB; color: #B45309; }

/* â”€â”€ Stats â”€â”€ */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.stat-card { background: white; border-radius: var(--radius); padding: 12px 14px; box-shadow: var(--shadow); border-left: 3px solid var(--c-gray-300); }
.stat-card--blue { border-left-color: var(--c-primary-light); }
.stat-card--green { border-left-color: var(--c-success); }
.stat-card--purple { border-left-color: #7C3AED; }
.stat-card--gold { border-left-color: #F59E0B; }
.stat-card--red { border-left-color: var(--c-danger); }
.stat-card__label { font-size: 11px; color: var(--c-gray-500); font-weight: 600; }
.stat-card__value { font-size: 22px; font-weight: 800; color: var(--c-gray-900); margin-top: 2px; }
.stat-card__sub { font-size: 10px; color: var(--c-gray-400); margin-top: 2px; }

/* â”€â”€ Table â”€â”€ */
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 12px; }
.table { width: 100%; border-collapse: collapse; font-size: 13px; }
.table th { text-align: left; padding: 8px 10px; background: var(--c-gray-50); color: var(--c-gray-500); font-weight: 700; font-size: 11px; border-bottom: 1px solid var(--c-gray-200); white-space: nowrap; }
.table td { padding: 8px 10px; border-bottom: 1px solid var(--c-gray-100); vertical-align: middle; }
.table--compact th, .table--compact td { padding: 6px 8px; font-size: 12px; }

/* â”€â”€ Confirm Row â”€â”€ */
.confirm-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; }
.confirm-row__label { color: var(--c-gray-500); }
.confirm-row__value { font-weight: 600; color: var(--c-gray-900); text-align: right; }

/* â”€â”€ Divider â”€â”€ */
.divider { height: 1px; background: var(--c-gray-200); margin: 10px 0; }

/* â”€â”€ Empty State â”€â”€ */
.empty-state { text-align: center; padding: 40px 20px; }
.empty-state__icon { font-size: 40px; margin-bottom: 8px; }
.empty-state__text { color: var(--c-gray-400); font-size: 14px; }

/* â”€â”€ Skeleton â”€â”€ */
.skeleton { padding: 16px; }
.skeleton__line { height: 14px; background: linear-gradient(90deg, var(--c-gray-100) 25%, var(--c-gray-200) 50%, var(--c-gray-100) 75%); background-size: 200% 100%; border-radius: 4px; margin-bottom: 12px; animation: shimmer 1.5s infinite; }
.skeleton__line:nth-child(2) { width: 85%; } .skeleton__line:nth-child(3) { width: 70%; }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

/* â”€â”€ Step Indicator â”€â”€ */
.step-indicator { display: flex; align-items: center; justify-content: center; gap: 0; padding: 8px 0 16px; }
.step-dot { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; background: var(--c-gray-200); color: var(--c-gray-400); }
.step-dot--active { background: var(--c-primary); color: white; }
.step-dot--done { background: var(--c-success); color: white; font-size: 13px; }
.step-line { width: 24px; height: 2px; background: var(--c-gray-200); }

/* â”€â”€ Toast â”€â”€ */
.toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
  padding: 10px 20px; border-radius: 10px; background: var(--c-gray-800); color: white;
  font-size: 13px; font-weight: 600; z-index: 999; opacity: 0;
  transition: all .3s var(--ease); box-shadow: var(--shadow-md); white-space: nowrap;
}
.toast--show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast--error { background: var(--c-danger); }

/* â”€â”€ Modal â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.3); z-index: 200;
  display: flex; align-items: center; justify-content: center; padding: 16px;
  opacity: 0; transition: opacity .2s;
}
.modal-overlay--show { opacity: 1; }
.modal { background: white; border-radius: 16px; padding: 24px; max-width: 340px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,.15); }
.modal__body { font-size: 15px; line-height: 1.6; margin-bottom: 16px; }
.modal__actions { display: flex; gap: 8px; }
.modal__actions .btn { flex: 1; }

/* â”€â”€ Info/Success Box â”€â”€ */
.info-box { background: var(--c-primary-pale); border: 1px solid #BFDBFE; border-radius: var(--radius-sm); padding: 10px 14px; }
.success-box { background: var(--c-success-pale); border: 1px solid #A7F3D0; border-radius: var(--radius-sm); padding: 10px 14px; font-size: 13px; font-weight: 600; color: var(--c-success); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Business Components
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Product Card â”€â”€ */
.product-card {
  background: white; border-radius: var(--radius); padding: 14px 16px;
  margin-bottom: 10px; box-shadow: var(--shadow); cursor: pointer;
  border: 1px solid transparent; transition: all .15s var(--ease);
}
.product-card:hover { border-color: var(--c-primary-light); box-shadow: var(--shadow-md); }
.product-card--closed { opacity: .5; cursor: default; }
.product-card--closed:hover { border-color: transparent; box-shadow: var(--shadow); }
.product-card__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.product-card__name { font-size: 16px; font-weight: 800; }
.product-card__body { display: flex; align-items: baseline; gap: 8px; }
.product-card__price { font-size: 22px; font-weight: 900; color: var(--c-gray-900); }
.product-card__unit { font-size: 12px; font-weight: 500; color: var(--c-gray-400); }
.product-card__profit { font-size: 14px; font-weight: 800; color: var(--c-success); }
.product-card__footer { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--c-gray-400); }

/* â”€â”€ Product Admin Card â”€â”€ */
.product-admin-card { background: white; border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px; box-shadow: var(--shadow); cursor: pointer; transition: all .15s; }
.product-admin-card:hover { box-shadow: var(--shadow-md); }

/* â”€â”€ Quantity Selector â”€â”€ */
.qty-selector { display: flex; align-items: center; justify-content: center; gap: 12px; }
.qty-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--c-gray-100); font-size: 20px; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: all .15s; }
.qty-btn:hover { background: var(--c-primary-pale); color: var(--c-primary); }
.qty-input { width: 70px; text-align: center; font-size: 22px; font-weight: 800; border: 2px solid var(--c-gray-200); border-radius: var(--radius-sm); padding: 6px; }
.qty-input:focus { border-color: var(--c-primary-light); outline: none; }

/* â”€â”€ Section Title â”€â”€ */
.section-title { font-size: 14px; font-weight: 800; color: var(--c-gray-800); margin-bottom: 8px; }

/* â”€â”€ Balance Banner â”€â”€ */
.balance-banner {
  background: linear-gradient(135deg, #065F46, #047857);
  color: white; border-radius: var(--radius); padding: 16px;
  margin-bottom: 12px; box-shadow: var(--shadow);
}
.balance-banner__amount { font-size: 28px; font-weight: 900; }
.balance-banner__label { font-size: 11px; opacity: .8; margin-top: 4px; }

/* â”€â”€ Balance Status â”€â”€ */
.balance-status { background: var(--c-gray-50); border-radius: var(--radius-sm); padding: 8px 12px; }
.balance-status__row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
.balance-status__row--green { color: var(--c-success); }

/* â”€â”€ Amount Input â”€â”€ */
.amount-input-wrap { display: flex; align-items: center; gap: 4px; }
.amount-prefix { font-size: 16px; font-weight: 700; color: var(--c-gray-500); }
.input--amount { font-size: 20px; font-weight: 800; text-align: right; max-width: 180px; }
.range-slider { width: 100%; margin: 6px 0; accent-color: var(--c-primary); height: 6px; }
.range-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--c-gray-400); }

/* â”€â”€ Payment Breakdown â”€â”€ */
.payment-bar { display: flex; height: 10px; border-radius: 5px; overflow: hidden; }
.payment-bar__seg { min-width: 4px; transition: width .3s; }
.payment-bar__seg--green { background: var(--c-success); }
.payment-bar__seg--blue { background: var(--c-primary-light); }

.payment-split { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
.payment-split__item { padding: 10px; border-radius: var(--radius-sm); text-align: center; }
.payment-split__item--green { background: var(--c-success-pale); color: var(--c-success); }
.payment-split__item--blue { background: var(--c-primary-pale); color: var(--c-primary); }
.payment-split__item--teal { background: #F0FDFA; color: #0D9488; }

/* â”€â”€ Reinvest Bar â”€â”€ */
.reinvest-bar { display: flex; height: 10px; border-radius: 5px; overflow: hidden; }
.reinvest-bar__return { background: var(--c-success); min-width: 4px; transition: width .3s; }
.reinvest-bar__keep { background: #0D9488; min-width: 4px; transition: width .3s; }

/* â”€â”€ Balance Deduct â”€â”€ */
.balance-deduct { display: flex; justify-content: space-between; background: var(--c-success-pale); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 13px; color: var(--c-success); }

/* â”€â”€ Bank Info â”€â”€ */
.bank-info .confirm-row { border-bottom: 1px solid var(--c-gray-100); }
.bank-info .confirm-row:last-child { border-bottom: none; }

/* â”€â”€ Choice Group â”€â”€ */
.choice-group { display: flex; flex-direction: column; gap: 8px; }
.choice-btn {
  width: 100%; text-align: left; padding: 14px 16px;
  background: white; border: 2px solid var(--c-gray-200);
  border-radius: var(--radius); transition: all .15s var(--ease);
}
.choice-btn:hover { border-color: var(--c-primary-light); background: var(--c-primary-pale); }
.choice-btn__title { font-size: 15px; font-weight: 700; }
.choice-btn__desc { font-size: 12px; color: var(--c-gray-500); margin-top: 2px; }

/* â”€â”€ Order Card â”€â”€ */
.order-card { background: white; border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px; box-shadow: var(--shadow); }
.order-card__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.order-card__name { font-weight: 700; }
.order-card__actions { margin-top: 8px; display: flex; gap: 6px; }

/* â”€â”€ Thread Card â”€â”€ */
.thread-card {
  background: white; border-radius: var(--radius); padding: 14px 16px;
  margin-bottom: 8px; box-shadow: var(--shadow); cursor: pointer;
  transition: all .15s var(--ease);
}
.thread-card:hover { box-shadow: var(--shadow-md); }
.thread-card__title { font-size: 14px; font-weight: 700; }
.thread-card__preview { font-size: 12px; color: var(--c-gray-500); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.thread-card__time { font-size: 10px; color: var(--c-gray-400); margin-top: 4px; }

/* â”€â”€ Chat â”€â”€ */
.chat-messages { max-height: 50vh; overflow-y: auto; padding: 8px 0; }
.chat-msg { margin-bottom: 10px; max-width: 80%; }
.chat-msg--mine { margin-left: auto; text-align: right; }
.chat-msg__name { font-size: 10px; color: var(--c-gray-500); margin-bottom: 2px; }
.chat-msg__bubble { display: inline-block; padding: 8px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; background: var(--c-gray-100); text-align: left; }
.chat-msg--mine .chat-msg__bubble { background: var(--c-primary); color: white; }
.chat-msg__time { font-size: 9px; color: var(--c-gray-400); margin-top: 2px; }
.chat-input { display: flex; gap: 8px; padding: 8px 0; position: sticky; bottom: 0; background: var(--c-bg); }
.chat-input .input { flex: 1; }

/* â”€â”€ User Card â”€â”€ */
.user-card { background: white; border-radius: var(--radius); padding: 12px 16px; margin-bottom: 8px; box-shadow: var(--shadow); cursor: pointer; transition: all .15s; }
.user-card:hover { box-shadow: var(--shadow-md); }
.user-card__meta { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; font-size: 11px; color: var(--c-gray-400); }

/* â”€â”€ Filter Tabs â”€â”€ */
.filter-tabs { display: flex; gap: 4px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; margin-bottom: 10px; }
.filter-tab { white-space: nowrap; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; background: var(--c-gray-100); color: var(--c-gray-500); transition: all .15s; flex-shrink: 0; }
.filter-tab--active { background: var(--c-primary); color: white; }

/* â”€â”€ Order Admin Card â”€â”€ */
.order-admin-card { background: white; border-radius: var(--radius); padding: 12px 16px; margin-bottom: 8px; box-shadow: var(--shadow); cursor: pointer; transition: all .15s; border-left: 3px solid var(--c-gray-200); }
.order-admin-card:hover { box-shadow: var(--shadow-md); }
.order-admin-card--action { border-left-color: var(--c-warning); }
.order-admin-card__body { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
.order-admin-card__footer { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; font-size: 11px; color: var(--c-gray-400); }
.ml-05 { margin-left: 4px; }

/* â”€â”€ Order Progress â”€â”€ */
.order-progress { display: flex; align-items: center; justify-content: center; gap: 0; padding: 12px 0 16px; }
.order-progress__step { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.order-progress__dot { width: 28px; height: 28px; border-radius: 50%; background: var(--c-gray-200); color: var(--c-gray-400); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; }
.order-progress__step--done .order-progress__dot { background: var(--c-success); color: white; }
.order-progress__label { font-size: 10px; color: var(--c-gray-500); font-weight: 600; }
.order-progress__step--done .order-progress__label { color: var(--c-success); }
.order-progress__line { width: 40px; height: 2px; background: var(--c-gray-200); margin-bottom: 18px; }
.order-progress__line--done { background: var(--c-success); }

/* â”€â”€ Receipt Info â”€â”€ */
.receipt-info { background: var(--c-gray-50); border-radius: var(--radius-sm); padding: 4px; }
.receipt-link { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: white; border-radius: var(--radius-sm); text-decoration: none; color: var(--c-primary); font-weight: 700; font-size: 14px; transition: background .15s; }
.receipt-link:hover { background: var(--c-primary-pale); }
.receipt-link__icon { font-size: 20px; }
.receipt-link__text { flex: 1; }
.receipt-link__arrow { color: var(--c-gray-400); }

/* â”€â”€ Status Card â”€â”€ */
.status-card { background: white; border-radius: var(--radius); padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow); }
.status-card__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.status-section { padding: 8px 0; border-top: 1px solid var(--c-gray-100); }
.status-section__title { font-size: 12px; font-weight: 700; color: var(--c-gray-600); margin-bottom: 6px; }

.status-bar-wrap { display: flex; align-items: center; gap: 10px; }
.status-bar { flex: 1; height: 8px; background: var(--c-gray-100); border-radius: 4px; overflow: hidden; }
.status-bar__fill { height: 100%; background: var(--c-primary); border-radius: 4px; transition: width .3s; }
.status-bar__label { font-size: 11px; color: var(--c-gray-500); white-space: nowrap; }

.status-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.status-chip { font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: 700; }
.status-chip--green { background: #ECFDF5; color: #059669; }
.status-chip--red { background: #FEF2F2; color: #DC2626; }
.status-chip--gold { background: #FFFBEB; color: #D97706; }

.status-users { font-size: 12px; }
.status-user-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid var(--c-gray-50); }
.status-user-row:last-child { border-bottom: none; }
.status-user-row span:first-child { flex: 1; }

.status-my-order { padding: 6px 0; border-bottom: 1px solid var(--c-gray-50); }
.status-my-order:last-child { border-bottom: none; }
.text-gold { color: #D97706; }

/* â”€â”€ Schedule Grid â”€â”€ */
.schedule-hint { background: #FEF3C7; border: 1px solid #FDE68A; border-radius: var(--radius-sm); padding: 6px 10px; font-size: 11px; font-weight: 600; color: #92400E; margin-bottom: 8px; }
.sch-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.sch-cell { border: 2px solid transparent; border-radius: 10px; padding: 8px 2px; text-align: center; transition: all .15s; background: var(--c-gray-100); position: relative; }
.sch-cell--best { background: linear-gradient(135deg, #FFFBEB, #FEF3C7); border-color: #FDE68A; }
.sch-cell--ok { background: white; border-color: var(--c-gray-200); }
.sch-cell--few { background: var(--c-gray-50); border-color: var(--c-gray-200); opacity: .5; }
.sch-cell--off { background: var(--c-gray-100); opacity: .3; border: 2px dashed var(--c-gray-300); }
.sch-cell--sel { border-color: var(--c-primary) !important; background: var(--c-primary-pale) !important; box-shadow: 0 0 0 2px rgba(37,99,235,.15); opacity: 1 !important; }
.sch-cell__star { font-size: 10px; line-height: 1; }
.sch-cell__date { font-size: 12px; font-weight: 800; color: var(--c-gray-900); }
.sch-cell__sub { font-size: 9px; color: var(--c-gray-500); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Responsive (tablet+)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 640px) {
  .app-layout { box-shadow: 0 0 40px rgba(0,0,0,.08); border-radius: 16px; margin: 16px auto; min-height: calc(100dvh - 32px); overflow: hidden; }
  .stat-grid { grid-template-columns: repeat(3, 1fr); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Print
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  .app-header, .app-nav, .btn, .chat-input { display: none !important; }
  .app-main { padding-top: 0; }
  .card { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
}
</style></head><body><div id="app"></div><script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  è¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
  // â˜… GASãƒ‡ãƒ—ãƒ­ã‚¤URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ã“ã“ã‚’æ›¸ãæ›ãˆï¼‰
  API_URL: 'https://script.google.com/macros/s/AKfycbzD5_qptnAccJnW8XzEgGxbW_7Rz1BT9SpzovLpxMzXEIL9emSGgag-1fZXtxgMFxmx1A/exec',

  PAYMENT_DEADLINE_DAYS: 2,
  CACHE_TTL_MS: 5 * 60 * 1000,
  
  // æŒ¯è¾¼å…ˆæƒ…å ±ï¼ˆå®Ÿéš›ã®å£åº§ã«æ›¸ãæ›ãˆï¼‰
  BANK_INFO: {
    bank: 'â—‹â—‹éŠ€è¡Œ',
    branch: 'â–³â–³æ”¯åº—ï¼ˆ000ï¼‰',
    type: 'æ™®é€š',
    number: '1234567',
    holder: 'ã‚«ï¼‰ã‚µãƒ³ãƒ—ãƒ«',
  },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => [...document.querySelectorAll(sel)];
function $el(tag, attrs = {}, children = []) {
  const el = document.createElement(tag);
  Object.entries(attrs).forEach(([k, v]) => {
    if (k === 'className') el.className = v;
    else if (k === 'textContent') el.textContent = v;
    else if (k === 'innerHTML') el.innerHTML = v;
    else if (k.startsWith('on')) el.addEventListener(k.slice(2).toLowerCase(), v);
    else el.setAttribute(k, v);
  });
  children.forEach(c => { if (typeof c === 'string') el.appendChild(document.createTextNode(c)); else if (c) el.appendChild(c); });
  return el;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Fmt = {
  /** é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: 1234567 â†’ "Â¥1,234,567" */
  yen(n) {
    if (n === null || n === undefined || isNaN(n)) return 'Â¥0';
    return 'Â¥' + Math.floor(Number(n)).toLocaleString('ja-JP');
  },

  /** æ•°é‡: 50 â†’ "50å€‹" */
  qty(n) { return Number(n).toLocaleString() + 'å€‹'; },

  /** ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ: 46.4 â†’ "46.4%" */
  pct(n) { return Number(n).toFixed(1) + '%'; },

  /** æ—¥ä»˜: ISO â†’ "2/10" or "2026/2/10" */
  date(s, full = false) {
    if (!s) return '-';
    const d = new Date(s);
    if (isNaN(d)) return '-';
    return full ? `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}` : `${d.getMonth() + 1}/${d.getDate()}`;
  },

  /** æ—¥æ™‚: ISO â†’ "2/10 14:30" */
  dateTime(s) {
    if (!s) return '-';
    const d = new Date(s);
    if (isNaN(d)) return '-';
    return `${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
  },

  /** ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ« */
  orderStatus(s) {
    const map = { pending_payment: 'å…¥é‡‘å¾…ã¡', pending_receipt: 'æ˜ç´°ç¢ºèªä¸­', confirmed: 'ç¢ºå®š', cancelled: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' };
    return map[s] || s;
  },
  returnStatus(s) {
    const map = { unprocessed: 'æœªå‡¦ç†', applied: 'ç”³è«‹æ¸ˆ', processing: 'å‡¦ç†ä¸­', remitted: 'é€é‡‘æ¸ˆ', handed: 'æ‰‹æ¸¡ã—æ¸ˆ' };
    return map[s] || s;
  },
  productStatus(s) {
    const map = { draft: 'ä¸‹æ›¸ã', active: 'è²©å£²ä¸­', closed: 'ç· åˆ‡', completed: 'å®Œäº†' };
    return map[s] || s;
  },
  statusColor(s) {
    const map = {
      pending_payment: 'warning', pending_receipt: 'info', confirmed: 'success', cancelled: 'gray',
      unprocessed: 'warning', applied: 'info', processing: 'info', remitted: 'success', handed: 'success',
      active: 'success', closed: 'gray', draft: 'warning',
    };
    return map[s] || 'gray';
  },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const UI = {
  /** ã‚«ãƒ¼ãƒ‰ */
  card(content, cls = '') {
    return `<div class="card ${cls}">${content}</div>`;
  },

  /** ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
  section(title, subtitle = '') {
    return `<h3 class="section-title">${title}</h3>${subtitle ? `<p class="text-sm text-gray">${subtitle}</p>` : ''}`;
  },

  /** ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
  badge(text, color = 'gray') {
    return `<span class="badge badge--${color}">${text}</span>`;
  },

  /** çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
  stat(label, value, sub = '', color = '') {
    return `<div class="stat-card ${color ? 'stat-card--' + color : ''}">
      <div class="stat-card__label">${label}</div>
      <div class="stat-card__value">${value}</div>
      ${sub ? `<div class="stat-card__sub">${sub}</div>` : ''}
    </div>`;
  },

  /** 2åˆ—çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ */
  statGrid(items) {
    return `<div class="stat-grid">${items.join('')}</div>`;
  },

  /** ç©ºçŠ¶æ…‹ */
  empty(msg, icon = 'ğŸ“­') {
    return `<div class="empty-state"><div class="empty-state__icon">${icon}</div><div class="empty-state__text">${msg}</div></div>`;
  },

  /** ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚±ãƒ«ãƒˆãƒ³ */
  skeleton(lines = 3) {
    return `<div class="skeleton">${Array(lines).fill('<div class="skeleton__line"></div>').join('')}</div>`;
  },

  /** ãƒ†ãƒ¼ãƒ–ãƒ« */
  table(headers, rows, opts = {}) {
    const ths = headers.map(h => typeof h === 'string' ? `<th>${h}</th>` : `<th class="${h.cls || ''}">${h.label}</th>`).join('');
    const trs = rows.map(r => `<tr>${r.map((c, i) => `<td class="${headers[i]?.cls || ''}">${c}</td>`).join('')}</tr>`).join('');
    return `<div class="table-wrap"><table class="table ${opts.compact ? 'table--compact' : ''}"><thead><tr>${ths}</tr></thead><tbody>${trs.length ? trs : `<tr><td colspan="${headers.length}" class="text-center text-gray">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`}</tbody></table></div>`;
  },

  /** ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
  steps(current, total) {
    return `<div class="step-indicator">${Array.from({ length: total }, (_, i) => {
      const n = i + 1;
      const cls = n < current ? 'step-dot--done' : n === current ? 'step-dot--active' : '';
      const label = n < current ? 'âœ“' : n;
      return (i > 0 ? '<span class="step-line"></span>' : '') + `<span class="step-dot ${cls}">${label}</span>`;
    }).join('')}</div>`;
  },

  /** ç¢ºèªè¡Œ */
  confirmRow(label, value, cls = '') {
    return `<div class="confirm-row ${cls}"><span class="confirm-row__label">${label}</span><span class="confirm-row__value">${value}</span></div>`;
  },

  /** åŒºåˆ‡ã‚Šç·š */
  divider() { return '<div class="divider"></div>'; },

  /** ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
  toast(msg, type = 'success') {
    const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸', warning: 'âš ï¸' };
    const el = document.createElement('div');
    el.className = `toast toast--${type}`;
    el.innerHTML = `${icons[type] || ''} ${msg}`;
    document.body.appendChild(el);
    requestAnimationFrame(() => el.classList.add('toast--show'));
    setTimeout(() => { el.classList.remove('toast--show'); setTimeout(() => el.remove(), 300); }, 2500);
  },

  /** ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
  confirm(msg, onOk, onCancel = null) {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.innerHTML = `
      <div class="modal">
        <div class="modal__body">${msg}</div>
        <div class="modal__actions">
          <button class="btn btn--ghost modal__cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn--primary modal__ok">OK</button>
        </div>
      </div>`;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => overlay.classList.add('modal-overlay--show'));
    overlay.querySelector('.modal__ok').onclick = () => { overlay.remove(); onOk(); };
    overlay.querySelector('.modal__cancel').onclick = () => { overlay.remove(); onCancel?.(); };
    overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.remove(); onCancel?.(); } });
  },

  /** ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ä»˜ãï¼‰ */
  pageHeader(title, backFn = null) {
    return `${backFn ? `<button class="btn btn--ghost btn--sm mb-1" onclick="${backFn}">â† æˆ»ã‚‹</button>` : ''}<h2 class="page-title">${title}</h2>`;
  },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæœ¬ç•ªå¯¾å¿œï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const Auth = {
  currentUser: null,
  _token: null,

  init() {
    const saved = localStorage.getItem('auth_token');
    const user = localStorage.getItem('auth_user');
    if (saved && user) {
      this._token = saved;
      try { this.currentUser = JSON.parse(user); } catch (_) { this.clear(); }
    }
  },

  isLoggedIn() { return !!this._token && !!this.currentUser; },
  getToken()   { return this._token; },
  getRole()    { return this.currentUser?.role || ''; },
  getGroupId() { return this.currentUser?.group_id || ''; },
  getUserId()  { return this.currentUser?.user_id || ''; },
  getGroupName() { return this.currentUser?.group_name || ''; },

  setSession(token, user) {
    this._token = token;
    this.currentUser = user;
    localStorage.setItem('auth_token', token);
    localStorage.setItem('auth_user', JSON.stringify(user));
  },

  clear() {
    this._token = null;
    this.currentUser = null;
    localStorage.removeItem('auth_token');
    localStorage.removeItem('auth_user');
  },

  /** ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æœ€æ–°ã«æ›´æ–° */
  async refreshUser() {
    if (!this._token) return;
    const res = await API.call('me');
    if (res?.success && res.user) {
      this.currentUser = { ...this.currentUser, ...res.user };
      localStorage.setItem('auth_user', JSON.stringify(this.currentUser));
    }
  },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APIé€šä¿¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæœ¬ç•ªå°‚ç”¨ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API = {
  _cache: new Map(),

  /** GAS APIã‚’å‘¼ã³å‡ºã™ */
  async call(action, params = {}) {
    return this._fetch(action, params);
  },

  /** HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ */
  async _fetch(action, params) {
    const token = Auth.getToken();
    const body = { ...params, action, token };

    try {
      App.setLoading(true);

      const res = await fetch(CONFIG.API_URL, {
        method: 'POST',
        redirect: 'follow',
        body: JSON.stringify(body),
        headers: { 'Content-Type': 'text/plain' },
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ
      if (data.code === 'AUTH_REQUIRED') {
        Auth.clear();
        App.showLogin();
        return data;
      }
      return data;
    } catch (err) {
      console.error('API Error:', err);
      return { success: false, error: 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' };
    } finally {
      App.setLoading(false);
    }
  },

  /** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãå‘¼ã³å‡ºã— */
  async cachedCall(action, params = {}) {
    const key = action + JSON.stringify(params);
    const cached = this._cache.get(key);
    if (cached && Date.now() - cached.time < CONFIG.CACHE_TTL_MS) return cached.data;
    const data = await this.call(action, params);
    this._cache.set(key, { data, time: Date.now() });
    return data;
  },

  clearCache() { this._cache.clear(); },

  // â”€â”€ ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ â”€â”€
  async login(loginId, password)     { return this.call('login', { loginId, password }); },
  async logout()                     { return this.call('logout'); },
  async getProducts()                { return this.cachedCall('getProducts'); },
  async getProduct(productId)        { return this.call('getProduct', { productId }); },
  async createProduct(data)          { this.clearCache(); return this.call('createProduct', data); },
  async updateProduct(data)          { this.clearCache(); return this.call('updateProduct', data); },
  async getGroupPrices(productId)    { return this.call('getGroupPrices', { productId }); },
  async updateGroupPrice(data)       { return this.call('updateGroupPrice', data); },
  async getOrders(filters = {})      { return this.call('getOrders', filters); },
  async createOrder(data)            { this.clearCache(); return this.call('createOrder', data); },
  async updateOrder(orderId, data)   { return this.call('updateOrder', { orderId, ...data }); },
  async getReturns(filters = {})     { return this.call('getReturns', filters); },
  async createReturn(data)           { this.clearCache(); return this.call('createReturn', data); },
  async updateReturn(returnId, data) { return this.call('updateReturn', { returnId, ...data }); },
  async getThreads()                 { return this.call('getThreads'); },
  async getMessages(threadId)        { return this.call('getMessages', { threadId }); },
  async sendMessage(data)            { return this.call('sendMessage', data); },
  async getDashboard()               { return this.cachedCall('getDashboard'); },
  async getUsers()                   { return this.call('getUsers'); },
  async getGroups()                  { return this.cachedCall('getGroups'); },
  async getSchedule()                { return this.cachedCall('getSchedule'); },
  async createUser(data)             { this.clearCache(); return this.call('createUser', data); },
  async updateUser(data)             { this.clearCache(); return this.call('updateUser', data); },
  async resetPassword(userId, pw)    { return this.call('resetPassword', { user_id: userId, new_password: pw }); },
  async deleteUser(userId)           { this.clearCache(); return this.call('deleteUser', { user_id: userId }); },
  async uploadReceipt(data)          { return this.call('uploadReceipt', data); },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const UserPages = {
  // â”€â”€ çŠ¶æ…‹ç®¡ç† â”€â”€
  _state: {},
  _reset() {
    this._state = { selectedProduct: null, purchaseStep: 0, purchaseQty: 1, balanceUsed: 0, returnStep: 0, returnOrder: null, returnAction: null, returnAmount: 0, returnMethod: null, returnDate: null };
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  TOPç”»é¢
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderTop() {
    const products = await API.getProducts();
    const user = Auth.currentUser;
    const balance = user?.reinvest_balance || 0;

    let html = '';

    // æ®‹é«˜ã‚«ãƒ¼ãƒ‰
    if (balance > 0) {
      html += `<div class="balance-banner">
        <div class="balance-banner__amount">${Fmt.yen(balance)}</div>
        <div class="balance-banner__label">é‹ç”¨ç¶™ç¶šä¸­ã®æ®‹é«˜ â€” å•†å“è³¼å…¥æ™‚ã«å……å½“ã§ãã¾ã™</div>
      </div>`;
    }

    // å•†å“ä¸€è¦§
    const active = (Array.isArray(products) ? products : []).filter(p => p.status === 'active');
    const closed = (Array.isArray(products) ? products : []).filter(p => p.status !== 'active');

    if (active.length === 0 && closed.length === 0) {
      html += UI.empty('è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“¦');
    }

    active.forEach(p => { html += this._productCard(p, true); });

    if (closed.length > 0) {
      html += `<div class="text-xs text-gray mt-2 mb-05">éå»ã®å•†å“</div>`;
      closed.forEach(p => { html += this._productCard(p, false); });
    }

    return html;
  },

  _productCard(p, active) {
    const profit = p.profit_rate ? `+${Fmt.pct(p.profit_rate)}` : '';
    const remaining = p.remaining_qty > 0 ? `æ®‹ã‚Š${p.remaining_qty}å€‹` : 'å®Œå£²';
    return `
      <div class="product-card ${active ? '' : 'product-card--closed'}" onclick="${active ? `UserPages.goDetail('${p.product_id}')` : ''}">
        <div class="product-card__header">
          <div class="product-card__name">${p.name}</div>
          ${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}
        </div>
        <div class="product-card__body">
          <div class="product-card__price">${Fmt.yen(p.sell_price || p.buy_price)}<span class="product-card__unit">/å€‹</span></div>
          ${profit ? `<div class="product-card__profit">${profit}</div>` : ''}
        </div>
        <div class="product-card__footer">
          <span>${remaining}</span>
          <span>ã€† ${Fmt.date(p.deadline)}</span>
        </div>
      </div>`;
  },

  goDetail(productId) {
    this._reset();
    this._state.selectedProduct = productId;
    App.currentPage = 'detail';
    App.renderPage();
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“è©³ç´°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderDetail() {
    const pid = this._state.selectedProduct;
    if (!pid) return this.renderTop();
    const p = await API.getProduct(pid);
    if (!p || p.error) return UI.empty('å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    const maxQty = Math.min(p.remaining_qty, 100);
    const qty = this._state.purchaseQty;
    const total = (p.sell_price || 0) * qty;
    this._state._cachedPrice = p.sell_price || 0;

    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('top')">â† æˆ»ã‚‹</button>
      ${UI.card(`
        <h2 class="text-lg font-bold">${p.name}</h2>
        <div class="product-meta mt-1">
          ${UI.confirmRow('è²©å£²ä¾¡æ ¼', Fmt.yen(p.sell_price))}
          ${UI.confirmRow('ä»•å…¥å˜ä¾¡', Fmt.yen(p.buy_price))}
          ${UI.confirmRow('åˆ©ç›Šç‡', Fmt.pct(p.profit_rate || 0))}
          ${UI.confirmRow('æ®‹ã‚Šåœ¨åº«', Fmt.qty(p.remaining_qty))}
          ${UI.confirmRow('ç· åˆ‡', Fmt.date(p.deadline, true))}
        </div>
      `)}
      ${p.remaining_qty > 0 ? UI.card(`
        <h3 class="section-title">è³¼å…¥æ•°é‡</h3>
        <div class="qty-selector">
          <button class="qty-btn" onclick="UserPages._setQty(${qty} - 1)">âˆ’</button>
          <input type="number" class="qty-input" value="${qty}" min="1" max="${maxQty}" onchange="UserPages._setQty(Number(this.value))">
          <button class="qty-btn" onclick="UserPages._setQty(${qty} + 1)">+</button>
        </div>
        <div class="text-center mt-1">
          <div class="text-2xl font-bold qty-total-value">${Fmt.yen(total)}</div>
          <div class="text-xs text-gray qty-total-sub">${Fmt.yen(p.sell_price)} Ã— ${qty}å€‹</div>
        </div>
        <button class="btn btn--primary btn--full mt-1" onclick="UserPages._startPurchase()">è³¼å…¥æ‰‹ç¶šãã¸ â†’</button>
      `) : UI.card(`<div class="text-center text-gray">ã“ã®å•†å“ã¯å®Œå£²ã—ã¾ã—ãŸ</div>`)}`;
  },

  _setQty(n) {
    this._state.purchaseQty = Math.max(1, Math.min(n, 100));
    // DOMç›´æ¥æ›´æ–°ï¼ˆAPIå†å–å¾—ãªã—ï¼‰
    const qtyInput = document.querySelector('.qty-input');
    const totalEl = document.querySelector('.qty-total-value');
    const subEl = document.querySelector('.qty-total-sub');
    if (qtyInput) qtyInput.value = this._state.purchaseQty;
    if (totalEl && this._state._cachedPrice) {
      const total = this._state._cachedPrice * this._state.purchaseQty;
      totalEl.textContent = Fmt.yen(total);
      if (subEl) subEl.textContent = Fmt.yen(this._state._cachedPrice) + ' Ã— ' + this._state.purchaseQty + 'å€‹';
    }
  },

  _startPurchase() {
    const balance = Auth.currentUser?.reinvest_balance || 0;
    this._state.purchaseStep = balance > 0 ? 1 : 2;
    this._state.balanceUsed = 0;
    App.currentPage = 'purchase';
    App.renderPage();
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  è³¼å…¥ãƒ•ãƒ­ãƒ¼ï¼ˆ4ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderPurchase() {
    const step = this._state.purchaseStep;
    const pid = this._state.selectedProduct;
    const p = await API.getProduct(pid);
    if (!p) return UI.empty('å•†å“æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼');

    const qty = this._state.purchaseQty;
    const total = (p.sell_price || 0) * qty;
    const balance = Auth.currentUser?.reinvest_balance || 0;

    if (step === 1) return this._purchaseStepBalance(p, total, balance);
    if (step === 2) return this._purchaseStepConfirm(p, total, balance);
    if (step === 3) return this._purchaseStepDone(p, total);
    return this.renderDetail();
  },

  // Step 1: æ®‹é«˜å……å½“
  _purchaseStepBalance(p, total, balance) {
    const used = this._state.balanceUsed;
    const maxUse = Math.min(balance, total);
    const transfer = total - used;
    const balPct = total > 0 ? Math.round(used / total * 100) : 0;
    const trPct = 100 - balPct;

    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.currentPage='detail';App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(1, 3)}
      ${UI.card(`
        <h3 class="section-title">æ®‹é«˜ã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿ</h3>
        <div class="balance-status">
          <div class="balance-status__row"><span>è³¼å…¥é‡‘é¡</span><span class="font-bold">${Fmt.yen(total)}</span></div>
          <div class="balance-status__row balance-status__row--green"><span>åˆ©ç”¨å¯èƒ½æ®‹é«˜</span><span class="font-bold">${Fmt.yen(balance)}</span></div>
        </div>
        <div class="form-group mt-1">
          <label class="form-label">å……å½“ã™ã‚‹é‡‘é¡</label>
          <div class="amount-input-wrap">
            <span class="amount-prefix">Â¥</span>
            <input type="number" class="input input--amount" value="${used}" min="0" max="${maxUse}" step="1000" onchange="UserPages._setBalance(Number(this.value))">
          </div>
          <input type="range" class="range-slider" min="0" max="${maxUse}" step="1000" value="${used}" oninput="UserPages._setBalance(Number(this.value))">
          <div class="range-labels"><span>Â¥0</span><span>${Fmt.yen(maxUse)}</span></div>
          <button class="btn btn--outline btn--sm mt-05" onclick="UserPages._setBalance(${maxUse})">æ®‹é«˜ã‚’å…¨é¡ä½¿ã†</button>
        </div>
        ${used > 0 ? `
        <div class="payment-bar mt-1">
          <div class="payment-bar__seg payment-bar__seg--green" style="width:${balPct}%"></div>
          <div class="payment-bar__seg payment-bar__seg--blue" style="width:${trPct}%"></div>
        </div>
        <div class="payment-split">
          <div class="payment-split__item payment-split__item--green"><div class="text-xs">æ®‹é«˜å……å½“</div><div class="font-bold">${Fmt.yen(used)}</div></div>
          <div class="payment-split__item payment-split__item--blue"><div class="text-xs">éŠ€è¡ŒæŒ¯è¾¼</div><div class="font-bold">${Fmt.yen(transfer)}</div></div>
        </div>` : ''}
        <div class="btn-group mt-1">
          <button class="btn btn--primary btn--full" onclick="UserPages._state.purchaseStep=2;App.renderPage()">ç¢ºèªç”»é¢ã¸ â†’</button>
          <button class="btn btn--ghost btn--full" onclick="UserPages._state.balanceUsed=0;UserPages._state.purchaseStep=2;App.renderPage()">æ®‹é«˜ã‚’ä½¿ã‚ãšã«è³¼å…¥</button>
        </div>
      `)}`;
  },

  _setBalance(n) {
    const balance = Auth.currentUser?.reinvest_balance || 0;
    this._state.balanceUsed = Math.max(0, Math.min(n, balance));
    App.renderPage({ soft: true });
  },

  // Step 2: æœ€çµ‚ç¢ºèª
  _purchaseStepConfirm(p, total, balance) {
    const used = this._state.balanceUsed;
    const transfer = total - used;
    const qty = this._state.purchaseQty;
    const prevStep = balance > 0 ? 1 : 0;

    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.purchaseStep=${prevStep || 0};${prevStep ? "App.renderPage()" : "App.currentPage='detail';App.renderPage()"}">â† æˆ»ã‚‹</button>
      ${UI.steps(2, 3)}
      ${UI.card(`
        <h3 class="section-title">æ³¨æ–‡å†…å®¹ã®ç¢ºèª</h3>
        ${UI.confirmRow('å•†å“', p.name)}
        ${UI.confirmRow('æ•°é‡', Fmt.qty(qty))}
        ${UI.confirmRow('å˜ä¾¡', Fmt.yen(p.sell_price))}
        ${UI.divider()}
        ${UI.confirmRow('åˆè¨ˆé‡‘é¡', Fmt.yen(total), 'font-bold')}
        ${used > 0 ? `
          ${UI.confirmRow('ğŸ’° æ®‹é«˜å……å½“', 'âˆ’ ' + Fmt.yen(used), 'text-green')}
          ${UI.confirmRow('ğŸ¦ éŠ€è¡ŒæŒ¯è¾¼é¡', Fmt.yen(transfer), 'font-bold text-lg')}
          <div class="text-xs text-gray mt-05">å……å½“å¾Œã®æ®‹é«˜: ${Fmt.yen(balance - used)}</div>
        ` : ''}
        ${transfer > 0 ? `
          <div class="info-box mt-1">
            <div class="text-sm font-bold mb-05">ãŠæ”¯æ‰•ã„æ‰‹é †</div>
            <div class="text-xs">â‘  äºˆç´„ç¢ºå®š â†’ â‘¡ éŠ€è¡ŒæŒ¯è¾¼ï¼ˆ${Fmt.yen(transfer)}ï¼‰â†’ â‘¢ æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ â‘£ ç¢ºèª</div>
          </div>
        ` : `
          <div class="success-box mt-1">âœ… æ®‹é«˜ã®ã¿ã§è³¼å…¥å®Œäº† â€” æŒ¯è¾¼ã¯ä¸è¦ã§ã™</div>
        `}
        <button class="btn btn--primary btn--full mt-1" onclick="UserPages._confirmPurchase()">
          ${transfer > 0 ? `äºˆç´„ã‚’ç¢ºå®šã™ã‚‹ï¼ˆæŒ¯è¾¼é¡: ${Fmt.yen(transfer)}ï¼‰` : 'è³¼å…¥ã‚’ç¢ºå®šã™ã‚‹ï¼ˆæ®‹é«˜æ‰•ã„ï¼‰'}
        </button>
      `)}`;
  },

  async _confirmPurchase() {
    const pid = this._state.selectedProduct;
    const qty = this._state.purchaseQty;
    const balanceUsed = this._state.balanceUsed;

    const res = await API.createOrder({ productId: pid, qty, balanceUsed });
    if (res?.success) {
      this._state.purchaseStep = 3;
      this._state._lastOrder = res.order;
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
      if (balanceUsed > 0) {
        Auth.currentUser.reinvest_balance = Math.max(0, (Auth.currentUser.reinvest_balance || 0) - balanceUsed);
        localStorage.setItem('auth_user', JSON.stringify(Auth.currentUser));
      }
      App.renderPage();
    } else {
      UI.toast(res?.error || 'æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  },

  // Step 3: å®Œäº†
  _purchaseStepDone(p, total) {
    const order = this._state._lastOrder;
    if (!order) return UI.empty('æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    const balUsed = order.balance_used || 0;
    const transfer = order.transfer_amount || 0;
    const remainBal = Auth.currentUser?.reinvest_balance || 0;

    let html = `${UI.steps(3, 3)}`;

    html += UI.card(`
      <div class="text-center">
        <div class="text-3xl mb-05">${transfer > 0 ? 'ğŸ“‹' : 'âœ…'}</div>
        <h2 class="text-lg font-bold">${transfer > 0 ? 'äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ' : 'è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸ'}</h2>
      </div>
      ${balUsed > 0 ? `
        <div class="balance-deduct mt-1">
          <span>æ®‹é«˜ã‹ã‚‰å……å½“</span><span class="font-bold">âˆ’${Fmt.yen(balUsed)}</span>
        </div>
        <div class="text-xs text-gray text-right">æ®‹é«˜: ${Fmt.yen(remainBal)}</div>
      ` : ''}
    `);

    if (transfer > 0) {
      const bank = CONFIG.BANK_INFO;
      html += UI.card(`
        <h3 class="section-title">ğŸ¦ æŒ¯è¾¼å…ˆ</h3>
        <div class="bank-info">
          ${UI.confirmRow('æŒ¯è¾¼é¡', Fmt.yen(transfer), 'font-bold text-lg')}
          ${UI.confirmRow('éŠ€è¡Œ', bank.bank)}
          ${UI.confirmRow('æ”¯åº—', bank.branch)}
          ${UI.confirmRow('ç¨®é¡', bank.type)}
          ${UI.confirmRow('å£åº§ç•ªå·', bank.number)}
          ${UI.confirmRow('åç¾©', bank.holder)}
        </div>
        <div class="info-box mt-1">
          <div class="text-xs">æŒ¯è¾¼å¾Œã€ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰æ˜ç´°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</div>
        </div>
      `);
    } else {
      html += UI.card(`<div class="success-box">âœ… æ®‹é«˜ã®ã¿ã§è³¼å…¥å®Œäº†ã—ã¾ã—ãŸã€‚æŒ¯è¾¼ã¯ä¸è¦ã§ã™ã€‚</div>`);
    }

    html += `<button class="btn btn--primary btn--full mt-1" onclick="App.navigate('top')">TOPã«æˆ»ã‚‹</button>`;
    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãŠæˆ»ã—ãƒ•ãƒ­ãƒ¼
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  goReturn(orderId) {
    this._reset();
    this._state.returnOrder = orderId;
    this._state.returnStep = 1;
    App.currentPage = 'return';
    App.renderPage();
  },

  async renderReturn() {
    const step = this._state.returnStep;
    if (step === 1) return this._returnStep1();
    if (step === 2) return this._returnStep2();
    if (step === 3) return this._returnStep3();
    if (step === 4) return this._returnStep4();
    if (step === 5) return this._returnStep5();
    return UI.empty('ä¸æ˜ãªã‚¹ãƒ†ãƒƒãƒ—');
  },

  // Step 1: å…¨é¡ or ä¸€éƒ¨
  async _returnStep1() {
    const orders = await API.getOrders();
    const order = (Array.isArray(orders) ? orders : []).find(o => o.order_id === this._state.returnOrder && o.status === 'confirmed');
    if (!order) return UI.card('ãŠæˆ»ã—å¯¾è±¡ã®æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') + `<button class="btn btn--ghost btn--full mt-1" onclick="App.navigate('mypage')">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸</button>`;

    const product = await API.getProduct(order.product_id);
    const profitRate = product ? (order.unit_price - product.buy_price) / product.buy_price : 0.35;
    const profit = Math.round(order.total * profitRate);
    const totalAmount = order.total + profit;
    this._state._totalAmount = totalAmount;
    this._state._profit = profit;
    this._state._orderTotal = order.total;
    this._state._productName = product?.name || order.product_name || '';

    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('mypage')">â† æˆ»ã‚‹</button>
      ${UI.steps(1, 4)}
      ${UI.card(`
        <h3 class="section-title">Step 1: ãŠæˆ»ã—æ–¹æ³•</h3>
        <div class="text-sm text-gray mb-1">${this._state._productName} (${Fmt.qty(order.qty)})</div>
        ${UI.confirmRow('å…ƒæœ¬', Fmt.yen(order.total))}
        ${UI.confirmRow('åˆ©ç›Š', '+' + Fmt.yen(profit))}
        ${UI.divider()}
        ${UI.confirmRow('ãŠæˆ»ã—ç·é¡', Fmt.yen(totalAmount), 'font-bold')}
        <div class="choice-group mt-1">
          <button class="choice-btn" onclick="UserPages._state.returnAction='full';UserPages._state.returnAmount=${totalAmount};UserPages._state.returnStep=3;App.renderPage()">
            <div class="choice-btn__title">å…¨é¡ã‚’å—ã‘å–ã‚‹</div>
            <div class="choice-btn__desc">${Fmt.yen(totalAmount)} ã‚’å…¨é¡å—å–</div>
          </button>
          <button class="choice-btn" onclick="UserPages._state.returnAction='partial';UserPages._state.returnStep=2;App.renderPage()">
            <div class="choice-btn__title">ä¸€éƒ¨ã‚’å—ã‘å–ã‚‹</div>
            <div class="choice-btn__desc">å—å–é¡ã‚’æŒ‡å®šã€æ®‹ã‚Šã¯é‹ç”¨ç¶™ç¶š</div>
          </button>
        </div>
      `)}`;
  },

  // Step 2: ä¸€éƒ¨å—å–é¡å…¥åŠ›
  _returnStep2() {
    const totalAmount = this._state._totalAmount;
    const amt = this._state.returnAmount || Math.round(totalAmount / 2);
    const keep = totalAmount - amt;
    const pct = Math.round(amt / totalAmount * 100);

    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.returnStep=1;App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(2, 4)}
      ${UI.card(`
        <h3 class="section-title">Step 2: å—å–é¡ã‚’å…¥åŠ›</h3>
        <div class="text-sm text-gray mb-1">ãŠæˆ»ã—ç·é¡: ${Fmt.yen(totalAmount)}</div>
        <div class="form-group">
          <label class="form-label">å—ã‘å–ã‚‹é‡‘é¡</label>
          <div class="amount-input-wrap">
            <span class="amount-prefix">Â¥</span>
            <input type="number" class="input input--amount" value="${amt}" min="1" max="${totalAmount}" step="10000" onchange="UserPages._state.returnAmount=Math.max(1,Math.min(Number(this.value),${totalAmount}));App.renderPage()">
          </div>
          <input type="range" class="range-slider" min="1" max="${totalAmount}" step="10000" value="${amt}" oninput="UserPages._state.returnAmount=Number(this.value);App.renderPage()">
          <div class="range-labels"><span>Â¥1</span><span>${Fmt.yen(totalAmount)}</span></div>
        </div>
        <div class="reinvest-bar">
          <div class="reinvest-bar__return" style="width:${pct}%"></div>
          <div class="reinvest-bar__keep" style="width:${100 - pct}%"></div>
        </div>
        <div class="payment-split">
          <div class="payment-split__item payment-split__item--green"><div class="text-xs">å—å–é¡</div><div class="font-bold">${Fmt.yen(amt)}</div></div>
          <div class="payment-split__item payment-split__item--teal"><div class="text-xs">é‹ç”¨ç¶™ç¶š</div><div class="font-bold">${Fmt.yen(keep)}</div></div>
        </div>
        <button class="btn btn--primary btn--full mt-1" onclick="UserPages._state.returnAmount=${amt};UserPages._state.returnStep=3;App.renderPage()">å—å–æ–¹æ³•ã®é¸æŠã¸ â†’</button>
      `)}`;
  },

  // Step 3: å—å–æ–¹æ³•
  _returnStep3() {
    const amt = this._state.returnAmount;
    return `
      <button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.returnStep=${this._state.returnAction === 'partial' ? 2 : 1};App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(3, 4)}
      ${UI.card(`
        <h3 class="section-title">Step 3: å—å–æ–¹æ³•</h3>
        <div class="text-sm text-gray mb-1">å—å–é¡: ${Fmt.yen(amt)}</div>
        <div class="choice-group">
          <button class="choice-btn" onclick="UserPages._state.returnMethod='transfer';UserPages._state.returnStep=4;App.renderPage()">
            <div class="choice-btn__title">ğŸ¦ éŠ€è¡ŒæŒ¯è¾¼</div>
            <div class="choice-btn__desc">ç™»éŒ²å£åº§ã«æŒ¯ã‚Šè¾¼ã¿</div>
          </button>
          <button class="choice-btn" onclick="UserPages._state.returnMethod='cash';UserPages._state.returnStep=4;App.renderPage()">
            <div class="choice-btn__title">ğŸ’µ ç¾é‡‘æ‰‹æ¸¡ã—</div>
            <div class="choice-btn__desc">æ—¥ç¨‹ã‚’é¸ã‚“ã§å¯¾é¢å—å–</div>
          </button>
        </div>
      `)}`;
  },

  // Step 4: æ—¥ç¨‹é¸æŠï¼ˆç¾é‡‘ã®å ´åˆï¼‰+æœ€çµ‚ç¢ºèª
  _returnStep4() {
    const isCash = this._state.returnMethod === 'cash';
    const isPartial = this._state.returnAction === 'partial';
    const amt = this._state.returnAmount;
    const keep = (this._state._totalAmount || 0) - amt;

    // æ—¥ç¨‹ãƒ‡ãƒ¼ã‚¿
    const dates = [];
    const base = new Date('2026-03-04');
    const ranks = [2, 3, 1, 0, 0, 3, 2];
    const dayNames = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    for (let i = 0; i < 7; i++) {
      const d = new Date(base); d.setDate(d.getDate() + i);
      dates.push({ date: d, rank: ranks[i], label: `${d.getMonth() + 1}/${d.getDate()}`, day: dayNames[d.getDay()] });
    }
    if (!this._state.returnDate && isCash) {
      const best = dates.find(d => d.rank === 3);
      if (best) this._state.returnDate = best.label;
    }

    let html = `
      <button class="btn btn--ghost btn--sm mb-1" onclick="UserPages._state.returnStep=3;App.renderPage()">â† æˆ»ã‚‹</button>
      ${UI.steps(4, 4)}`;

    html += UI.card(`
      <h3 class="section-title">Step 4: ${isCash ? 'æ—¥ç¨‹ã‚’é¸ã‚“ã§ç¢ºèª' : 'æœ€çµ‚ç¢ºèª'}</h3>
      ${isCash ? `
        <div class="schedule-hint">ğŸ’¡ â­ã®æ—¥ã«åˆã‚ã›ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã«ãŠæ¸¡ã—ã§ãã¾ã™</div>
        <div class="sch-grid">
          ${dates.map(d => {
            if (d.rank === 0) return `<div class="sch-cell sch-cell--off"><div class="sch-cell__date">${d.label}</div><div class="sch-cell__sub">${d.day}</div></div>`;
            const selected = this._state.returnDate === d.label;
            const cls = d.rank === 3 ? 'sch-cell--best' : d.rank === 2 ? 'sch-cell--ok' : 'sch-cell--few';
            return `<button class="sch-cell ${cls} ${selected ? 'sch-cell--sel' : ''}" onclick="UserPages._state.returnDate='${d.label}';App.renderPage()">
              ${d.rank === 3 ? '<div class="sch-cell__star">â­</div>' : ''}
              <div class="sch-cell__date">${d.label}</div>
              <div class="sch-cell__sub">${d.day}</div>
            </button>`;
          }).join('')}
        </div>
        ${UI.divider()}
      ` : ''}
      <div class="mt-05">
        ${UI.confirmRow('å•†å“', this._state._productName)}
        ${UI.confirmRow('ãŠæˆ»ã—æ–¹æ³•', this._state.returnAction === 'full' ? 'å…¨é¡å—å–' : 'ä¸€éƒ¨å—å–')}
        ${UI.confirmRow('å—å–é¡', Fmt.yen(amt), 'font-bold')}
        ${isPartial ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(keep)) : ''}
        ${UI.confirmRow('å—å–æ–¹æ³•', isCash ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}
        ${isCash ? UI.confirmRow('å¸Œæœ›æ—¥', this._state.returnDate || 'æœªé¸æŠ') : ''}
      </div>
      <button class="btn btn--primary btn--full mt-1" onclick="UserPages._submitReturn()">ãŠæˆ»ã—ç”³è«‹ã‚’ç¢ºå®šã™ã‚‹</button>
    `);

    return html;
  },

  async _submitReturn() {
    const data = {
      orderId: this._state.returnOrder,
      return_action: this._state.returnAction,
      returnAmount: this._state.returnAmount,
      method: this._state.returnMethod,
      desiredDate: this._state.returnDate || '',
    };
    const res = await API.createReturn(data);
    if (res?.success) {
      // é‹ç”¨ç¶™ç¶šåˆ†ãŒã‚ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼æ®‹é«˜æ›´æ–°
      if (res.returnData?.keep_amount > 0) {
        Auth.currentUser.reinvest_balance = (Auth.currentUser.reinvest_balance || 0) + res.returnData.keep_amount;
        localStorage.setItem('auth_user', JSON.stringify(Auth.currentUser));
      }
      this._state.returnStep = 5;
      this._state._returnResult = res.returnData;
      App.renderPage();
    } else {
      UI.toast(res?.error || 'ç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  },

  // Step 5: å®Œäº†
  _returnStep5() {
    const ret = this._state._returnResult;
    return `
      ${UI.card(`
        <div class="text-center">
          <div class="text-3xl mb-05">âœ…</div>
          <h2 class="text-lg font-bold">ãŠæˆ»ã—ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸ</h2>
        </div>
        <div class="mt-1">
          ${UI.confirmRow('å—å–é¡', Fmt.yen(ret?.return_amount))}
          ${ret?.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(ret.keep_amount)) : ''}
          ${UI.confirmRow('å—å–æ–¹æ³•', ret?.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}
          ${ret?.desired_date ? UI.confirmRow('å¸Œæœ›æ—¥', ret.desired_date) : ''}
        </div>
        <div class="info-box mt-1"><div class="text-xs">å‡¦ç†çŠ¶æ³ã¯ã€Œå•†å“çŠ¶æ³ã€ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™</div></div>
      `)}
      <button class="btn btn--primary btn--full mt-1" onclick="App.navigate('mypage')">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸</button>`;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“çŠ¶æ³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderStatus() {
    const products = await API.getProducts();
    const orders = await API.getOrders();
    const returns = await API.getReturns();
    const list = Array.isArray(products) ? products : [];
    const myOrders = Array.isArray(orders) ? orders : [];
    const myReturns = Array.isArray(returns) ? returns : [];

    let html = `<h2 class="page-title">å•†å“çŠ¶æ³</h2>`;

    if (list.length === 0) return html + UI.empty('å•†å“ãŒã‚ã‚Šã¾ã›ã‚“', 'ğŸ“Š');

    const active = list.filter(p => p.status === 'active');
    const closed = list.filter(p => p.status === 'closed');

    const renderProduct = (p) => {
      const pOrders = myOrders.filter(o => o.product_id === p.product_id);
      const pReturns = myReturns.filter(r => pOrders.some(o => o.order_id === r.order_id));

      html += `<div class="status-card">
        <div class="status-card__header">
          <span class="font-bold">${p.name}</span>
          ${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}
        </div>

        <div class="status-section">
          <div class="status-section__title">ğŸ“¦ åœ¨åº«</div>
          <div class="status-bar-wrap">
            <div class="status-bar">
              <div class="status-bar__fill" style="width:${p.total_qty > 0 ? (1 - p.remaining_qty / p.total_qty) * 100 : 0}%"></div>
            </div>
            <div class="status-bar__label">${p.remaining_qty} / ${p.total_qty} æ®‹ã‚Š</div>
          </div>
        </div>

        ${pOrders.length > 0 ? `
        <div class="status-section">
          <div class="status-section__title">ğŸ›’ ã‚ãªãŸã®æ³¨æ–‡</div>
          ${pOrders.map(o => `<div class="status-my-order">
            <div class="flex-between">
              <span>${Fmt.qty(o.qty)} / ${Fmt.yen(o.total)}</span>
              ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
            </div>
            ${o.status === 'pending_payment' ? '<div class="text-xs text-red mt-05">æŒ¯è¾¼ãƒ»æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠé¡˜ã„ã—ã¾ã™</div>' : ''}
            ${o.status === 'pending_receipt' ? '<div class="text-xs text-gold mt-05">ç®¡ç†è€…ãŒæ˜ç´°ã‚’ç¢ºèªä¸­ã§ã™</div>' : ''}
            ${o.status === 'confirmed' ? '<div class="text-xs text-green mt-05">å…¥é‡‘ç¢ºèªæ¸ˆã¿</div>' : ''}
          </div>`).join('')}
        </div>` : `
        <div class="status-section">
          <div class="text-xs text-gray">ã¾ã æ³¨æ–‡ã—ã¦ã„ã¾ã›ã‚“</div>
        </div>`}

        ${pReturns.length > 0 ? `
        <div class="status-section">
          <div class="status-section__title">â†©ï¸ ãŠæˆ»ã—</div>
          ${pReturns.map(r => `<div class="status-my-order">
            <div class="flex-between">
              <span>å—å–: ${Fmt.yen(r.return_amount)}</span>
              ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
            </div>
          </div>`).join('')}
        </div>` : ''}
      </div>`;
    };

    if (active.length > 0) {
      html += `<h3 class="section-title">è²©å£²ä¸­</h3>`;
      active.forEach(renderProduct);
    }
    if (closed.length > 0) {
      html += `<h3 class="section-title mt-2">ç· åˆ‡æ¸ˆã¿</h3>`;
      closed.forEach(renderProduct);
    }

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãƒã‚¤ãƒšãƒ¼ã‚¸
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderMyPage() {
    const user = Auth.currentUser;
    const orders = await API.getOrders();
    const returns = await API.getReturns();
    const myOrders = Array.isArray(orders) ? orders : [];
    const myReturns = Array.isArray(returns) ? returns : [];
    const balance = user?.reinvest_balance || 0;

    let html = `<h2 class="page-title">ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>`;

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    html += UI.card(`
      ${UI.confirmRow('åå‰', user.name)}
      ${UI.confirmRow('ã‚°ãƒ«ãƒ¼ãƒ—', user.group_name || '-')}
      ${UI.confirmRow('ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼', user.is_repeater ? 'âœ… ã¯ã„' : 'ã„ã„ãˆ')}
    `);

    // æ®‹é«˜
    if (balance > 0) {
      html += `<div class="balance-banner">
        <div class="balance-banner__amount">${Fmt.yen(balance)}</div>
        <div class="balance-banner__label">é‹ç”¨ç¶™ç¶šä¸­ã®æ®‹é«˜ â€” æ¬¡å›ã®å•†å“è³¼å…¥æ™‚ã«å……å½“ã§ãã¾ã™</div>
      </div>`;
    } else {
      html += UI.card(`
        <div class="text-sm text-gray">é‹ç”¨ä¸­æ®‹é«˜: ${Fmt.yen(0)}</div>
        <div class="text-xs text-gray mt-05">ãŠæˆ»ã—æ™‚ã«ã€Œä¸€éƒ¨ã‚’å—ã‘å–ã‚‹ã€ã‚’é¸ã¶ã¨ã€æ®‹ã‚ŠãŒã“ã“ã«è²¯ã¾ã‚Šã¾ã™</div>
      `);
    }

    // æ³¨æ–‡å±¥æ­´
    html += `<h3 class="section-title mt-2">æ³¨æ–‡å±¥æ­´</h3>`;
    if (myOrders.length === 0) {
      html += UI.card('<div class="text-sm text-gray text-center">æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>');
    } else {
      myOrders.forEach(o => {
        const canReturn = o.status === 'confirmed' && !myReturns.find(r => r.order_id === o.order_id);
        const needUpload = ['pending_payment', 'pending_receipt'].includes(o.status);
        html += `<div class="order-card">
          <div class="order-card__header">
            <span class="order-card__name">${o.product_name}</span>
            ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
          </div>
          <div class="order-card__body">
            ${UI.confirmRow('æ•°é‡', Fmt.qty(o.qty))}
            ${UI.confirmRow('åˆè¨ˆ', Fmt.yen(o.total))}
            ${o.balance_used > 0 ? UI.confirmRow('æ®‹é«˜å……å½“', Fmt.yen(o.balance_used)) : ''}
            ${o.transfer_amount > 0 ? UI.confirmRow('æŒ¯è¾¼é¡', Fmt.yen(o.transfer_amount)) : ''}
            ${UI.confirmRow('æ³¨æ–‡æ—¥', Fmt.date(o.created_at))}
          </div>
          <div class="order-card__actions">
            ${canReturn ? `<button class="btn btn--outline btn--sm" onclick="UserPages.goReturn('${o.order_id}')">ãŠæˆ»ã—ç”³è«‹</button>` : ''}
            ${needUpload && !o.receipt_url ? `<button class="btn btn--primary btn--sm" onclick="UserPages._uploadReceipt('${o.order_id}')">æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>` : ''}
            ${o.receipt_url ? `<a href="${o.receipt_url}" target="_blank" rel="noopener" class="btn btn--outline btn--sm">ğŸ“ æ˜ç´°ã‚’è¦‹ã‚‹</a>` : ''}
          </div>
        </div>`;
      });
    }

    // ãŠæˆ»ã—å±¥æ­´
    if (myReturns.length > 0) {
      html += `<h3 class="section-title mt-2">ãŠæˆ»ã—å±¥æ­´</h3>`;
      myReturns.forEach(r => {
        html += UI.card(`
          <div class="flex-between">
            <span class="font-bold">${r.product_name || 'å•†å“'}</span>
            ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
          </div>
          ${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}
          ${r.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(r.keep_amount)) : ''}
          ${UI.confirmRow('å—å–æ–¹æ³•', r.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}
          ${UI.confirmRow('ç”³è«‹æ—¥', Fmt.date(r.created_at))}
        `);
      });
    }

    html += `<button class="btn btn--ghost btn--full mt-2" onclick="App.doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`;
    return html;
  },

  _uploadReceipt(orderId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,.pdf';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) { UI.toast('ãƒ•ã‚¡ã‚¤ãƒ«ã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error'); return; }

      UI.toast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—'));
        reader.readAsDataURL(file);
      });

      const res = await API.uploadReceipt({
        orderId: orderId,
        fileName: file.name,
        base64Data: base64,
        mimeType: file.type || 'image/jpeg',
      });

      if (res?.success) {
        UI.toast('æ˜ç´°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        API.clearCache();
        App.renderPage();
      } else {
        UI.toast(res?.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    };
    input.click();
  },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ç®¡ç†è€…ç”»é¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AdminPages = {
  _state: { editProduct: null, orderFilter: 'all', selectedOrder: null, editUser: null, pwUser: null },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  æ³¨æ–‡ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderOrders() {
    this._state.selectedOrder = null;
    const orders = await API.getOrders();
    const list = (Array.isArray(orders) ? orders : []).sort((a, b) => String(b.created_at).localeCompare(String(a.created_at)));
    const filter = this._state.orderFilter;

    // é›†è¨ˆ
    const counts = {
      all: list.length,
      pending_payment: list.filter(o => o.status === 'pending_payment').length,
      pending_receipt: list.filter(o => o.status === 'pending_receipt').length,
      confirmed: list.filter(o => o.status === 'confirmed').length,
    };

    // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    const filtered = filter === 'all' ? list : list.filter(o => o.status === filter);

    let html = `<h2 class="page-title">æ³¨æ–‡ç®¡ç†</h2>`;

    // ã‚µãƒãƒªãƒ¼
    html += UI.statGrid([
      UI.stat('å…¨æ³¨æ–‡', counts.all, '', ''),
      UI.stat('å…¥é‡‘å¾…ã¡', counts.pending_payment, '', counts.pending_payment > 0 ? 'red' : ''),
      UI.stat('æ˜ç´°ç¢ºèªå¾…', counts.pending_receipt, '', counts.pending_receipt > 0 ? 'gold' : ''),
      UI.stat('ç¢ºå®šæ¸ˆã¿', counts.confirmed, '', 'green'),
    ]);

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–
    const filters = [
      { key: 'all', label: `ã™ã¹ã¦ (${counts.all})` },
      { key: 'pending_payment', label: `å…¥é‡‘å¾…ã¡ (${counts.pending_payment})` },
      { key: 'pending_receipt', label: `æ˜ç´°ç¢ºèª (${counts.pending_receipt})` },
      { key: 'confirmed', label: `ç¢ºå®š (${counts.confirmed})` },
    ];
    html += `<div class="filter-tabs">${filters.map(f =>
      `<button class="filter-tab ${filter === f.key ? 'filter-tab--active' : ''}" onclick="AdminPages._state.orderFilter='${f.key}';App.renderPage()">${f.label}</button>`
    ).join('')}</div>`;

    // æ³¨æ–‡ä¸€è¦§
    if (filtered.length === 0) {
      html += UI.empty('è©²å½“ã™ã‚‹æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“‹');
    } else {
      filtered.forEach(o => {
        const isAction = ['pending_payment', 'pending_receipt'].includes(o.status);
        html += `<div class="order-admin-card ${isAction ? 'order-admin-card--action' : ''}" onclick="AdminPages._state.selectedOrder='${o.order_id}';App.currentPage='order-detail';App.renderPage()">
          <div class="flex-between">
            <div>
              <span class="font-bold">${o.user_name}</span>
              <span class="text-xs text-gray ml-05">${o.group_id || ''}</span>
            </div>
            ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
          </div>
          <div class="order-admin-card__body">
            <span class="text-sm">${o.product_name} Ã— ${o.qty}å€‹</span>
            <span class="font-bold">${Fmt.yen(o.transfer_amount || o.total)}</span>
          </div>
          <div class="order-admin-card__footer">
            <span>${Fmt.dateTime(o.created_at)}</span>
            ${o.receipt_url ? '<span class="text-xs text-blue">ğŸ“ æ˜ç´°ã‚ã‚Š</span>' : ''}
          </div>
        </div>`;
      });
    }

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  æ³¨æ–‡è©³ç´°
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderOrderDetail() {
    const orderId = this._state.selectedOrder;
    if (!orderId) return this.renderOrders();

    const orders = await API.getOrders();
    const o = (Array.isArray(orders) ? orders : []).find(x => x.order_id === orderId);
    if (!o) return UI.card('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') + `<button class="btn btn--ghost btn--full mt-1" onclick="App.navigate('order')">â† æ³¨æ–‡ä¸€è¦§</button>`;

    let html = `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('order')">â† æ³¨æ–‡ä¸€è¦§</button>
      <h2 class="page-title">æ³¨æ–‡è©³ç´°</h2>`;

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼
    const statusSteps = ['pending_payment', 'pending_receipt', 'confirmed'];
    const currentIdx = statusSteps.indexOf(o.status);
    html += `<div class="order-progress">
      <div class="order-progress__step ${currentIdx >= 0 ? 'order-progress__step--done' : ''}">
        <div class="order-progress__dot">1</div><div class="order-progress__label">äºˆç´„æ¸ˆ</div>
      </div>
      <div class="order-progress__line ${currentIdx >= 1 ? 'order-progress__line--done' : ''}"></div>
      <div class="order-progress__step ${currentIdx >= 1 ? 'order-progress__step--done' : ''}">
        <div class="order-progress__dot">2</div><div class="order-progress__label">æ˜ç´°å—é ˜</div>
      </div>
      <div class="order-progress__line ${currentIdx >= 2 ? 'order-progress__line--done' : ''}"></div>
      <div class="order-progress__step ${currentIdx >= 2 ? 'order-progress__step--done' : ''}">
        <div class="order-progress__dot">3</div><div class="order-progress__label">ç¢ºå®š</div>
      </div>
    </div>`;

    // æ³¨æ–‡æƒ…å ±
    html += UI.card(`
      <h3 class="section-title">æ³¨æ–‡æƒ…å ±</h3>
      ${UI.confirmRow('æ³¨æ–‡ID', o.order_id)}
      ${UI.confirmRow('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status)))}
      ${UI.confirmRow('æ³¨æ–‡æ—¥æ™‚', Fmt.dateTime(o.created_at))}
      ${o.payment_deadline ? UI.confirmRow('å…¥é‡‘æœŸé™', Fmt.dateTime(o.payment_deadline)) : ''}
    `);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    html += UI.card(`
      <h3 class="section-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼</h3>
      ${UI.confirmRow('æ°å', o.user_name)}
      ${UI.confirmRow('ã‚°ãƒ«ãƒ¼ãƒ—', o.group_id)}
    `);

    // å•†å“ãƒ»é‡‘é¡
    html += UI.card(`
      <h3 class="section-title">å•†å“ãƒ»é‡‘é¡</h3>
      ${UI.confirmRow('å•†å“', o.product_name)}
      ${UI.confirmRow('æ•°é‡', Fmt.qty(o.qty))}
      ${UI.confirmRow('å˜ä¾¡', Fmt.yen(o.unit_price))}
      ${UI.divider()}
      ${UI.confirmRow('åˆè¨ˆé‡‘é¡', Fmt.yen(o.total), 'font-bold')}
      ${o.balance_used > 0 ? `
        ${UI.confirmRow('æ®‹é«˜å……å½“', 'âˆ’ ' + Fmt.yen(o.balance_used), 'text-green')}
        ${UI.confirmRow('æŒ¯è¾¼é¡', Fmt.yen(o.transfer_amount), 'font-bold text-lg')}
      ` : ''}
      ${o.transfer_amount === 0 ? `<div class="success-box mt-05">æ®‹é«˜ã®ã¿ã§è³¼å…¥å®Œäº†</div>` : ''}
    `);

    // æŒ¯è¾¼æ˜ç´°
    if (o.receipt_url) {
      html += UI.card(`
        <h3 class="section-title">ğŸ“ æŒ¯è¾¼æ˜ç´°</h3>
        <div class="receipt-info">
          <a href="${o.receipt_url}" target="_blank" rel="noopener" class="receipt-link">
            <span class="receipt-link__icon">ğŸ–¼ï¸</span>
            <span class="receipt-link__text">æ˜ç´°ã‚’è¡¨ç¤ºã™ã‚‹</span>
            <span class="receipt-link__arrow">â†’</span>
          </a>
        </div>
      `);
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    if (o.status === 'pending_payment') {
      html += UI.card(`
        <h3 class="section-title">æ“ä½œ</h3>
        <div class="info-box mb-1"><div class="text-xs">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥é‡‘ãƒ»æ˜ç´°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™</div></div>
        <button class="btn btn--outline btn--full" onclick="AdminPages._cancelOrder('${o.order_id}')">æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      `);
    } else if (o.status === 'pending_receipt') {
      html += UI.card(`
        <h3 class="section-title">æ“ä½œ</h3>
        <div class="info-box mb-1"><div class="text-xs">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç´°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚æŒ¯è¾¼å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div></div>
        <div class="btn-group">
          <button class="btn btn--primary btn--full" onclick="AdminPages._confirmOrder('${o.order_id}')">âœ… å…¥é‡‘ç¢ºèª â†’ æ³¨æ–‡ç¢ºå®š</button>
          <button class="btn btn--outline btn--full" onclick="AdminPages._rejectReceipt('${o.order_id}')">âŒ æ˜ç´°ã‚’å·®ã—æˆ»ã—</button>
          <button class="btn btn--ghost btn--full text-red" onclick="AdminPages._cancelOrder('${o.order_id}')">æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      `);
    } else if (o.status === 'confirmed') {
      html += UI.card(`<div class="success-box">âœ… ã“ã®æ³¨æ–‡ã¯ç¢ºå®šæ¸ˆã¿ã§ã™</div>`);
    } else if (o.status === 'cancelled') {
      html += UI.card(`<div class="text-sm text-gray text-center">ã“ã®æ³¨æ–‡ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ</div>`);
    }

    return html;
  },

  async _confirmOrder(orderId) {
    UI.confirm('å…¥é‡‘ã‚’ç¢ºèªã—ã€ã“ã®æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ', async () => {
      const res = await API.updateOrder(orderId, { status: 'confirmed' });
      if (res?.success) { UI.toast('æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  async _rejectReceipt(orderId) {
    UI.confirm('æ˜ç´°ã‚’å·®ã—æˆ»ã—ã¾ã™ã‹ï¼Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ä¾é ¼ã—ã¾ã™ã€‚', async () => {
      const res = await API.updateOrder(orderId, { status: 'pending_payment', receipt_url: '' });
      if (res?.success) { UI.toast('æ˜ç´°ã‚’å·®ã—æˆ»ã—ã¾ã—ãŸ'); API.clearCache(); App.renderPage(); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  async _cancelOrder(orderId) {
    UI.confirm('ã“ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ã¯æˆ»ã‚Šã¾ã›ã‚“ã€‚', async () => {
      const res = await API.updateOrder(orderId, { status: 'cancelled' });
      if (res?.success) { UI.toast('æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ'); API.clearCache(); App.navigate('order'); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderProducts() {
    this._state.editProduct = null;
    const products = await API.getProducts();
    const list = Array.isArray(products) ? products : [];

    let html = `<div class="flex-between mb-1">
      <h2 class="page-title">å•†å“ç®¡ç†</h2>
      <button class="btn btn--primary btn--sm" onclick="AdminPages._state.editProduct='new';App.currentPage='product-edit';App.renderPage()">ï¼‹ æ–°è¦ç™»éŒ²</button>
    </div>`;

    if (list.length === 0) return html + UI.empty('å•†å“ãŒã‚ã‚Šã¾ã›ã‚“', 'ğŸ“¦');

    list.forEach(p => {
      html += `<div class="product-admin-card" onclick="AdminPages._state.editProduct='${p.product_id}';App.currentPage='product-edit';App.renderPage()">
        <div class="flex-between">
          <span class="font-bold">${p.name}</span>
          ${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}
        </div>
        <div class="text-sm mt-05">
          ${UI.confirmRow('ä»•å…¥', Fmt.yen(p.buy_price))}
          ${UI.confirmRow('å£²å˜ä¾¡', Fmt.yen(p.base_sell_price || p.sell_price))}
          ${UI.confirmRow('åœ¨åº«', `${p.remaining_qty} / ${p.total_qty}`)}
          ${UI.confirmRow('ç· åˆ‡', Fmt.date(p.deadline, true))}
        </div>
      </div>`;
    });

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“ç·¨é›†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderProductEdit() {
    const pid = this._state.editProduct;
    const isNew = pid === 'new';
    let p = { name: '', buy_price: '', total_qty: '', deadline: '', status: 'draft' };

    if (!isNew) {
      const data = await API.getProduct(pid);
      if (data && !data.error) p = data;
    }

    let html = `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('product')">â† å•†å“ä¸€è¦§</button>
      <h2 class="page-title">${isNew ? 'å•†å“ç™»éŒ²' : 'å•†å“ç·¨é›†'}</h2>`;

    html += UI.card(`
      <div class="form-group">
        <label class="form-label">å•†å“å</label>
        <input type="text" class="input" id="pe-name" value="${p.name}" placeholder="ä¾‹: CRG533">
      </div>
      <div class="form-group">
        <label class="form-label">ä»•å…¥å˜ä¾¡ (Â¥)</label>
        <input type="number" class="input" id="pe-buyprice" value="${p.buy_price}" placeholder="14000">
      </div>
      <div class="form-group">
        <label class="form-label">å£²å˜ä¾¡ï¼ˆåŸºæº–ä¾¡æ ¼ï¼‰(Â¥)</label>
        <input type="number" class="input" id="pe-sellprice" value="${p.base_sell_price || p.sell_price || ''}" placeholder="15000">
        <div class="text-xs text-gray mt-05">å„ã‚°ãƒ«ãƒ¼ãƒ—ãƒªãƒ¼ãƒ€ãƒ¼ãŒã“ã®ä¾¡æ ¼ã‚’ãƒ™ãƒ¼ã‚¹ã«èª¿æ•´ã—ã¾ã™</div>
      </div>
      <div class="form-group">
        <label class="form-label">ç·æ•°é‡</label>
        <input type="number" class="input" id="pe-qty" value="${p.total_qty}" placeholder="1000">
      </div>
      <div class="form-group">
        <label class="form-label">ç· åˆ‡æ—¥</label>
        <input type="date" class="input" id="pe-deadline" value="${p.deadline ? p.deadline.substring(0, 10) : ''}">
      </div>
      ${!isNew ? `
      <div class="form-group">
        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <select class="input" id="pe-status">
          <option value="draft" ${p.status === 'draft' ? 'selected' : ''}>ä¸‹æ›¸ã</option>
          <option value="active" ${p.status === 'active' ? 'selected' : ''}>è²©å£²ä¸­</option>
          <option value="closed" ${p.status === 'closed' ? 'selected' : ''}>ç· åˆ‡</option>
        </select>
      </div>` : ''}
      <button class="btn btn--primary btn--full mt-1" onclick="AdminPages._saveProduct('${pid}')">${isNew ? 'ç™»éŒ²ã™ã‚‹' : 'ä¿å­˜ã™ã‚‹'}</button>
    `);

    // ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ä¾¡æ ¼ï¼ˆæ—¢å­˜å•†å“ã®ã¿ï¼‰
    if (!isNew) {
      const prices = await API.getGroupPrices(pid);
      const groups = await API.getGroups();
      const priceList = Array.isArray(prices) ? prices : [];

      html += `<h3 class="section-title mt-2">ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ä¾¡æ ¼</h3>`;
      priceList.forEach(gp => {
        const gName = (Array.isArray(groups) ? groups : []).find(g => g.group_id === gp.group_id)?.name || gp.group_id;
        html += UI.card(`
          <div class="flex-between">
            <span class="font-bold">${gName}</span>
            <span class="text-sm">åˆ©ç›Šç‡: ${Fmt.pct(gp.profit_rate)}</span>
          </div>
          <div class="flex-between mt-05">
            <span class="text-sm">å£²å˜ä¾¡</span>
            <span class="font-bold">${Fmt.yen(gp.sell_price)}</span>
          </div>
        `);
      });
    }

    return html;
  },

  async _saveProduct(pid) {
    const name = $('#pe-name')?.value?.trim();
    const buy_price = Number($('#pe-buyprice')?.value);
    const sell_price = Number($('#pe-sellprice')?.value);
    const total_qty = Number($('#pe-qty')?.value);
    const deadline = $('#pe-deadline')?.value;
    const status = $('#pe-status')?.value;

    if (!name) { UI.toast('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!buy_price || buy_price <= 0) { UI.toast('ä»•å…¥å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!sell_price || sell_price <= 0) { UI.toast('å£²å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (sell_price < buy_price) { UI.toast('å£²å˜ä¾¡ã¯ä»•å…¥å˜ä¾¡ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }

    let res;
    if (pid === 'new') {
      res = await API.createProduct({ name, buy_price, sell_price, total_qty, deadline });
    } else {
      res = await API.updateProduct({ productId: pid, name, buy_price, sell_price, status, deadline, total_qty });
    }

    if (res?.success) {
      UI.toast(pid === 'new' ? 'å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ' : 'å•†å“ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      App.navigate('product');
    } else {
      UI.toast(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderDashboard() {
    const res = await API.getDashboard();
    const d = res?.dashboard || {};

    let html = `<h2 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>`;

    html += UI.statGrid([
      UI.stat('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', d.total_users || 0, '', 'blue'),
      UI.stat('å•†å“æ•°', `${d.active_products || 0} / ${d.total_products || 0}`, 'è²©å£²ä¸­/å…¨ä½“', 'green'),
      UI.stat('æ³¨æ–‡æ•°', d.total_orders || 0, `ç¢ºå®š: ${d.confirmed_orders || 0} / æœªå‡¦ç†: ${d.pending_orders || 0}`, 'purple'),
      UI.stat('å£²ä¸Šåˆè¨ˆ', Fmt.yen(d.total_sales || 0), 'ç¢ºå®šæ¸ˆã¿', 'gold'),
      UI.stat('æœªå‡¦ç†ãŠæˆ»ã—', d.pending_returns || 0, Fmt.yen(d.total_return_amount || 0), d.pending_returns > 0 ? 'red' : ''),
    ]);

    // æœªå‡¦ç†æ³¨æ–‡ã¸ã®å°ç·š
    const orderCount = (d.pending_orders || 0);
    if (orderCount > 0) {
      html += UI.card(`
        <div class="flex-between">
          <div>
            <div class="font-bold">æœªå‡¦ç†ã®æ³¨æ–‡ãŒ ${orderCount}ä»¶ ã‚ã‚Šã¾ã™</div>
            <div class="text-xs text-gray mt-05">å…¥é‡‘å¾…ã¡ãƒ»æ˜ç´°ç¢ºèªå¾…ã¡ã®æ³¨æ–‡</div>
          </div>
          <button class="btn btn--primary btn--sm" onclick="App.navigate('order')">æ³¨æ–‡ç®¡ç†ã¸ â†’</button>
        </div>
      `);
    }

    // æœªå‡¦ç†ãŠæˆ»ã—ã¸ã®å°ç·š
    if ((d.pending_returns || 0) > 0) {
      html += UI.card(`
        <div class="flex-between">
          <div>
            <div class="font-bold">æœªå‡¦ç†ã®ãŠæˆ»ã—ãŒ ${d.pending_returns}ä»¶ ã‚ã‚Šã¾ã™</div>
            <div class="text-xs text-gray mt-05">åˆè¨ˆ: ${Fmt.yen(d.total_return_amount || 0)}</div>
          </div>
          <button class="btn btn--outline btn--sm" onclick="App.navigate('return')">ãŠæˆ»ã—ç®¡ç†ã¸ â†’</button>
        </div>
      `);
    }

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãŠæˆ»ã—ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderReturns() {
    const returns = await API.getReturns();
    const list = Array.isArray(returns) ? returns : [];

    let html = `<h2 class="page-title">ãŠæˆ»ã—ç®¡ç†</h2>`;

    const unprocessed = list.filter(r => ['unprocessed', 'applied'].includes(r.status));
    const processed = list.filter(r => !['unprocessed', 'applied'].includes(r.status));

    if (unprocessed.length === 0 && processed.length === 0) return html + UI.empty('ãŠæˆ»ã—ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“', 'â†©ï¸');

    if (unprocessed.length > 0) {
      html += `<h3 class="section-title">æœªå‡¦ç† (${unprocessed.length}ä»¶)</h3>`;
      unprocessed.forEach(r => {
        html += UI.card(`
          <div class="flex-between">
            <span class="font-bold">${r.user_name}</span>
            ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
          </div>
          ${UI.confirmRow('å•†å“', r.product_name || '-')}
          ${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}
          ${r.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(r.keep_amount)) : ''}
          ${UI.confirmRow('æ–¹æ³•', r.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}
          ${r.desired_date ? UI.confirmRow('å¸Œæœ›æ—¥', r.desired_date) : ''}
          ${UI.confirmRow('ç”³è«‹æ—¥', Fmt.dateTime(r.created_at))}
          <div class="btn-group mt-1">
            <button class="btn btn--primary btn--sm" onclick="AdminPages._processReturn('${r.return_id}', '${r.method === 'cash' ? 'handed' : 'remitted'}')">
              ${r.method === 'cash' ? 'æ‰‹æ¸¡ã—æ¸ˆã¿' : 'é€é‡‘æ¸ˆã¿'}
            </button>
            <button class="btn btn--outline btn--sm" onclick="AdminPages._processReturn('${r.return_id}', 'processing')">å‡¦ç†ä¸­</button>
          </div>
        `);
      });
    }

    if (processed.length > 0) {
      html += `<h3 class="section-title mt-2">å‡¦ç†æ¸ˆã¿ (${processed.length}ä»¶)</h3>`;
      processed.forEach(r => {
        html += UI.card(`
          <div class="flex-between">
            <span>${r.user_name}</span>
            ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
          </div>
          <div class="text-sm">${Fmt.yen(r.return_amount)} / ${Fmt.dateTime(r.created_at)}</div>
        `);
      });
    }

    return html;
  },

  async _processReturn(returnId, status) {
    const labels = { processing: 'å‡¦ç†ä¸­', remitted: 'é€é‡‘æ¸ˆã¿', handed: 'æ‰‹æ¸¡ã—æ¸ˆã¿' };
    UI.confirm(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${labels[status]}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
      const res = await API.updateReturn(returnId, { status });
      if (res?.success) { UI.toast('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); App.renderPage(); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderUsers() {
    this._state.editUser = null;
    this._state.pwUser = null;
    const users = await API.getUsers();
    const groups = await API.getGroups();
    const list = Array.isArray(users) ? users : [];
    const groupList = Array.isArray(groups) ? groups : [];

    let html = `<div class="flex-between mb-1">
      <h2 class="page-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
      <button class="btn btn--primary btn--sm" onclick="AdminPages._state.editUser='new';App.currentPage='user-edit';App.renderPage()">ï¼‹ æ–°è¦ç™»éŒ²</button>
    </div>`;

    // ãƒ­ãƒ¼ãƒ«åˆ¥é›†è¨ˆ
    const admins = list.filter(u => u.role === 'admin');
    const leaders = list.filter(u => u.role === 'leader');
    const users_ = list.filter(u => u.role === 'user');

    html += UI.statGrid([
      UI.stat('ç®¡ç†è€…', admins.length, '', 'purple'),
      UI.stat('ãƒªãƒ¼ãƒ€ãƒ¼', leaders.length, '', 'blue'),
      UI.stat('ãƒ¦ãƒ¼ã‚¶ãƒ¼', users_.length, '', 'green'),
    ]);

    if (list.length === 0) return html + UI.empty('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“', 'ğŸ‘¥');

    // ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ã«è¡¨ç¤º
    const roleOrder = { admin: 0, leader: 1, user: 2 };
    const sorted = [...list].sort((a, b) => (roleOrder[a.role] || 9) - (roleOrder[b.role] || 9));

    sorted.forEach(u => {
      const gName = groupList.find(g => g.group_id === u.group_id)?.name || '';
      const roleLabel = { admin: 'ç®¡ç†è€…', leader: 'ãƒªãƒ¼ãƒ€ãƒ¼', user: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' }[u.role] || u.role;
      const roleColor = { admin: 'purple', leader: 'blue', user: 'green' }[u.role] || 'gray';

      html += `<div class="user-card" onclick="AdminPages._state.editUser='${u.user_id}';App.currentPage='user-edit';App.renderPage()">
        <div class="flex-between">
          <div>
            <span class="font-bold">${u.name}</span>
            <span class="text-xs text-gray ml-05">${gName}</span>
          </div>
          ${UI.badge(roleLabel, roleColor)}
        </div>
        <div class="user-card__meta">
          <span>ID: ${u.login_id || '-'}</span>
          <span>${u.email || '-'}</span>
          ${u.reinvest_balance > 0 ? `<span class="text-green">æ®‹é«˜: ${Fmt.yen(u.reinvest_balance)}</span>` : ''}
        </div>
      </div>`;
    });

    return html;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†/æ–°è¦ç™»éŒ²
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderUserEdit() {
    const uid = this._state.editUser;
    const isNew = uid === 'new';
    const groups = await API.getGroups();
    const groupList = Array.isArray(groups) ? groups : [];

    let u = { name: '', login_id: '', email: '', group_id: '', role: 'user', is_repeater: false };
    if (!isNew) {
      const users = await API.getUsers();
      const found = (Array.isArray(users) ? users : []).find(x => x.user_id === uid);
      if (found) u = found;
    }

    let html = `
      <button class="btn btn--ghost btn--sm mb-1" onclick="App.navigate('users')">â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</button>
      <h2 class="page-title">${isNew ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†'}</h2>`;

    html += UI.card(`
      <div class="form-group">
        <label class="form-label">åå‰ *</label>
        <input type="text" class="input" id="ue-name" value="${u.name || ''}" placeholder="ç”°ä¸­ å¤ªéƒ">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ­ã‚°ã‚¤ãƒ³ID *</label>
        <input type="text" class="input" id="ue-loginid" value="${u.login_id || ''}" placeholder="tanaka">
      </div>
      ${isNew ? `
      <div class="form-group">
        <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
        <input type="text" class="input" id="ue-password" value="" placeholder="4æ–‡å­—ä»¥ä¸Š">
      </div>` : ''}
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" class="input" id="ue-email" value="${u.email || ''}" placeholder="tanaka@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ­ãƒ¼ãƒ« *</label>
        <select class="input" id="ue-role">
          <option value="user" ${u.role === 'user' ? 'selected' : ''}>ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
          <option value="leader" ${u.role === 'leader' ? 'selected' : ''}>ãƒªãƒ¼ãƒ€ãƒ¼</option>
          <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>ç®¡ç†è€…</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ã‚°ãƒ«ãƒ¼ãƒ—</label>
        <select class="input" id="ue-group">
          <option value="">ãªã—</option>
          ${groupList.map(g => `<option value="${g.group_id}" ${u.group_id === g.group_id ? 'selected' : ''}>${g.name}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" id="ue-repeater" ${(u.is_repeater === true || u.is_repeater === 'TRUE') ? 'checked' : ''}> ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼
        </label>
      </div>
      <button class="btn btn--primary btn--full mt-1" onclick="AdminPages._saveUser('${uid}')">${isNew ? 'ç™»éŒ²ã™ã‚‹' : 'ä¿å­˜ã™ã‚‹'}</button>
    `);

    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ & å‰Šé™¤
    if (!isNew) {
      html += UI.card(`
        <h3 class="section-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</h3>
        <div class="form-group">
          <input type="text" class="input" id="ue-newpw" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ4æ–‡å­—ä»¥ä¸Šï¼‰">
        </div>
        <button class="btn btn--outline btn--full" onclick="AdminPages._resetPw('${uid}')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
      `);

      html += UI.card(`
        <h3 class="section-title text-red">å±é™ºãªæ“ä½œ</h3>
        <button class="btn btn--ghost btn--full text-red" onclick="AdminPages._deleteUser('${uid}', '${u.name}')">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤</button>
      `);

      // æ®‹é«˜æƒ…å ±
      if (u.reinvest_balance > 0) {
        html += UI.card(`
          <h3 class="section-title">é‹ç”¨æ®‹é«˜</h3>
          ${UI.confirmRow('ç¾åœ¨ã®æ®‹é«˜', Fmt.yen(u.reinvest_balance))}
        `);
      }
    }

    return html;
  },

  async _saveUser(uid) {
    const name = $('#ue-name')?.value?.trim();
    const login_id = $('#ue-loginid')?.value?.trim();
    const email = $('#ue-email')?.value?.trim();
    const role = $('#ue-role')?.value;
    const group_id = $('#ue-group')?.value;
    const is_repeater = $('#ue-repeater')?.checked;

    if (!name) { UI.toast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
    if (!login_id) { UI.toast('ãƒ­ã‚°ã‚¤ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

    let res;
    if (uid === 'new') {
      const password = $('#ue-password')?.value?.trim();
      if (!password || password.length < 4) { UI.toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }
      res = await API.createUser({ name, login_id, password, email, role, group_id, is_repeater });
    } else {
      res = await API.updateUser({ user_id: uid, name, login_id, email, role, group_id, is_repeater });
    }

    if (res?.success) {
      UI.toast(uid === 'new' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      App.navigate('users');
    } else {
      UI.toast(res?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  },

  async _resetPw(uid) {
    const pw = $('#ue-newpw')?.value?.trim();
    if (!pw || pw.length < 4) { UI.toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }
    UI.confirm('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ', async () => {
      const res = await API.resetPassword(uid, pw);
      if (res?.success) { UI.toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'); $('#ue-newpw').value = ''; }
      else UI.toast(res?.error || 'å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  async _deleteUser(uid, name) {
    UI.confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`, async () => {
      const res = await API.deleteUser(uid);
      if (res?.success) { UI.toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); App.navigate('users'); }
      else UI.toast(res?.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒªãƒ¼ãƒ€ãƒ¼ç”»é¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LeaderPages = {
  _state: {},

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ä¾¡æ ¼è¨­å®š
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderPricing() {
    const products = await API.getProducts();
    const groupId = Auth.getGroupId();
    const groupName = Auth.getGroupName();
    const list = Array.isArray(products) ? products : [];
    const active = list.filter(p => p.status === 'active');

    let html = `<h2 class="page-title">ä¾¡æ ¼è¨­å®š</h2>
      <div class="text-sm text-gray mb-1">${groupName} ã®è²©å£²å˜ä¾¡ã‚’èª¿æ•´</div>`;

    if (active.length === 0) return html + UI.empty('è²©å£²ä¸­ã®å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ’°');

    for (const p of active) {
      const prices = await API.getGroupPrices(p.product_id);
      const gp = (Array.isArray(prices) ? prices : []).find(g => g.group_id === groupId);
      const baseSellPrice = p.base_sell_price || 0;
      const groupSellPrice = gp?.sell_price || baseSellPrice;
      const profitRate = gp?.profit_rate || 0;
      const diff = groupSellPrice - baseSellPrice;

      html += UI.card(`
        <div class="flex-between">
          <span class="font-bold">${p.name}</span>
          ${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}
        </div>
        <div class="price-info-grid mt-05">
          ${UI.confirmRow('ä»•å…¥å˜ä¾¡', Fmt.yen(p.buy_price))}
          ${UI.confirmRow('åŸºæº–å£²å˜ä¾¡ï¼ˆç®¡ç†è€…è¨­å®šï¼‰', Fmt.yen(baseSellPrice))}
          <div class="divider"></div>
          ${UI.confirmRow('ã‚°ãƒ«ãƒ¼ãƒ—è²©å£²å˜ä¾¡', `<span class="font-bold text-lg">${Fmt.yen(groupSellPrice)}</span>`, '')}
          ${diff !== 0 ? UI.confirmRow('åŸºæº–ã¨ã®å·®é¡', `<span class="${diff > 0 ? 'text-green' : 'text-red'}">${diff > 0 ? '+' : ''}${Fmt.yen(diff)}</span>`) : ''}
          ${UI.confirmRow('åˆ©ç›Šç‡ï¼ˆå¯¾ä»•å…¥ï¼‰', Fmt.pct(profitRate))}
        </div>
        <div class="form-group mt-1">
          <label class="form-label">è²©å£²å˜ä¾¡ã‚’å¤‰æ›´</label>
          <div class="amount-input-wrap">
            <span class="amount-prefix">Â¥</span>
            <input type="number" class="input input--amount" id="price-${p.product_id}" value="${groupSellPrice}" min="${p.buy_price}" step="100">
          </div>
          <div class="text-xs text-gray mt-05">â€» ä»•å…¥å˜ä¾¡ï¼ˆ${Fmt.yen(p.buy_price)}ï¼‰ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„</div>
          <button class="btn btn--primary btn--sm mt-05" onclick="LeaderPages._savePrice('${p.product_id}', '${groupId}')">ä¿å­˜</button>
        </div>
      `);
    }

    return html;
  },

  async _savePrice(productId, groupId) {
    const input = $(`#price-${productId}`);
    const sellPrice = Number(input?.value);
    if (!sellPrice || sellPrice <= 0) { UI.toast('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

    const res = await API.updateGroupPrice({ productId, groupId, sell_price: sellPrice });
    if (res?.success) {
      UI.toast('å£²å˜ä¾¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      API.clearCache();
      App.renderPage();
    } else {
      UI.toast(res?.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  æ³¨æ–‡ç¢ºèª
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderOrders() {
    const orders = await API.getOrders();
    const list = Array.isArray(orders) ? orders : [];

    let html = `<h2 class="page-title">æ³¨æ–‡ç¢ºèª</h2>
      <div class="text-sm text-gray mb-1">${Auth.getGroupName()} ã®æ³¨æ–‡ä¸€è¦§</div>`;

    if (list.length === 0) return html + UI.empty('æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“', 'ğŸ“‹');

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ
    const pending = list.filter(o => ['pending_payment', 'pending_receipt'].includes(o.status));
    const confirmed = list.filter(o => o.status === 'confirmed');

    html += UI.statGrid([
      UI.stat('æœªå‡¦ç†', pending.length, '', pending.length > 0 ? 'red' : ''),
      UI.stat('ç¢ºå®šæ¸ˆ', confirmed.length, Fmt.yen(confirmed.reduce((s, o) => s + o.total, 0)), 'green'),
    ]);

    list.sort((a, b) => String(b.created_at).localeCompare(String(a.created_at)));
    list.forEach(o => {
      html += UI.card(`
        <div class="flex-between">
          <span class="font-bold">${o.user_name}</span>
          ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
        </div>
        ${UI.confirmRow('å•†å“', o.product_name)}
        ${UI.confirmRow('æ•°é‡', Fmt.qty(o.qty))}
        ${UI.confirmRow('é‡‘é¡', Fmt.yen(o.total))}
        ${o.balance_used > 0 ? UI.confirmRow('æ®‹é«˜å……å½“', Fmt.yen(o.balance_used)) : ''}
        ${o.transfer_amount > 0 ? UI.confirmRow('æŒ¯è¾¼é¡', Fmt.yen(o.transfer_amount)) : ''}
        ${UI.confirmRow('æ³¨æ–‡æ—¥', Fmt.dateTime(o.created_at))}
        ${o.status === 'pending_receipt' ? `<button class="btn btn--primary btn--sm mt-05" onclick="LeaderPages._confirmOrder('${o.order_id}')">å…¥é‡‘ç¢ºèª</button>` : ''}
      `);
    });

    return html;
  },

  async _confirmOrder(orderId) {
    UI.confirm('å…¥é‡‘ã‚’ç¢ºèªã—ã¦æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ', async () => {
      const res = await API.updateOrder(orderId, { status: 'confirmed' });
      if (res?.success) { UI.toast('æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸ'); App.renderPage(); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  ãŠæˆ»ã—å‡¦ç†
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderReturns() {
    const returns = await API.getReturns();
    const list = Array.isArray(returns) ? returns : [];

    let html = `<h2 class="page-title">ãŠæˆ»ã—å‡¦ç†</h2>
      <div class="text-sm text-gray mb-1">${Auth.getGroupName()}</div>`;

    if (list.length === 0) return html + UI.empty('ãŠæˆ»ã—ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“', 'â†©ï¸');

    const unprocessed = list.filter(r => ['unprocessed', 'applied'].includes(r.status));
    const processed = list.filter(r => !['unprocessed', 'applied'].includes(r.status));

    if (unprocessed.length > 0) {
      html += `<h3 class="section-title">æœªå‡¦ç† (${unprocessed.length}ä»¶)</h3>`;
      unprocessed.forEach(r => {
        html += UI.card(`
          <div class="flex-between">
            <span class="font-bold">${r.user_name}</span>
            ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
          </div>
          ${UI.confirmRow('å—å–é¡', Fmt.yen(r.return_amount))}
          ${r.keep_amount > 0 ? UI.confirmRow('é‹ç”¨ç¶™ç¶š', Fmt.yen(r.keep_amount)) : ''}
          ${UI.confirmRow('æ–¹æ³•', r.method === 'cash' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' : 'éŠ€è¡ŒæŒ¯è¾¼')}
          ${r.desired_date ? UI.confirmRow('å¸Œæœ›æ—¥', r.desired_date) : ''}
          <div class="btn-group mt-1">
            <button class="btn btn--primary btn--sm" onclick="LeaderPages._processReturn('${r.return_id}', '${r.method === 'cash' ? 'handed' : 'remitted'}')">
              ${r.method === 'cash' ? 'æ‰‹æ¸¡ã—å®Œäº†' : 'é€é‡‘å®Œäº†'}
            </button>
          </div>
        `);
      });
    }

    if (processed.length > 0) {
      html += `<h3 class="section-title mt-2">å‡¦ç†æ¸ˆã¿</h3>`;
      processed.forEach(r => {
        html += UI.card(`
          <div class="flex-between">
            <span>${r.user_name}</span>
            ${UI.badge(Fmt.returnStatus(r.status), Fmt.statusColor(r.status))}
          </div>
          <div class="text-sm">${Fmt.yen(r.return_amount)} / ${Fmt.dateTime(r.created_at)}</div>
        `);
      });
    }

    return html;
  },

  async _processReturn(returnId, status) {
    const label = status === 'handed' ? 'æ‰‹æ¸¡ã—å®Œäº†' : 'é€é‡‘å®Œäº†';
    UI.confirm(`ã€Œ${label}ã€ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`, async () => {
      const res = await API.updateReturn(returnId, { status });
      if (res?.success) { UI.toast('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); App.renderPage(); }
      else UI.toast(res?.error || 'å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  å•†å“çŠ¶æ³
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async renderStatus() {
    const products = await API.getProducts();
    const orders = await API.getOrders();
    const returns = await API.getReturns();
    const groupId = Auth.getGroupId();
    const groupName = Auth.getGroupName();
    const list = Array.isArray(products) ? products : [];
    const orderList = Array.isArray(orders) ? orders : [];
    const returnList = Array.isArray(returns) ? returns : [];

    let html = `<h2 class="page-title">å•†å“çŠ¶æ³</h2>
      <div class="text-sm text-gray mb-1">${groupName}</div>`;

    if (list.length === 0) return html + UI.empty('å•†å“ãŒã‚ã‚Šã¾ã›ã‚“', 'ğŸ“Š');

    const active = list.filter(p => p.status === 'active');
    const closed = list.filter(p => p.status === 'closed');

    const renderProduct = (p) => {
      const pOrders = orderList.filter(o => o.product_id === p.product_id);
      const pReturns = returnList.filter(r => pOrders.some(o => o.order_id === r.order_id));

      const totalOrdered = pOrders.reduce((s, o) => s + (o.qty || 0), 0);
      const confirmed = pOrders.filter(o => o.status === 'confirmed');
      const pendingPayment = pOrders.filter(o => o.status === 'pending_payment');
      const pendingReceipt = pOrders.filter(o => o.status === 'pending_receipt');
      const paidAmount = confirmed.reduce((s, o) => s + (o.total || 0), 0);

      const pendingReturns = pReturns.filter(r => ['unprocessed', 'applied', 'processing'].includes(r.status));
      const doneReturns = pReturns.filter(r => ['remitted', 'handed'].includes(r.status));

      html += `<div class="status-card">
        <div class="status-card__header">
          <span class="font-bold">${p.name}</span>
          ${UI.badge(Fmt.productStatus(p.status), Fmt.statusColor(p.status))}
        </div>

        <div class="status-section">
          <div class="status-section__title">ğŸ“¦ åœ¨åº«</div>
          <div class="status-bar-wrap">
            <div class="status-bar">
              <div class="status-bar__fill" style="width:${p.total_qty > 0 ? (1 - p.remaining_qty / p.total_qty) * 100 : 0}%"></div>
            </div>
            <div class="status-bar__label">${p.remaining_qty} / ${p.total_qty} æ®‹ã‚Š</div>
          </div>
        </div>

        <div class="status-section">
          <div class="status-section__title">ğŸ’° å…¥é‡‘çŠ¶æ³</div>
          <div class="status-chips">
            <span class="status-chip status-chip--green">ç¢ºå®š ${confirmed.length}ä»¶ (${Fmt.yen(paidAmount)})</span>
            ${pendingReceipt.length > 0 ? `<span class="status-chip status-chip--gold">æ˜ç´°ç¢ºèª ${pendingReceipt.length}ä»¶</span>` : ''}
            ${pendingPayment.length > 0 ? `<span class="status-chip status-chip--red">å…¥é‡‘å¾…ã¡ ${pendingPayment.length}ä»¶</span>` : ''}
          </div>
        </div>

        ${pOrders.length > 0 ? `
        <div class="status-section">
          <div class="status-section__title">ğŸ‘¤ æ³¨æ–‡è€…</div>
          <div class="status-users">
            ${pOrders.map(o => `<div class="status-user-row">
              <span>${o.user_name}</span>
              <span>${Fmt.qty(o.qty)}</span>
              <span>${Fmt.yen(o.total)}</span>
              ${UI.badge(Fmt.orderStatus(o.status), Fmt.statusColor(o.status))}
            </div>`).join('')}
          </div>
        </div>` : ''}

        ${pReturns.length > 0 ? `
        <div class="status-section">
          <div class="status-section__title">â†©ï¸ ãŠæˆ»ã—</div>
          <div class="status-chips">
            ${pendingReturns.length > 0 ? `<span class="status-chip status-chip--red">æœªå‡¦ç† ${pendingReturns.length}ä»¶</span>` : ''}
            ${doneReturns.length > 0 ? `<span class="status-chip status-chip--green">å‡¦ç†æ¸ˆ ${doneReturns.length}ä»¶</span>` : ''}
          </div>
        </div>` : ''}
      </div>`;
    };

    if (active.length > 0) {
      html += `<h3 class="section-title">è²©å£²ä¸­</h3>`;
      active.forEach(renderProduct);
    }
    if (closed.length > 0) {
      html += `<h3 class="section-title mt-2">ç· åˆ‡æ¸ˆã¿</h3>`;
      closed.forEach(renderProduct);
    }

    return html;
  },
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const App = {
  currentPage: null,
  _loadingCount: 0,

  init() {
    Auth.init();
    if (Auth.isLoggedIn()) {
      this.renderApp();
    } else {
      this.showLogin();
    }
  },

  // â”€â”€ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â”€â”€
  setLoading(on) {
    this._loadingCount += on ? 1 : -1;
    if (this._loadingCount < 0) this._loadingCount = 0;
    const el = $('#global-loading');
    if (el) el.style.display = this._loadingCount > 0 ? 'flex' : 'none';
  },

  // â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ â”€â”€
  showLogin() {
    $('#app').innerHTML = `
      <div class="login-screen">
        <div class="login-card">
          <div class="login-logo">å‡ºè³‡ç®¡ç†</div>
          <div class="login-subtitle">Investment Management System</div>
          <div class="form-group">
            <label class="form-label">ãƒ­ã‚°ã‚¤ãƒ³ID</label>
            <input type="text" id="login-id" class="input" placeholder="IDã‚’å…¥åŠ›" autocomplete="username">
          </div>
          <div class="form-group">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="login-pw" class="input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password">
          </div>
          <div id="login-error" class="text-red text-sm mb-1" style="display:none"></div>
          <button id="login-btn" class="btn btn--primary btn--full" onclick="App.doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
      </div>`;
    // Enterã‚­ãƒ¼å¯¾å¿œ
    const pw = $('#login-pw');
    if (pw) pw.addEventListener('keydown', e => { if (e.key === 'Enter') App.doLogin(); });
    const id = $('#login-id');
    if (id) { id.addEventListener('keydown', e => { if (e.key === 'Enter') pw.focus(); }); id.focus(); }
  },

  async doLogin() {
    const loginId = $('#login-id')?.value?.trim();
    const password = $('#login-pw')?.value?.trim();
    const errEl = $('#login-error');
    const btn = $('#login-btn');
    if (!loginId || !password) { errEl.textContent = 'IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; errEl.style.display = 'block'; return; }

    btn.disabled = true; btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
    const res = await API.login(loginId, password);
    btn.disabled = false; btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';

    if (res?.success) {
      Auth.setSession(res.token, res.user);
      API.clearCache();
      this.renderApp();
    } else {
      errEl.textContent = res?.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
      errEl.style.display = 'block';
    }
  },

  doLogout() {
    UI.confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ', async () => {
      await API.logout();
      Auth.clear();
      API.clearCache();
      this.showLogin();
    });
  },

  // â”€â”€ ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€
  renderApp() {
    const role = Auth.getRole();
    const user = Auth.currentUser;

    $('#app').innerHTML = `
      <div class="app-layout">
        <header class="app-header">
          <div class="app-header__left">
            <div class="app-header__title">å‡ºè³‡ç®¡ç†</div>
            <span class="app-header__user">${user.name}${user.group_name ? ' / ' + user.group_name : ''}</span>
          </div>
          <button class="app-header__logout" onclick="App.doLogout()" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">â»</button>
        </header>
        <nav class="app-nav" id="app-nav"></nav>
        <main class="app-main" id="app-main">
          <div id="global-loading" class="global-loading" style="display:none">
            <div class="spinner"></div>
          </div>
          <div id="page-content"></div>
        </main>
      </div>`;

    this._renderNav(role);
    this._navigateDefault(role);
  },

  _renderNav(role) {
    const tabs = {
      user:   [{ id: 'top', icon: 'ğŸ ', label: 'TOP' }, { id: 'status', icon: 'ğŸ“Š', label: 'å•†å“çŠ¶æ³' }, { id: 'mypage', icon: 'ğŸ‘¤', label: 'ãƒã‚¤ãƒšãƒ¼ã‚¸' }],
      admin:  [{ id: 'dashboard', icon: 'ğŸ“Š', label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰' }, { id: 'order', icon: 'ğŸ“‹', label: 'æ³¨æ–‡ç®¡ç†' }, { id: 'product', icon: 'ğŸ“¦', label: 'å•†å“' }, { id: 'return', icon: 'â†©ï¸', label: 'ãŠæˆ»ã—' }, { id: 'users', icon: 'ğŸ‘¥', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' }],
      leader: [{ id: 'price', icon: 'ğŸ’°', label: 'ä¾¡æ ¼è¨­å®š' }, { id: 'status', icon: 'ğŸ“Š', label: 'å•†å“çŠ¶æ³' }, { id: 'order', icon: 'ğŸ“‹', label: 'æ³¨æ–‡ç¢ºèª' }, { id: 'return', icon: 'â†©ï¸', label: 'ãŠæˆ»ã—' }],
    };
    const items = tabs[role] || tabs.user;
    $('#app-nav').innerHTML = items.map(t =>
      `<button class="nav-tab" data-page="${t.id}" onclick="App.navigate('${t.id}')">
        <span class="nav-tab__icon">${t.icon}</span>
        <span class="nav-tab__label">${t.label}</span>
      </button>`
    ).join('');
  },

  _navigateDefault(role) {
    const defaults = { user: 'top', admin: 'dashboard', leader: 'price' };
    this.navigate(defaults[role] || 'top');
  },

  navigate(pageId) {
    this.currentPage = pageId;

    // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
    $$('.nav-tab').forEach(t => t.classList.toggle('nav-tab--active', t.dataset.page === pageId));

    // ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    this.renderPage();
  },

  async renderPage(opts = {}) {
    const role = Auth.getRole();
    const pageId = this.currentPage;
    const container = $('#page-content');
    if (!container) return;

    // soft: ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹å¤‰æ›´ã®ã¿ï¼ˆã‚¹ã‚±ãƒ«ãƒˆãƒ³éè¡¨ç¤ºï¼‰
    if (!opts.soft) container.innerHTML = UI.skeleton(5);

    try {
      let html = '';
      // ãƒ­ãƒ¼ãƒ«+ãƒšãƒ¼ã‚¸ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
      if (role === 'user') {
        switch (pageId) {
          case 'top':    html = await UserPages.renderTop(); break;
          case 'detail': html = await UserPages.renderDetail(); break;
          case 'purchase': html = await UserPages.renderPurchase(); break;
          case 'return': html = await UserPages.renderReturn(); break;
          case 'status': html = await UserPages.renderStatus(); break;
          case 'mypage': html = await UserPages.renderMyPage(); break;
          default: html = UI.empty('ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      } else if (role === 'admin') {
        switch (pageId) {
          case 'dashboard': html = await AdminPages.renderDashboard(); break;
          case 'order':     html = await AdminPages.renderOrders(); break;
          case 'order-detail': html = await AdminPages.renderOrderDetail(); break;
          case 'product':   html = await AdminPages.renderProducts(); break;
          case 'product-edit': html = await AdminPages.renderProductEdit(); break;
          case 'return':    html = await AdminPages.renderReturns(); break;
          case 'users':     html = await AdminPages.renderUsers(); break;
          case 'user-edit': html = await AdminPages.renderUserEdit(); break;
          default: html = UI.empty('ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      } else if (role === 'leader') {
        switch (pageId) {
          case 'price':  html = await LeaderPages.renderPricing(); break;
          case 'status': html = await LeaderPages.renderStatus(); break;
          case 'order':  html = await LeaderPages.renderOrders(); break;
          case 'return': html = await LeaderPages.renderReturns(); break;
          default: html = UI.empty('ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      }
      container.innerHTML = `<div class="page-content">${html}</div>`;
    } catch (err) {
      console.error('Render error:', err);
      container.innerHTML = `<div class="page-content">${UI.card(`<div class="text-red">ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div><p class="text-sm text-gray mt-1">${err.message}</p><button class="btn btn--primary btn--sm mt-1" onclick="App.renderPage()">å†è©¦è¡Œ</button>`)}</div>`;
    }
  },
};

// â”€â”€ èµ·å‹• â”€â”€
document.addEventListener('DOMContentLoaded', () => App.init());
</script></body></html>
